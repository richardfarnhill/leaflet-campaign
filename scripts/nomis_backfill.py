"""
NOMIS backfill: Fetch owner_occupied_pct from TS054 Tenure dataset for all OA21 codes.
Outputs a JSON file with {oa21_code: pct} for use by the SQL update step.
"""
import requests
import json
import warnings
import time
warnings.filterwarnings("ignore")

BASE = "https://www.nomisweb.co.uk/api/v01"
BATCH = 50
OUTPUT = "/tmp/oa_pct.json"

OA_CODES = [
    "E00025680","E00025691","E00025692","E00025693","E00025695","E00025697",
    "E00025699","E00025700","E00025701","E00025703","E00025704","E00025705",
    "E00025706","E00025707","E00025708","E00025709","E00025711","E00025712",
    "E00025715","E00025716","E00025717","E00025718","E00025719","E00025720",
    "E00025907","E00025919","E00025921","E00025922","E00025926","E00025927",
    "E00025928","E00026169","E00026170","E00026171","E00026172","E00026174",
    "E00026175","E00026176","E00026177","E00026178","E00026179","E00026180",
    "E00026181","E00026182","E00026183","E00026184","E00026185","E00026186",
    "E00026187","E00026188","E00026189","E00026190","E00026191","E00026192",
    "E00026193","E00026194","E00026195","E00026196","E00026197","E00026198",
    "E00026199","E00026200","E00026201","E00026203","E00026204","E00026207",
    "E00026208","E00026209","E00026720","E00026721","E00026723","E00026886",
    "E00026888","E00026889","E00026890","E00026891","E00029235","E00029281",
    "E00029313","E00029314","E00029315","E00029316","E00029317","E00029318",
    "E00029321","E00029322","E00029323","E00029324","E00029327","E00029328",
    "E00029329","E00029330","E00029331","E00029332","E00029333","E00029334",
    "E00029339","E00029340","E00029342","E00029345","E00029349","E00029351",
    "E00029354","E00029355","E00029357","E00030000","E00030001","E00030005",
    "E00030006","E00030007","E00030008","E00030009","E00030011","E00030022",
    "E00030027","E00030029","E00030030","E00030032","E00030033","E00030034",
    "E00030035","E00030036","E00030037","E00030038","E00030039","E00030040",
    "E00030041","E00030042","E00030043","E00030044","E00030045","E00058043",
    "E00058044","E00058048","E00058051","E00058052","E00058053","E00058054",
    "E00058055","E00058058","E00058060","E00058082","E00058088","E00058104",
    "E00058115","E00058121","E00058125","E00058182","E00058188","E00058194",
    "E00058200","E00058202","E00058206","E00058207","E00058209","E00058212",
    "E00058221","E00058223","E00059170","E00063111","E00063118","E00063122",
    "E00063123","E00063126","E00063127","E00063128","E00063129","E00063130",
    "E00063131","E00063132","E00063133","E00063134","E00063135","E00063136",
    "E00063137","E00063138","E00063139","E00063140","E00063141","E00063142",
    "E00093761","E00093765","E00093766","E00093767","E00093768","E00093769",
    "E00093770","E00093771","E00093772","E00093773","E00093774","E00093775",
    "E00093776","E00093778","E00093779","E00093780","E00093781","E00093782",
    "E00093804","E00093806","E00093823","E00093824","E00093825","E00093826",
    "E00093827","E00093828","E00093829","E00093830","E00093831","E00093832",
    "E00093834","E00093835","E00093836","E00093837","E00093838","E00093839",
    "E00093840","E00093841","E00093842","E00093843","E00093844","E00093845",
    "E00093846","E00093847","E00093848","E00093849","E00093850","E00093851",
    "E00093852","E00093867","E00093870","E00093871","E00093872","E00093873",
    "E00093874","E00093875","E00093876","E00093877","E00093879","E00093880",
    "E00093881","E00093882","E00093884","E00093886","E00093914","E00093920",
    "E00093934","E00093942","E00094116","E00094117","E00094125","E00094126",
    "E00094127","E00094128","E00094129","E00094130","E00094131","E00094132",
    "E00094133","E00094134","E00094135","E00094136","E00094139","E00094141",
    "E00094142","E00094143","E00094144","E00094145","E00094146","E00094147",
    "E00094148","E00094149","E00094151","E00094158","E00094159","E00094160",
    "E00094161","E00094162","E00094163","E00094164","E00094165","E00094166",
    "E00094167","E00094168","E00094169","E00094170","E00094171","E00094172",
    "E00094173","E00094174","E00094175","E00094176","E00094177","E00094178",
    "E00094179","E00094180","E00094181","E00094182","E00094183","E00094184",
    "E00094185","E00094186","E00094187","E00094188","E00094189","E00094190",
    "E00094191","E00094192","E00094193","E00094194","E00094195","E00094196",
    "E00094197","E00094198","E00094199","E00094200","E00094201","E00094202",
    "E00094203","E00094204","E00094205","E00094210","E00094227","E00165680",
    "E00168591","E00170436","E00170598","E00174341","E00174342","E00174371",
    "E00174403","E00175884","E00175888","E00175889","E00176088","E00177714",
    "E00177716","E00177738","E00177739","E00177747","E00180886","E00180901",
    "E00184563","E00184638","E00187102","E00187116","E00187148","E00188777",
    "E00188790",
]

print(f"Total OA codes: {len(OA_CODES)}")

# NOMIS accepts OA21 codes directly in the data endpoint â€” no NomisKey lookup needed.
# Fetch ownership % (c2021_tenure_9=1001 = "Owned") in batches of 50
oa_to_pct = {}

for i in range(0, len(OA_CODES), BATCH):
    batch = OA_CODES[i:i+BATCH]
    geo_str = ",".join(batch)
    url = (f"{BASE}/dataset/NM_2072_1.data.json"
           f"?geography={geo_str}&c2021_tenure_9=1001&measures=20301"
           f"&select=geography_code,obs_value")
    r = requests.get(url, verify=False, timeout=30)
    r.raise_for_status()
    data = r.json()
    obs = data["obs"]
    for o in obs:
        geo_code = o["geography"]["geogcode"]
        pct = float(o["obs_value"]["value"])
        oa_to_pct[geo_code] = pct
    print(f"  Batch {i//BATCH+1}/{(len(OA_CODES)+BATCH-1)//BATCH}: {len(obs)} rows (running total: {len(oa_to_pct)})")
    time.sleep(0.3)

print(f"Ownership percentages fetched: {len(oa_to_pct)}")
missing_pct = set(OA_CODES) - set(oa_to_pct.keys())
if missing_pct:
    print(f"WARNING: {len(missing_pct)} OA codes missing ownership data: {missing_pct}")

with open(OUTPUT, "w") as f:
    json.dump(oa_to_pct, f, indent=2)
print(f"Saved to {OUTPUT}")
print("Sample:", list(oa_to_pct.items())[:5])