---
phase: 04-analytics-heatmaps
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [index.html]
autonomous: false
must_haves:
  truths:
    - "Map view shows completed areas as colored markers/layers"
    - "Heatmap layer displays delivery density"
    - "Analytics dashboard renders with at least one chart"
    - "Completion rate shown on area cards or dashboard"
  artifacts:
    - path: "index.html"
      provides: "Map view, heatmap layer, analytics dashboard section"
      contains: "loadAnalyticsDashboard"
  key_links:
    - from: "deliveries table"
      to: "heatmap"
      via: "aggregate by target_area_id"
      pattern: "deliveries"
---

<objective>
Add map view with heatmap overlay and analytics dashboard to visualize delivery coverage and enquiry locations.

Purpose: Phase 4 core — make delivery data visible and actionable through visualization.
Output: Updated index.html with map/heatmap section and analytics dashboard.
</objective>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-analytics-heatmaps/CONTEXT.md

Key facts:
- Single-file app: index.html. No build step. Leaflet.js already loaded.
- deliveries table: target_area_id, leaflets_delivered, delivery_date
- target_areas table: area_name, postcode, lat, lng, house_count
- enquiries table: postcode, location (JSON with lat/lng), created_at
- Leaflet map already exists in app (used for area selection)
- Need to add: heatmap layer, analytics charts, completion rate display
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add heatmap library to index.html</name>
  <files>index.html</files>
  <action>
    Add Leaflet.heat heatmap library to the head section. Use CDN:
    https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js
    
    Add AFTER the Leaflet CSS/JS includes.
  </action>
  <verify>Heatmap library loads without errors</verify>
  <done>Leaflet.heat script tag present in HTML head</done>
</task>

<task type="auto">
  <name>Task 2: Create analytics dashboard section</name>
  <files>index.html</files>
  <action>
    Add a new section below the area cards grid. Use a tab or toggle to switch between:
    - "Cards" view (current)
    - "Map" view (heatmap + markers)
    - "Analytics" view (charts)
    
    Create the HTML structure:
    ```html
    <!-- Analytics Toggle -->
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <button onclick="showView('cards')" class="area-card-btn" id="viewBtnCards">Cards</button>
      <button onclick="showView('map')" class="area-card-btn" id="viewBtnMap">Map</button>
      <button onclick="showView('analytics')" class="area-card-btn" id="viewBtnAnalytics">Analytics</button>
    </div>
    
    <!-- Analytics View (hidden by default) -->
    <div id="analyticsView" style="display:none;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
        <div style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
          <h3 style="margin:0 0 12px 0;font-size:1rem;">Deliveries Over Time</h3>
          <canvas id="chartDeliveries"></canvas>
        </div>
        <div style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
          <h3 style="margin:0 0 12px 0;font-size:1rem;">Revenue Over Time</h3>
          <canvas id="chartRevenue"></canvas>
        </div>
      </div>
      <div style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <h3 style="margin:0 0 12px 0;font-size:1rem;">Enquiries by Day</h3>
        <canvas id="chartEnquiries"></canvas>
      </div>
    </div>
    ```
    
    Add showView() function to toggle between views.
  </action>
  <verify>Clicking Analytics button shows the dashboard section</verify>
  <done>Analytics dashboard section renders with three chart placeholders</done>
</task>

<task type="auto">
  <name>Task 3: Create map view with heatmap</name>
  <files>index.html</files>
  <action>
    Add map view section (hidden by default):
    ```html
    <div id="mapView" style="display:none;height:500px;border-radius:8px;overflow:hidden;">
      <div id="heatmapContainer" style="height:100%;"></div>
    </div>
    ```
    
    Create function loadHeatmap():
    ```javascript
    async function loadHeatmap() {
      const container = document.getElementById('heatmapContainer');
      if (!container._leaflet_id) {
        const map = L.map('heatmapContainer').setView([53.38, -2.32], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap'
        }).addTo(map);
        window.analyticsMap = map;
      }
      
      // Fetch completed areas with delivery data
      const areas = await sbFetch('/rest/v1/target_areas?select=*&status=eq.completed');
      const deliveries = await sbFetch('/rest/v1/deliveries?select=*');
      
      // Build heat data: [lat, lng, intensity]
      const heatData = areas.map(a => {
        const areaDelivery = deliveries.find(d => d.target_area_id === a.id);
        const count = areaDelivery?.leaflets_delivered || 0;
        return [a.lat, a.lng, count / 1000]; // normalize intensity
      }).filter(p => p[0] && p[1]);
      
      if (window.heatLayer) window.heatLayer.remove();
      window.heatLayer = L.heatLayer(heatData, {radius: 25, blur: 15}).addTo(window.analyticsMap);
    }
    ```
  </action>
  <verify>Map view shows heatmap overlay on load</verify>
  <done>Heatmap displays delivery density on Leaflet map</done>
</task>

<task type="auto">
  <name>Task 4: Add completion rate to cards and dashboard</name>
  <files>index.html</files>
  <action>
    1. Update area card rendering to show completion percentage:
       - Fetch deliveries count per area
       - Display as percentage on reserved/completed cards
    
    2. Add overall completion rate to analytics view:
       ```javascript
       async function loadCompletionRate() {
         const areas = await sbFetch('/rest/v1/target_areas?select=id,status,house_count');
         const completed = areas.filter(a => a.status === 'completed').length;
         const total = areas.length;
         const rate = total > 0 ? Math.round(completed / total * 100) : 0;
         document.getElementById('overallCompletionRate').textContent = rate + '%';
       }
       ```
  </action>
  <verify>Area cards show percentage, analytics shows overall rate</verify>
  <done>Completion rate visible on cards and in dashboard</done>
</task>

<task type="auto">
  <name>Task 5: Add enquiry markers to map</name>
  <files>index.html</files>
  <action>
    Update loadHeatmap() to also fetch enquiries and add as markers:
    ```javascript
    // Fetch enquiries with location
    const enquiries = await sbFetch('/rest/v1/enquiries?select=*&location=not.is.null');
    const enquiryMarkers = (enquiries || []).map(e => {
      if (!e.location?.lat || !e.location?.lng) return null;
      return L.marker([e.location.lat, e.location.lng])
        .bindPopup(`Enquiry: ${e.postcode || 'No postcode'}`);
    }).filter(m => m);
    
    enquiryMarkers.forEach(m => m.addTo(window.analyticsMap));
    ```
  </action>
  <verify>Enquiries appear as markers on the map</verify>
  <done>Enquiry locations displayed on map alongside heatmap</done>
</task>

<task type="auto">
  <name>Task 6: Add analytics charts</name>
  <files>index.html</files>
  <action>
    Use Chart.js for analytics. Add to head:
    ```html
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    ```
    
    Create function loadAnalyticsCharts():
    ```javascript
    async function loadAnalyticsCharts() {
      const deliveries = await sbFetch('/rest/v1/deliveries?select=*&order=delivery_date.asc');
      const enquiries = await sbFetch('/rest/v1/enquiries?select=*&order=created_at.asc');
      
      // Group by date
      const deliveryByDate = {};
      deliveries.forEach(d => {
        const date = d.delivery_date;
        deliveryByDate[date] = (deliveryByDate[date] || 0) + (d.leaflets_delivered || 0);
      });
      
      // Deliveries chart
      new Chart(document.getElementById('chartDeliveries'), {
        type: 'line',
        data: {
          labels: Object.keys(deliveryByDate),
          datasets: [{ label: 'Leaflets', data: Object.values(deliveryByDate), borderColor: '#2563eb', fill: false }]
        }
      });
      
      // Revenue from enquiries
      const revenueByDate = {};
      enquiries.forEach(e => {
        const date = e.created_at?.slice(0, 10);
        if (e.instruction_value) {
          revenueByDate[date] = (revenueByDate[date] || 0) + e.instruction_value;
        }
      });
      
      new Chart(document.getElementById('chartRevenue'), {
        type: 'line',
        data: {
          labels: Object.keys(revenueByDate),
          datasets: [{ label: 'Revenue', data: Object.values(revenueByDate), borderColor: '#16a34a', fill: false }]
        }
      });
    }
    ```
  </action>
  <verify>Charts render with delivery and revenue data</verify>
  <done>Analytics dashboard shows at least delivery and revenue charts</done>
</task>

</tasks>

<verification>
- [ ] Map view accessible via toggle button
- [ ] Heatmap displays completed areas with color intensity
- [ ] Enquiry markers appear on map
- [ ] Analytics dashboard shows 3 charts (deliveries, revenue, enquiries)
- [ ] Completion rate shown on cards or dashboard
- [ ] No JS errors in console
</verification>

<success_criteria>
- Map view with heatmap working
- Enquiries displayed on map
- Analytics dashboard with charts
- Completion rate visible
- All verification checks pass
</success_criteria>

<output>
After completion, create .planning/phases/04-analytics-heatmaps/04-01-SUMMARY.md
</output>
