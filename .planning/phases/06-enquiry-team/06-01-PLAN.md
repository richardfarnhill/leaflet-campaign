---
phase: 06-enquiry-team
plan: 01
type: execute
wave: 1
depends_on: [04, 05]
files_modified: [index.html]
autonomous: false
must_haves:
  truths:
    - "Enquiries are recorded with campaign_id and geocoded location"
    - "Enquiry locations appear as markers on the map"
    - "Finance projections pull enquiry/case counts from DB, not manual input"
    - "Team members can be ranked by leaflets delivered"
    - "Routes can be created and deleted from the UI"
---

<objective>
Add enquiry recording, enquiry map overlay, team progress, leaderboards, and route management.

Purpose: Phase 6 core ‚Äî track enquiries from delivery and team performance.
Output: Updated index.html with enquiry/team/route features.
</objective>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-enquiry-team/CONTEXT.md

Key facts:
- Single-file app: index.html. No build step.
- enquiries table columns to confirm/create: id, campaign_id, client_name, postcode, lat, lng, instructed (boolean), instruction_value (numeric), notes, created_at
  NOTE: CONTEXT.md says "location (PostGIS)" but Supabase REST cannot return PostGIS as {lat,lng}.
  Use separate lat/lng numeric columns instead. Run migration if needed.
- deliveries table has: id, campaign_id, target_area_id, leaflets_delivered, team_member_1_id, team_member_2_id, delivery_date, notes
- Finance section currently uses manual fi_enquiries/fi_cases/fi_instrvalue inputs ‚Äî these should be replaced by DB-driven totals once enquiries are in the DB.
- Map enquiry markers currently check e.location?.lat which will always be null (PostGIS). Fix to use e.lat/e.lng.
</context>

<tasks>

<task type="auto">
  <name>Task 0: DB migration ‚Äî enquiries table</name>
  <files>Supabase SQL editor</files>
  <action>
    Run in Supabase SQL editor to ensure enquiries table has correct columns:
    ```sql
    CREATE TABLE IF NOT EXISTS enquiries (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      campaign_id UUID REFERENCES campaigns(id) ON DELETE CASCADE,
      client_name TEXT,
      postcode TEXT,
      lat NUMERIC,
      lng NUMERIC,
      instructed BOOLEAN DEFAULT false,
      instruction_value NUMERIC,
      notes TEXT,
      created_at TIMESTAMPTZ DEFAULT NOW()
    );

    ALTER TABLE enquiries ENABLE ROW LEVEL SECURITY;
    CREATE POLICY "Anyone can read enquiries" ON enquiries FOR SELECT USING (true);
    CREATE POLICY "Anyone can insert enquiries" ON enquiries FOR INSERT WITH CHECK (true);
    CREATE POLICY "Anyone can update enquiries" ON enquiries FOR UPDATE USING (true);
    CREATE POLICY "Anyone can delete enquiries" ON enquiries FOR DELETE USING (true);
    ```

    If table already exists, add missing columns:
    ```sql
    ALTER TABLE enquiries ADD COLUMN IF NOT EXISTS lat NUMERIC;
    ALTER TABLE enquiries ADD COLUMN IF NOT EXISTS lng NUMERIC;
    ALTER TABLE enquiries ADD COLUMN IF NOT EXISTS notes TEXT;
    ```
  </action>
  <verify>enquiries table exists with lat/lng columns</verify>
  <done>DB ready for enquiry recording</done>
</task>

<task type="auto">
  <name>Task 1: Enquiry recording modal</name>
  <files>index.html</files>
  <action>
    Add "Record Enquiry" button in the analytics/finance area (visible when campaign selected).

    Modal fields:
    - Client Name (text, optional)
    - Postcode (text, required) ‚Äî geocoded via postcodes.io on save to set lat/lng
    - Route (select, optional) ‚Äî dropdown of current campaign's target_areas
    - Instructed? (checkbox/toggle)
    - Instruction Value (¬£ number, shown when instructed=true)
    - Notes (textarea, optional)

    On save:
    - Geocode postcode via postcodes.io ‚Üí set lat, lng
    - POST to enquiries with campaign_id=currentCampaignId
    - Reload enquiry list + map markers
    - Update finance projections from DB

    Functions: openEnquiryModal(), closeEnquiryModal(), saveEnquiry()
  </action>
  <verify>Can record enquiry; it appears in list and on map</verify>
  <done>Enquiry modal saves to DB with geocoded location</done>
</task>

<task type="auto">
  <name>Task 2: Enquiry list view</name>
  <files>index.html</files>
  <action>
    Add Enquiries tab/section in the analytics view (or as a new view toggle).

    Table columns: Date | Client | Postcode | Route | Instructed | Value | Notes | Actions
    - Sort by created_at descending
    - Filtered by currentCampaignId (already done in loadHeatmap fetch)
    - "Edit" button ‚Üí opens pre-filled enquiry modal for update (PATCH)
    - "Delete" button ‚Üí confirm then DELETE from enquiries

    Function: loadEnquiryList()
    Called from: loadAnalyticsDashboard() and after save/delete
  </action>
  <verify>Enquiries list shows correct records; edit and delete work</verify>
  <done>Enquiry list renders with edit/delete</done>
</task>

<task type="auto">
  <name>Task 3: Enquiry map markers</name>
  <files>index.html</files>
  <action>
    Fix existing enquiry marker code in loadHeatmap() ‚Äî currently checks e.location?.lat (PostGIS, always null).
    Change to use e.lat / e.lng (new columns).

    For each enquiry with lat/lng:
    - Instructed=true: purple filled circle marker
    - Instructed=false: light purple/lilac outline marker
    - Popup: client name (or "Anonymous"), postcode, instructed status, value if instructed

    Update map legend to include:
    - ‚óè Instructed enquiry (purple)
    - ‚óã Enquiry (lilac)

    Function: already within loadHeatmap() ‚Äî just fix the coordinate reference and add styling.
  </action>
  <verify>Map shows purple markers at enquiry locations; popup shows details</verify>
  <done>Enquiry markers rendering correctly on map</done>
</task>

<task type="auto">
  <name>Task 4: Finance projections driven by DB enquiries</name>
  <files>index.html</files>
  <action>
    Currently the finance section has manual inputs (fi_enquiries, fi_cases, fi_instrvalue) that
    users type numbers into. These should now be DB-driven from the enquiries table, while
    keeping the manual override as a fallback.

    Update loadFinanceFromDB() (or create it):
    - Fetch enquiries for currentCampaignId
    - Count total enquiries ‚Üí populate fi_enquiries input (or a display element)
    - Count instructed=true ‚Üí populate fi_cases
    - Sum instruction_value WHERE instructed=true ‚Üí populate fi_instrvalue
    - Trigger updateFinance() with these values

    The manual inputs should remain editable for overrides (e.g. enquiries received by phone
    not yet in the system), but pre-populated from DB.

    Call loadFinanceFromDB() from loadAll() and after saving an enquiry.
  </action>
  <verify>Finance projections update automatically when enquiries are recorded</verify>
  <done>Finance section DB-driven, manual override still possible</done>
</task>

<task type="auto">
  <name>Task 5: Team progress view (TEA-01)</name>
  <files>index.html</files>
  <action>
    Add team progress panel in analytics view showing per-member stats for currentCampaignId:

    For each team member:
    - Routes reserved (count from reservations WHERE team_member_1_id OR team_member_2_id)
    - Routes completed (count from target_areas WHERE status='completed', joined via reservations)
    - Leaflets delivered (sum from deliveries WHERE team_member_1_id OR team_member_2_id)
    - Progress bar: delivered / team target (if definable) or vs campaign total

    Display as cards or a table. Filter by currentCampaignId throughout.

    Function: loadTeamProgress()
    Called from: loadAnalyticsDashboard()
  </action>
  <verify>Team progress shows correct per-member stats for the selected campaign</verify>
  <done>Team progress view works</done>
</task>

<task type="auto">
  <name>Task 6: Leaderboards (TEA-02)</name>
  <files>index.html</files>
  <action>
    Add leaderboard below team progress showing top 5 by leaflets delivered for currentCampaignId.

    Aggregate deliveries:
    - For each delivery row, credit leaflets_delivered to team_member_1_id AND team_member_2_id
    - Group by team member ‚Üí sort descending
    - Display: rank medal (ü•áü•àü•â), name, total leaflets

    Function: loadLeaderboard()
    Called from: loadAnalyticsDashboard()
  </action>
  <verify>Leaderboard ranks team members correctly; updates on campaign switch</verify>
  <done>Leaderboard renders</done>
</task>

<task type="auto">
  <name>Task 7: Route creation UI</name>
  <files>index.html</files>
  <action>
    Add "Add Route" button to the routes/cards view header (only visible when a specific campaign is selected, not All Campaigns).

    Modal fields:
    - Route Name (text, required)
    - Postcode (text, required) ‚Äî geocoded via postcodes.io on save to set lat/lng
    - House Count (number, required)
    - Notes (textarea, optional)

    On save:
    - Geocode postcode ‚Üí set lat/lng
    - POST to target_areas with campaign_id=currentCampaignId, status='available'
    - Reload area cards

    Functions: openAddRouteModal(), closeAddRouteModal(), saveNewRoute()
  </action>
  <verify>Can add a new route; it appears in cards grid and on map</verify>
  <done>Route creation UI working</done>
</task>

<task type="auto">
  <name>Task 8: Route deletion UI</name>
  <files>index.html</files>
  <action>
    Add delete option to route cards (admin action ‚Äî only for available/unstarted routes).

    - Add small "Delete" or trash icon to each route card
    - Only enabled when status='available' (can't delete reserved/completed routes)
    - Confirm dialog: "Delete route [name]? This cannot be undone."
    - On confirm: DELETE from target_areas WHERE id=routeId
    - Reload area cards

    Function: deleteRoute(id)
  </action>
  <verify>Can delete an available route; reserved/completed routes show disabled delete</verify>
  <done>Route deletion works with guard for active routes</done>
</task>

</tasks>

<verification>
- [ ] enquiries table has lat/lng columns (T0 DB migration)
- [ ] Enquiry modal records to DB with geocoded location (T1)
- [ ] Enquiry list shows correct records with edit/delete (T2)
- [ ] Map shows purple markers at enquiry lat/lng (T3)
- [ ] Finance projections pre-populated from DB enquiries (T4)
- [ ] Team progress shows per-member stats for selected campaign (T5)
- [ ] Leaderboard ranks correctly (T6)
- [ ] Can create a route from UI (T7)
- [ ] Can delete an available route (T8)
</verification>

<success_criteria>
- Enquiries recorded, geocoded, and visible on map
- Finance projections auto-update from recorded enquiries
- Team progress and leaderboard functional per campaign
- Routes manageable entirely from UI (no SQL editor needed)
</success_criteria>

<output>
After completion, create .planning/phases/06-enquiry-team/06-01-SUMMARY.md
</output>
