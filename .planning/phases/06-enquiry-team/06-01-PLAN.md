---
phase: 06-enquiry-team
plan: 01
type: execute
wave: 1
depends_on: [04, 05]
files_modified: [index.html]
autonomous: false
must_haves:
  truths:
    - "Each restricted postcode has its own configurable exclusion radius"
    - "Enquiries are recorded with campaign_id and geocoded location"
    - "Enquiry locations appear as markers on the map"
    - "Finance projections pull enquiry/case counts from DB, not manual input"
    - "Team members can be ranked by leaflets delivered"
    - "Routes can be created and deleted from the UI"
---

<objective>
Add per-postcode exclusion radius config, enquiry recording, map overlay, team progress, leaderboards, and route management.

Purpose: Phase 6 core — restricted area precision, enquiry tracking, team performance.
Output: Updated index.html with all features.
</objective>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-enquiry-team/CONTEXT.md

Key facts:
- Single-file app: index.html. No build step.
- Restricted postcodes are stored in campaigns.restricted_postcodes (text[]) and drawn as
  circles on the map using a hardcoded 2-mile radius. The radius needs to be per-postcode.
- The restricted_areas table (postcode_prefix, radius_miles, label) exists in the DB but is
  currently unused by the map — the map reads from campaigns.restricted_postcodes instead.
  Decision for T0.1: use the restricted_areas table as the source of truth for postcode+radius,
  and update the campaign config UI to manage that table (add/edit/delete rows).
- enquiries table columns to confirm/create: id, campaign_id, client_name, postcode, lat, lng,
  instructed (boolean), instruction_value (numeric), notes, created_at
  NOTE: CONTEXT.md says "location (PostGIS)" but Supabase REST cannot return PostGIS as {lat,lng}.
  Use separate lat/lng numeric columns instead. Run migration if needed.
- deliveries table: id, campaign_id, target_area_id, leaflets_delivered, team_member_1_id,
  team_member_2_id, delivery_date, notes
- Finance section currently uses manual fi_enquiries/fi_cases/fi_instrvalue inputs — replace
  with DB-driven totals from enquiries table once that is in use.
- Map enquiry markers currently check e.location?.lat — always null (PostGIS). Fix to e.lat/e.lng.
</context>

<tasks>

<task type="auto">
  <name>Task 0.1: Per-postcode exclusion radius UI</name>
  <files>index.html</files>
  <action>
    Currently the campaign config modal has a simple comma-separated "Restricted Postcodes"
    text field. This saves to campaigns.restricted_postcodes (text[]) and the map draws each
    as a fixed 2-mile radius circle. There is no way to set a different radius per postcode.

    The restricted_areas table already exists with columns: postcode_prefix, radius_miles, label.
    This task switches the map to use restricted_areas as the source of truth, and replaces the
    simple text input in the config modal with a proper management UI.

    **Replace the "Restricted Postcodes" text field in the campaign config modal with:**
    A table-style list of current restricted_areas rows:
    | Postcode | Radius (miles) | Label | Actions |
    - Each row: postcode prefix, radius input (number, step 0.1), label text, delete button
    - "Add" button at bottom: inputs for new postcode + radius + label → INSERT to restricted_areas

    On save of a row: PATCH restricted_areas WHERE id=rowId (radius_miles, label)
    On delete: DELETE restricted_areas WHERE id=rowId
    On add: INSERT restricted_areas (postcode_prefix, radius_miles, label)

    **Update loadHeatmap() to use restricted_areas table directly** (revert the change that
    switched it to campaigns.restricted_postcodes). Each restricted area already has its own
    radius_miles. Remove the hardcoded fallback of 2 miles — use the actual radius_miles value,
    defaulting to 1 mile if null/0.

    Functions: loadRestrictedAreasList(), saveRestrictedAreaRow(id), deleteRestrictedArea(id), addRestrictedArea()
  </action>
  <verify>
    Config modal shows list of restricted areas with editable radius per row.
    Adding WA14 with 1.5 mile radius and WA15 with 3 mile radius shows different circle sizes on map.
  </verify>
  <done>Per-postcode radius configurable; map circles reflect individual radii</done>
</task>

<task type="auto">
  <name>Task 1: DB migration — enquiries table</name>
  <files>Supabase SQL editor</files>
  <action>
    Run in Supabase SQL editor to ensure enquiries table has correct columns:
    ```sql
    CREATE TABLE IF NOT EXISTS enquiries (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      campaign_id UUID REFERENCES campaigns(id) ON DELETE CASCADE,
      client_name TEXT,
      postcode TEXT,
      lat NUMERIC,
      lng NUMERIC,
      instructed BOOLEAN DEFAULT false,
      instruction_value NUMERIC,
      notes TEXT,
      created_at TIMESTAMPTZ DEFAULT NOW()
    );

    ALTER TABLE enquiries ENABLE ROW LEVEL SECURITY;
    CREATE POLICY "Anyone can read enquiries" ON enquiries FOR SELECT USING (true);
    CREATE POLICY "Anyone can insert enquiries" ON enquiries FOR INSERT WITH CHECK (true);
    CREATE POLICY "Anyone can update enquiries" ON enquiries FOR UPDATE USING (true);
    CREATE POLICY "Anyone can delete enquiries" ON enquiries FOR DELETE USING (true);
    ```

    If table already exists, add missing columns:
    ```sql
    ALTER TABLE enquiries ADD COLUMN IF NOT EXISTS lat NUMERIC;
    ALTER TABLE enquiries ADD COLUMN IF NOT EXISTS lng NUMERIC;
    ALTER TABLE enquiries ADD COLUMN IF NOT EXISTS notes TEXT;
    ALTER TABLE enquiries ADD COLUMN IF NOT EXISTS target_area_id UUID REFERENCES target_areas(id) ON DELETE SET NULL;
    ```

    **Subtask T1a — Route unknown + target_area_id in modal (Claude, 2026-02-25):**
    - Enquiry modal route dropdown defaults to "Route unknown" (null) — no forced selection
    - target_area_id saved to DB and restored on edit
    - lat/lng geocoding re-enabled after migration confirmed columns exist
    - Links to requirement: auto-detect route from postcode (see todo: auto-detect-enquiry-route)
    - Links to gamification (T7): route → enquiry → instruction credit chain
  </action>
  <verify>enquiries table exists with lat/lng/target_area_id columns; enquiry saves geocoded location and route link</verify>
  <done>✅ DB migration applied 2026-02-25 by Claude via Supabase MCP. Columns confirmed: lat NUMERIC, lng NUMERIC, target_area_id UUID FK → target_areas. Geocoding and target_area_id saving enabled in saveEnquiry().</done>
</task>

<task type="auto">
  <name>Task 2: Enquiry recording modal</name>
  <files>index.html</files>
  <action>
    Add "Record Enquiry" button in the analytics/finance area (visible when campaign selected).

    Modal fields:
    - Client Name (text, optional)
    - Postcode (text, required) — geocoded via postcodes.io on save to set lat/lng
    - Route (select, optional) — dropdown of current campaign's target_areas
    - Instructed? (checkbox/toggle)
    - Instruction Value (£ number, shown when instructed=true)
    - Notes (textarea, optional)

    On save:
    - Geocode postcode via postcodes.io → set lat, lng
    - POST to enquiries with campaign_id=currentCampaignId
    - Reload enquiry list + map markers
    - Trigger finance projection refresh

    Functions: openEnquiryModal(), closeEnquiryModal(), saveEnquiry()
  </action>
  <verify>Can record enquiry; it appears in list and on map</verify>
  <done>Enquiry modal saves to DB with geocoded location</done>
</task>

<task type="auto">
  <name>Task 3: Enquiry list view + edit/delete</name>
  <files>index.html</files>
  <action>
    Add Enquiries tab/section in the analytics view.

    Table columns: Date | Client | Postcode | Route | Instructed | Value | Notes | Actions
    - Sort by created_at descending
    - Filtered by currentCampaignId
    - Edit button → opens pre-filled enquiry modal for PATCH
    - Delete button → confirm then DELETE

    Function: loadEnquiryList()
    Called from: loadAnalyticsDashboard() and after save/delete
  </action>
  <verify>Enquiries list shows correct records; edit and delete work</verify>
  <done>Enquiry list renders with edit/delete</done>
</task>

<task type="auto">
  <name>Task 4: Enquiry map markers</name>
  <files>index.html</files>
  <action>
    Fix existing enquiry marker code in loadHeatmap() — currently checks e.location?.lat (always null).
    Change to use e.lat / e.lng.

    For each enquiry with lat/lng:
    - instructed=true: purple filled circle marker
    - instructed=false: light purple/lilac outline marker
    - Popup: client name (or "Anonymous"), postcode, instructed status, value if instructed

    Update map legend:
    - ● Instructed enquiry (purple)
    - ○ Enquiry (lilac)
  </action>
  <verify>Map shows purple markers at enquiry locations; popup shows details</verify>
  <done>Enquiry markers rendering correctly on map</done>
</task>

<task type="auto">
  <name>Task 5: Finance projections driven by DB enquiries</name>
  <files>index.html</files>
  <action>
    Finance section currently uses manual inputs (fi_enquiries, fi_cases, fi_instrvalue).
    Pre-populate these from the enquiries table for currentCampaignId.

    Create/update loadFinanceFromDB():
    - Fetch enquiries for currentCampaignId
    - Count total → populate fi_enquiries input
    - Count instructed=true → populate fi_cases
    - Sum instruction_value WHERE instructed=true → populate fi_instrvalue
    - Call updateFinance() to recalculate projections

    Manual inputs remain editable for overrides (phone enquiries not yet in system).
    Call loadFinanceFromDB() from loadAll() and after saving/deleting an enquiry.
  </action>
  <verify>Finance projections update automatically when enquiries are recorded</verify>
  <done>Finance section DB-driven; manual override still possible</done>
</task>

<task type="auto">
  <name>Task 5a: Remove finance_actuals table dependency and dead code</name>
  <files>index.html</files>
  <action>
    The old finance section had three manual inputs (fi_enquiries, fi_cases, fi_instrvalue) that
    wrote to a finance_actuals DB table. T5 replaced these with DB-driven actuals from the
    enquiries table and 4 metric cards. The manual inputs and finance_actuals write path are now
    dead code.

    Remove:
    - financeTimer, scheduleFinanceSave(), saveFinance() — entire functions
    - finance_actuals table write (sbFetch POST to /rest/v1/finance_actuals)
    - .finance-inputs CSS class (inputs removed from DOM in T5)
    - Any lingering references to fi_enquiries, fi_cases, fi_instrvalue element IDs

    The finance_actuals Supabase table can be dropped via SQL editor:
    DROP TABLE IF EXISTS finance_actuals CASCADE;
    (Optional cleanup — app no longer reads or writes it)
  </action>
  <verify>No references to finance_actuals or fi_enquiries/fi_cases/fi_instrvalue in codebase</verify>
  <done>✅ Dead code removed 2026-02-25 by Claude. finance_actuals write path, scheduleFinanceSave, saveFinance, and .finance-inputs CSS deleted. finance_actuals table drop noted for SQL editor.</done>
</task>

<task type="auto">
  <name>Task 6: Team progress view (TEA-01)</name>
  <files>index.html</files>
  <action>
    Add team progress panel in analytics view for currentCampaignId.

    Per team member:
    - Routes reserved (reservations WHERE team_member_1_id OR team_member_2_id)
    - Routes completed (target_areas status='completed' via reservations)
    - Leaflets delivered (SUM from deliveries WHERE team_member_1_id OR team_member_2_id)
    - Progress bar vs campaign total delivered

    Display as cards or table. Filter by currentCampaignId throughout.
    Function: loadTeamProgress()
    Called from: loadAnalyticsDashboard()
  </action>
  <verify>Team progress shows correct per-member stats for selected campaign</verify>
  <done>Team progress view works</done>
</task>

<task type="auto">
  <name>Task 7: Leaderboards (TEA-02)</name>
  <files>index.html</files>
  <action>
    Add leaderboard showing top 5 by leaflets delivered for currentCampaignId.

    - Credit leaflets_delivered to both team_member_1_id AND team_member_2_id per delivery row
    - Group by team member → sort descending
    - Display: rank medal (1st/2nd/3rd), name, total leaflets

    Function: loadLeaderboard()
    Called from: loadAnalyticsDashboard()
  </action>
  <verify>Leaderboard ranks team members correctly; updates on campaign switch</verify>
  <done>Leaderboard renders</done>
</task>

<task type="auto">
  <name>Task 8: Route creation UI</name>
  <files>index.html</files>
  <action>
    Add "Add Route" button to the routes/cards view header (only when a specific campaign is
    selected, not All Campaigns).

    Modal fields:
    - Route Name (text, required)
    - Postcode (text, required) — geocoded via postcodes.io on save
    - House Count (number, required)
    - Notes (textarea, optional)

    On save:
    - Geocode postcode → lat/lng
    - POST to target_areas with campaign_id=currentCampaignId, status='available'
    - Reload area cards

    Functions: openAddRouteModal(), closeAddRouteModal(), saveNewRoute()
  </action>
  <verify>Can add a new route; it appears in cards grid and on map</verify>
  <done>Route creation UI working</done>
</task>

<task type="auto">
  <name>Task 9: Route deletion UI</name>
  <files>index.html</files>
  <action>
    Add delete option to route cards (admin only — available routes only).

    - Trash icon on each route card
    - Only enabled when status='available' (reserved/completed routes show disabled icon)
    - Confirm dialog: "Delete route [name]? This cannot be undone."
    - On confirm: DELETE from target_areas WHERE id=routeId
    - Reload area cards

    Function: deleteRoute(id)
  </action>
  <verify>Can delete available route; reserved/completed show disabled delete</verify>
  <done>Route deletion works with guard for active routes</done>
</task>

<task type="review">
  <name>Task 10: Phase review — identify gaps and regressions</name>
  <files>index.html, .planning/phases/06-enquiry-team/06-01-PLAN.md</files>
  <action>
    Recursive review of Phase 6 against requirements and the live codebase:

    1. Re-read PROJECT.md requirements and cross-check every item against what was built
    2. Test each user flow end-to-end:
       - Record enquiry → appears in list → appears on map → finance updates
       - Edit enquiry → changes reflected everywhere
       - Switch campaigns → all views (journal, map, finance, team, leaderboard) update
       - Add route → appears in cards + map
       - Delete route → removed from cards + map
       - Change restricted area radius → map circle updates
    3. Check for data bleed (cross-campaign data showing where it shouldn't)
    4. Check all views handle empty state (new campaign with no data)
    5. Identify any missing UI affordances, broken flows, or newly introduced regressions
    6. Document gaps in STATE.md Pending Todos for Phase 7
  </action>
  <verify>All Phase 6 flows work correctly; gaps documented</verify>
  <done>Review complete, gaps logged to STATE.md</done>
</task>

</tasks>

<verification>
- [ ] Per-postcode radius configurable; map circles match individual radii (T0.1)
- [ ] enquiries table has lat/lng columns (T1 DB migration)
- [ ] Enquiry modal records to DB with geocoded location (T2)
- [ ] Enquiry list shows records with edit/delete (T3)
- [ ] Map shows purple markers at enquiry lat/lng (T4)
- [ ] Finance projections pre-populated from DB enquiries (T5)
- [ ] Team progress shows per-member stats for selected campaign (T6)
- [ ] Leaderboard ranks correctly (T7)
- [ ] Can create a route from UI (T8)
- [ ] Can delete an available route (T9)
</verification>

<success_criteria>
- Restricted areas have per-postcode radius; map reflects this
- Enquiries recorded, geocoded, visible on map
- Finance projections auto-update from recorded enquiries
- Team progress and leaderboard functional per campaign
- Routes manageable entirely from UI
</success_criteria>

<output>
After completion, create .planning/phases/06-enquiry-team/06-01-SUMMARY.md
</output>
