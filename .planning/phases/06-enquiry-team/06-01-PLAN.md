---
phase: 06-enquiry-team
plan: 01
type: execute
wave: 1
depends_on: [04, 05]
files_modified: [index.html]
autonomous: false
---

<objective>
Add enquiry recording, enquiry heatmap overlay, team progress, and leaderboards.

Purpose: Phase 6 core — track enquiries and team performance.
Output: Updated index.html with enquiry/team features.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Enquiry recording modal</name>
  <files>index.html</files>
  <action>
    Add enquiry modal with fields:
    - Client Name (text)
    - Postcode (text)
    - Instructed (yes/no radio)
    - Instruction Value (£ number)
    
    Add openEnquiryModal(), saveEnquiry() functions.
    POST to enquiries table.
  </action>
  <verify>Can record new enquiry with all fields</verify>
  <done>Enquiry modal works</done>
</task>

<task type="auto">
  <name>Task 2: Enquiry list view</name>
  <files>index.html</files>
  <action>
    Add enquiries section showing all enquiries:
    - Table with columns: Date, Client, Postcode, Instructed, Value
    - Filter by campaign
    - Sort by date descending
    
    Load from enquiries table.
  </action>
  <verify>Enquiries display in table format</verify>
  <done>Enquiry list renders</done>
</task>

<task type="auto">
  <name>Task 3: Enquiry heatmap overlay (ENQ-02)</name>
  <files>index.html</files>
  <action>
    **Enhancement from Phase 4:** Show instructed enquiries as markers on the delivery map.
    
    In loadHeatmap():
    - Fetch enquiries where instructed=true
    - Add purple markers for each instructed enquiry
    - Marker shows: client name, postcode, instruction value
    - Different color from route markers (purple vs grey/amber/green)
    
    Update map legend to include: ◆ Instructed Enquiry
  </action>
  <verify>Map shows purple markers for instructed enquiries</verify>
  <done>Enquiry overlay on map</done>
</task>

<task type="auto">
  <name>Task 4: Team progress view (TEA-01)</name>
  <files>index.html</files>
  <action>
    Add team progress section showing:
    - Each team member's reserved/completed routes
    - Total leaflets delivered per team member
    - Progress bars
    
    Query: JOIN reservations + deliveries + team_members.
  </action>
  <verify>Team progress displays correctly</verify>
  <done>Team progress view works</done>
</task>

<task type="auto">
  <name>Task 5: Leaderboards (TEA-02)</name>
  <files>index.html</files>
  <action>
    Add leaderboard showing:
    - Rank 1-5 by total leaflets delivered
    - Show team member name + total
    - Update dynamically
    
    Query: GROUP BY team_member_1_id, team_member_2_id from deliveries.
  </action>
  <verify>Leaderboard ranks teams correctly</verify>
  <done>Leaderboard renders</done>
</task>

<task type="auto">
  <name>Task 6: Add routes to a campaign via UI</name>
  <files>index.html</files>
  <action>
    Currently there is no UI way to create routes (target_areas) for a campaign.
    Routes must be added via the Supabase SQL editor, which is not usable in production.

    Add a "Add Route" button to the routes/cards view (visible when a specific campaign is selected).
    Modal fields:
    - Route Name (text, required)
    - Postcode (text, required) — geocoded via postcodes.io on save to set lat/lng
    - House Count (number, required)

    On save:
    - POST to target_areas with campaign_id=currentCampaignId, status='available'
    - Geocode postcode via postcodes.io to populate lat/lng
    - Reload area cards

    Note: Only show this button when a specific campaign is selected (not "All Campaigns").
  </action>
  <verify>Can add a new route from the UI; it appears in the cards grid and on the map</verify>
  <done>Route creation UI working</done>
</task>

</tasks>

<verification>
- [ ] Enquiry modal records to DB
- [ ] Enquiry list shows all enquiries
- [ ] Map shows enquiry markers
- [ ] Team progress displays
- [ ] Leaderboard ranks correctly
</verification>

<success_criteria>
- Enquiries recorded with all fields
- Enquiries visible on map overlay
- Team progress tracked
- Leaderboards functional
</success_criteria>
