---
phase: 09-demographic-enrichment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
  - supabase_schema.sql
  - .planning/STATE.md
  - .planning/ROADMAP.md
  - .planning/REQUIREMENTS.md
  - .planning/PROJECT.md
  - .planning/ROUTE-PLANNING-ENGINE.md
  - .planning/HANDOFF.md
  - .planning/POSTCODE_LOAD_STATUS.md
  - .planning/phases/08-core-management/08-01-PLAN.md
autonomous: false
user_setup: []

must_haves:
  truths:
    - "New enquiries automatically get oa21_code from postcodes.io"
    - "New enquiries automatically get owner_occupied_pct from NOMIS (on-demand, not pre-loaded)"
    - "Historic enquiries with NULL owner_occupied_pct are backfilled via script"
    - "All demographic_feedback rows have populated owner_occupied_pct for analytics"
  artifacts:
    - path: "index.html"
      provides: "enrichDemographicFeedback() function + backfillDemographics() script"
    - path: "scripts/backfill_demographics.js"
      provides: "Bulk update script for historic data"
  key_links:
    - from: "index.html (enquiry save)"
      to: "NOMIS API"
      via: "fetch in enrichDemographicFeedback()"
      pattern: "nomisweb.*NM_2072_1"
---

# Phase 9 Plan: Demographic Enrichment (Option B)

**Goal:** Implement on-demand NOMIS enrichment for demographic feedback - replacing the failed CSV loading approach

**Background:**
- Phase 8 T9 (demographic enrichment) FAILED - couldn't load CSV data into Supabase
- postcodes.io v18+ already returns oa21_code - captured for new enquiries
- Need to get owner_occupied_pct via NOMIS on-demand, not pre-loaded
- This builds permanent client demographic profile for route planning

---

## Tasks

### T1: Implement enrichDemographicFeedback() Function

**What:** Add browser-side function that fetches owner_occupied_pct from NOMIS and updates the row

**Action:**
Add this function to index.html (after the existing enquiry save logic):

```javascript
// Fetch tenure data from NOMIS NM_2072_1 (TS054 Tenure)
// Returns owner_occupied_pct for a given oa21_code
async function fetchOwnerOccupiedFromNOMIS(oa21Code) {
  // NOMIS API query for TS054 - Tenure
  // Format: percentage of households that are owner-occupied
  const url = `https://api.nomisweb.co.uk/query/builder/v1?` +
    `geography=${oa21Code}&` +
    `date=2021&` +
    `cmds=TS054&` +
    `measures=20100&` +
    `select=geography,obs_value`;
  
  const res = await fetch(url);
  const data = await res.json();
  // Parse response and return percentage
  return data?.dim?.measure?.value || null;
}
```

**Files:** index.html

**Verify:** Function exists, can be called with oa21_code

**Done:** Browser JS has `enrichDemographicFeedback(enquiryId, oa21Code)` function

---

### T2: Hook Enrichment Into Enquiry Save Flow

**What:** After saving an instructed enquiry, check if owner_occupied_pct is NULL, if so call NOMIS

**Action:**
Modify the enquiry save flow (around line 1903-1917 in index.html):

1. After demographic_feedback INSERT, check if `owner_occupied_pct` is populated
2. If NULL but `oa21_code` exists, call `enrichDemographicFeedback()`
3. The function calls NOMIS → gets owner_occupied_pct → UPDATE row

**Files:** index.html

**Verify:** Create new instructed enquiry → check demographic_feedback has owner_occupied_pct

**Done:** New enquiries automatically enriched with owner_occupied_pct

---

### T2b: Server-Side Bulk Enrichment (Edge Function)

**What:** Create server-side enrichment for bulk data uploads

**Why:** Browser-side enrichment only works for UI flows. If you upload historic client data directly to Supabase (bulk CSV), the browser function won't fire. Need server-side option.

**Action:**
Option A - Supabase Edge Function:
1. Create `supabase/functions/enrich-demographic/index.ts`
2. Accepts array of `{id, postcode}` or `{id, oa21_code}` 
3. For each row: if oa21_code missing, call postcodes.io to get it
4. Then call NOMIS for owner_occupied_pct
5. UPDATE the demographic_feedback rows

Option B - SQL function:
```sql
CREATE OR REPLACE FUNCTION enrich_demographic_batch(p_limit int)
RETURNS void AS $$
DECLARE
  r RECORD;
BEGIN
  FOR r IN 
    SELECT id, postcode, oa21_code 
    FROM demographic_feedback 
    WHERE owner_occupied_pct IS NULL 
    LIMIT p_limit
  LOOP
    -- Call APIs or use existing trigger logic
    -- UPDATE row
  END LOOP;
END;
$$ LANGUAGE plpgsql;
```

**Files:** supabase/functions/enrich-demographic/index.ts OR supabase_schema.sql

**Verify:** Can call function with array of IDs, rows get updated

**Done:** Bulk historic data can be enriched without UI

---

### T3: Test New Enquiry Enrichment

**What:** Verify the complete flow works

**Action:**
1. Open the app
2. Create a new instructed enquiry with postcode NOT in route_postcodes (e.g., WF12 7DX)
3. Check demographic_feedback table - oa21_code should be populated
4. Check owner_occupied_pct should also be populated (from NOMIS)

**Verify:** 
```sql
SELECT * FROM demographic_feedback ORDER BY created_at DESC LIMIT 1;
-- oa21_code populated, owner_occupied_pct populated
```

**Done:** WF12 7DX enquiry has both oa21_code AND owner_occupied_pct

---

### T4: Create Backfill Script for Historic Data

**What:** Script to enrich all existing demographic_feedback rows with NULL owner_occupied_pct

**Action:**
Create `scripts/backfill_demographics.js`:

```javascript
// 1. Fetch all demographic_feedback where owner_occupied_pct IS NULL AND oa21_code IS NOT NULL
// 2. For each, call NOMIS API
// 3. UPDATE row with owner_occupied_pct
// 4. Log progress

const { createClient } = require('@supabase/supabase-js');
const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_KEY);

async function backfill() {
  // Get rows needing enrichment
  const { data: rows } = await supabase
    .from('demographic_feedback')
    .select('id, oa21_code')
    .is('owner_occupied_pct', null)
    .not('oa21_code', 'is', null);
  
  console.log(`Found ${rows.length} rows to backfill`);
  
  for (const row of rows) {
    const pct = await fetchOwnerOccupiedFromNOMIS(row.oa21_code);
    if (pct) {
      await supabase
        .from('demographic_feedback')
        .update({ owner_occupied_pct: pct })
        .eq('id', row.id);
      console.log(`Updated ${row.id}: ${pct}%`);
    }
  }
}

backfill();
```

**Files:** scripts/backfill_demographics.js

**Verify:** Script runs without error

**Done:** Script exists that can be run to backfill all historic data

---

### T5: Run Backfill Script

**What:** Execute the backfill script to enrich all historic enquiries

**Action:**
Run: `node scripts/backfill_demographics.js`

**Verify:**
```sql
SELECT COUNT(*) as total, 
       COUNT(owner_occupied_pct) as enriched
FROM demographic_feedback;
-- enriched should equal total (or close to it)
```

**Done:** All historic demographic_feedback rows have owner_occupied_pct

---

### T6: Phase Review & Documentation Update

**What:** Complete phase review and update all documentation

**Action - Phase Review:**
- Verify all flows work
- Document any gaps

**Action - Documentation Update (see detailed list below):**

| File | Update Required | Change Type |
|------|----------------|-------------|
| .planning/STATE.md | Update P8 T9 status to "Replaced by P9", add P9 tasks, move P9 (backlog) to P10 | Modify |
| .planning/ROADMAP.md | Add Phase 9, renumber existing P9 to P10, update P8 status | Modify |
| .planning/REQUIREMENTS.md | Update DEM-02/DEM-03 description to reflect on-demand NOMIS | Modify |
| .planning/PROJECT.md | Update Phase 8/9 descriptions | Modify |
| .planning/ROUTE-PLANNING-ENGINE.md | Update trigger explanation section | Modify |
| .planning/HANDOFF.md | Archive - no longer relevant | Archive/Delete |
| .planning/POSTCODE_LOAD_STATUS.md | Delete - approach abandoned | Delete |
| .planning/phases/08-core-management/08-01-PLAN.md | Update T9 to reference P9 | Modify |
| scripts/load_postcode_area.py | Archive to scripts/archived/ | Archive |
| scripts/wf_rows.json | Archive to scripts/archived/ | Archive |
| multi_csv/ | Move to archived_multi_csv/ | Archive |

**Files:** Multiple (see table above)

**Verify:** All documentation consistent and accurate

**Done:** Phase 9 complete, all docs updated

---

## Documentation Update Details

### STATE.md Changes
```
## Phase 8 Task Checklist
- T9: Change to "Superseded by Phase 9 - on-demand NOMIS approach"

## Phase 9 Task Checklist (NEW)
| Task | Status | Notes |
|------|--------|-------|
| T1: enrichDemographicFeedback() function | ○ Pending | |
| T2: Hook into enquiry save | ○ Pending | |
| T3: Test new enquiry | ○ Pending | |
| T4: Backfill script | ○ Pending | |
| T5: Run backfill | ○ Pending | |
| T6: Phase review + docs | ○ Pending | |

## Phase 10 Task Checklist (was P9 Backlog)
| Task | Status | Notes |
|------|--------|-------|
| T1: Dark mode toggle | ○ Pending | |
...
```

### ROADMAP.md Changes
```
### Phase 9: Demographic Enrichment (NEW)

**Goal:** On-demand NOMIS enrichment for demographic feedback

**Requirements:**
- DEM-02: Auto-enrich demographic_feedback via on-demand NOMIS call ✅
- DEM-03: Backfill historic data via script ✅

**Success Criteria:**
1. New enquiries automatically get owner_occupied_pct
2. Historic enquiries backfilled
3. Documentation updated

---

### Phase 10: Backlog (was Phase 9)

[Existing Phase 9 content]
```

### REQUIREMENTS.md Changes
```
| DEM-02 | Auto-enrich demographic_feedback | When a new row is inserted into demographic_feedback (on instructed enquiry save), if owner_occupied_pct is NULL, browser JS calls NOMIS API to fetch tenure data and updates the row. Implemented as on-demand fetch + UPDATE — no pre-loading required. |
| DEM-03 | Backfill historic demographic_feedback | Script that fetches owner_occupied_pct from NOMIS for all existing rows with NULL owner_occupied_pct but valid oa21_code. |
```

---

## Success Criteria

1. ✅ New enquiries automatically enriched with owner_occupied_pct via NOMIS
2. ✅ Historic enquiries backfilled via script
3. ✅ All documentation updated/archived appropriately
4. ✅ Phase 8 T9 marked as superseded
5. ✅ Phase 9 complete, ready to move to Phase 10 (backlog)

---

## Output

After completion, create `.planning/phases/09-demographic-enrichment/09-01-SUMMARY.md`
