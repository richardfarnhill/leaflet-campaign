---
phase: 09-demographic-enrichment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
  - supabase_schema.sql
  - .planning/STATE.md
  - .planning/ROADMAP.md
  - .planning/REQUIREMENTS.md
  - .planning/PROJECT.md
  - .planning/ROUTE-PLANNING-ENGINE.md
  - .planning/HANDOFF.md
  - .planning/POSTCODE_LOAD_STATUS.md
  - .planning/phases/08-core-management/08-01-PLAN.md
autonomous: false
user_setup: []

must_haves:
  truths:
    - "New enquiries automatically get oa21_code from postcodes.io"
    - "New enquiries automatically get owner_occupied_pct from NOMIS (on-demand, not pre-loaded)"
    - "Historic enquiries with NULL owner_occupied_pct are backfilled via script"
    - "All demographic_feedback rows have populated owner_occupied_pct for analytics"
  artifacts:
    - path: "index.html"
      provides: "enrichDemographicFeedback() function + backfillDemographics() script"
    - path: "scripts/backfill_demographics.js"
      provides: "Bulk update script for historic data"
  key_links:
    - from: "index.html (enquiry save)"
      to: "NOMIS API"
      via: "fetch in enrichDemographicFeedback()"
      pattern: "nomisweb.*NM_2072_1"
---

# Phase 9 Plan: Demographic Enrichment (Option B)

**Goal:** Implement on-demand NOMIS enrichment for demographic feedback - replacing the failed CSV loading approach

**Background:**
- Phase 8 T9 (demographic enrichment) FAILED - couldn't load CSV data into Supabase
- postcodes.io v18+ already returns oa21_code - captured for new enquiries
- Need to get owner_occupied_pct via NOMIS on-demand, not pre-loaded
- This builds permanent client demographic profile for route planning

---

## Tasks

### T1: Implement enrichDemographicFeedback() Function

**What:** Add browser-side function that fetches owner_occupied_pct from NOMIS and updates the row

**Action:**
Add this function to index.html (after the existing enquiry save logic):

```javascript
// Fetch tenure data from NOMIS NM_2072_1 (TS054 Tenure)
// Returns owner_occupied_pct for a given oa21_code
async function fetchOwnerOccupiedFromNOMIS(oa21Code) {
  // NOMIS API query for TS054 - Tenure
  // Format: percentage of households that are owner-occupied
  const url = `https://api.nomisweb.co.uk/query/builder/v1?` +
    `geography=${oa21Code}&` +
    `date=2021&` +
    `cmds=TS054&` +
    `measures=20100&` +
    `select=geography,obs_value`;
  
  const res = await fetch(url);
  const data = await res.json();
  // Parse response and return percentage
  return data?.dim?.measure?.value || null;
}
```

**Files:** index.html

**Verify:** Function exists, can be called with oa21_code

**Done:** Browser JS has `enrichDemographicFeedback(enquiryId, oa21Code)` function

---

### T2: Hook Enrichment Into Enquiry Save Flow

**What:** After saving an instructed enquiry, check if owner_occupied_pct is NULL, if so call NOMIS

**Action:**
Modify the enquiry save flow (around line 1903-1917 in index.html):

1. After demographic_feedback INSERT, check if `owner_occupied_pct` is populated
2. If NULL but `oa21_code` exists, call `enrichDemographicFeedback()`
3. The function calls NOMIS → gets owner_occupied_pct → UPDATE row

**Files:** index.html

**Verify:** Create new instructed enquiry → check demographic_feedback has owner_occupied_pct

**Done:** New enquiries automatically enriched with owner_occupied_pct

---

### T2b: Server-Side Bulk Enrichment (CRITICAL — NOT YET DONE)

**What:** Create server-side enrichment for bulk data uploads and API calls

**Why:** Browser-side enrichment (T2) ONLY works for UI flows (enquiry modal). It does NOT work for:
- Bulk CSV imports directly into `demographic_feedback`
- Programmatic API inserts
- Historic data backfills
- Any data loaded outside the enquiry save modal

**CRITICAL:** Without this, bulk demographic enrichment is impossible.

**Action:**
Create a SQL trigger + helper function that runs NOMIS enrichment on INSERT to `demographic_feedback`:

1. Create `enrich_demographic_feedback()` trigger function in supabase_schema.sql
2. Function checks: if `owner_occupied_pct IS NULL AND oa21_code IS NOT NULL`
3. Function calls Supabase HTTP extension to fetch NOMIS data
4. Function parses response and UPDATEs the row
5. Attach trigger to `demographic_feedback` table on INSERT

SQL Outline:
```sql
CREATE OR REPLACE FUNCTION enrich_demographic_feedback()
RETURNS TRIGGER AS $$
DECLARE
  v_pct FLOAT;
  v_response JSONB;
BEGIN
  IF NEW.owner_occupied_pct IS NULL AND NEW.oa21_code IS NOT NULL THEN
    -- Call NOMIS API via http extension
    v_response := (http_get('https://www.nomisweb.co.uk/api/v01/dataset/NM_2072_1.data.json?geography='||NEW.oa21_code||'&c2021_tenure_9=1001&measures=20301&select=geography_code,obs_value')).content::jsonb;
    -- Parse response and extract value
    v_pct := (v_response->'obs'->0->'obs_value'->>'value')::float;
    NEW.owner_occupied_pct := v_pct;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_enrich_demographic_on_insert
BEFORE INSERT ON demographic_feedback
FOR EACH ROW
EXECUTE FUNCTION enrich_demographic_feedback();
```

**Files:** supabase_schema.sql

**Verify:**
```sql
-- Insert a row directly (not via UI):
INSERT INTO demographic_feedback (campaign_id, postcode, oa21_code, created_at)
VALUES ('123', 'WF12 7DX', 'E00000001', NOW());

-- Check it was enriched:
SELECT * FROM demographic_feedback WHERE oa21_code = 'E00000001';
-- Expected: owner_occupied_pct populated
```

**Done:** All demographic_feedback rows (from any source) auto-enrich with owner_occupied_pct

---

### T3: Test Complete Enrichment Flow (UI + Bulk)

**What:** Verify both browser-side (T2) and server-side (T2b) enrichment work end-to-end

**Action - Part A: Browser-side (UI) enrichment**
1. Open the app
2. Create a new instructed enquiry with postcode NOT in route_postcodes (e.g., WF12 7DX)
3. Monitor browser console for: `Enriched demographic_feedback XXX: NN% owner-occupied`
4. Query DB to confirm

**Action - Part B: Server-side (bulk) enrichment**
1. Insert a row directly into `demographic_feedback` (simulating bulk upload):
```sql
INSERT INTO demographic_feedback (campaign_id, postcode, oa21_code, created_at)
VALUES ('test-campaign', 'WF14 8NJ', 'E00000002', NOW())
RETURNING *;
```
2. Immediately query and verify owner_occupied_pct is populated
3. Repeat with 5-10 different OAs to validate consistency

**Verify:**
```sql
-- UI flow test:
SELECT id, postcode, oa21_code, owner_occupied_pct FROM demographic_feedback
WHERE postcode = 'WF12 7DX'
ORDER BY created_at DESC LIMIT 1;

-- Bulk flow test:
SELECT id, postcode, oa21_code, owner_occupied_pct FROM demographic_feedback
WHERE postcode IN ('WF14 8NJ', 'WF14 8PJ', 'WF14 8PR')
ORDER BY created_at DESC LIMIT 3;
-- All should have owner_occupied_pct populated
```

**Done:** Both UI and bulk enrichment flows work. NOMIS API responds correctly to all OA codes.

---

### T4: Create Backfill Script for Historic Data

**What:** Script to enrich all existing demographic_feedback rows with NULL owner_occupied_pct

**Action:**
Create `scripts/backfill_demographics.js`:

```javascript
// 1. Fetch all demographic_feedback where owner_occupied_pct IS NULL AND oa21_code IS NOT NULL
// 2. For each, call NOMIS API
// 3. UPDATE row with owner_occupied_pct
// 4. Log progress

const { createClient } = require('@supabase/supabase-js');
const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_KEY);

async function backfill() {
  // Get rows needing enrichment
  const { data: rows } = await supabase
    .from('demographic_feedback')
    .select('id, oa21_code')
    .is('owner_occupied_pct', null)
    .not('oa21_code', 'is', null);
  
  console.log(`Found ${rows.length} rows to backfill`);
  
  for (const row of rows) {
    const pct = await fetchOwnerOccupiedFromNOMIS(row.oa21_code);
    if (pct) {
      await supabase
        .from('demographic_feedback')
        .update({ owner_occupied_pct: pct })
        .eq('id', row.id);
      console.log(`Updated ${row.id}: ${pct}%`);
    }
  }
}

backfill();
```

**Files:** scripts/backfill_demographics.js

**Verify:** Script runs without error

**Done:** Script exists that can be run to backfill all historic data

---

### T5: Validate & Run Backfill Script

**What:** Test the backfill script with real data, then run it on full dataset

**Prerequisites:**
- T2b (server-side trigger) must be deployed first
- At least 5-10 demographic_feedback rows with NULL owner_occupied_pct must exist (T3 Part B creates these)

**Action - Part A: Dry-run test**
1. Verify script uses correct NOMIS URL: `https://www.nomisweb.co.uk/api/v01/dataset/NM_2072_1.data.json`
2. Add test mode: script should log first 3 updates without committing, then ask for confirmation
3. Test with a small subset (first 5 rows):
```bash
SUPABASE_URL=<your-url> SUPABASE_KEY=<your-key> node scripts/backfill_demographics.js --limit 5 --dry-run
```

**Action - Part B: Full run**
1. Once dry-run succeeds, run on full dataset:
```bash
SUPABASE_URL=<your-url> SUPABASE_KEY=<your-key> node scripts/backfill_demographics.js
```
2. Monitor output for failures (failed NOMIS calls, DB errors)
3. Log final summary: X rows enriched, Y failed

**Verify:**
```sql
-- Before backfill:
SELECT COUNT(*) as total_rows,
       COUNT(owner_occupied_pct) as enriched_rows
FROM demographic_feedback;

-- After backfill (should be ~equal):
SELECT COUNT(*) as total_rows,
       COUNT(owner_occupied_pct) as enriched_rows,
       COUNT(*) - COUNT(owner_occupied_pct) as still_null
FROM demographic_feedback;
-- still_null should be ~0 (or only non-enrichable rows like invalid OAs)
```

**Done:** Backfill script runs successfully with real data. All enrichable rows have owner_occupied_pct.

---

### T6: Phase Review & Documentation Update

**What:** Complete phase review and update all documentation

**Action - Phase Review:**
- Verify all flows work
- Document any gaps

**Action - Documentation Update (see detailed list below):**

| File | Update Required | Change Type |
|------|----------------|-------------|
| .planning/STATE.md | Update P8 T9 status to "Replaced by P9", add P9 tasks, move P9 (backlog) to P10 | Modify |
| .planning/ROADMAP.md | Add Phase 9, renumber existing P9 to P10, update P8 status | Modify |
| .planning/REQUIREMENTS.md | Update DEM-02/DEM-03 description to reflect on-demand NOMIS | Modify |
| .planning/PROJECT.md | Update Phase 8/9 descriptions | Modify |
| .planning/ROUTE-PLANNING-ENGINE.md | Update trigger explanation section | Modify |
| .planning/HANDOFF.md | Archive - no longer relevant | Archive/Delete |
| .planning/POSTCODE_LOAD_STATUS.md | Delete - approach abandoned | Delete |
| .planning/phases/08-core-management/08-01-PLAN.md | Update T9 to reference P9 | Modify |
| scripts/load_postcode_area.py | Archive to scripts/archived/ | Archive |
| scripts/wf_rows.json | Archive to scripts/archived/ | Archive |
| multi_csv/ | Move to archived_multi_csv/ | Archive |

**Files:** Multiple (see table above)

**Verify:** All documentation consistent and accurate

**Done:** Phase 9 complete, all docs updated

---

## Documentation Update Details

### STATE.md Changes
```
## Phase 8 Task Checklist
- T9: Change to "Superseded by Phase 9 - on-demand NOMIS approach"

## Phase 9 Task Checklist (NEW)
| Task | Status | Notes |
|------|--------|-------|
| T1: enrichDemographicFeedback() function | ○ Pending | |
| T2: Hook into enquiry save | ○ Pending | |
| T3: Test new enquiry | ○ Pending | |
| T4: Backfill script | ○ Pending | |
| T5: Run backfill | ○ Pending | |
| T6: Phase review + docs | ○ Pending | |

## Phase 10 Task Checklist (was P9 Backlog)
| Task | Status | Notes |
|------|--------|-------|
| T1: Dark mode toggle | ○ Pending | |
...
```

### ROADMAP.md Changes
```
### Phase 9: Demographic Enrichment (NEW)

**Goal:** On-demand NOMIS enrichment for demographic feedback

**Requirements:**
- DEM-02: Auto-enrich demographic_feedback via on-demand NOMIS call ✅
- DEM-03: Backfill historic data via script ✅

**Success Criteria:**
1. New enquiries automatically get owner_occupied_pct
2. Historic enquiries backfilled
3. Documentation updated

---

### Phase 10: Backlog (was Phase 9)

[Existing Phase 9 content]
```

### REQUIREMENTS.md Changes
```
| DEM-02 | Auto-enrich demographic_feedback | When a new row is inserted into demographic_feedback (on instructed enquiry save), if owner_occupied_pct is NULL, browser JS calls NOMIS API to fetch tenure data and updates the row. Implemented as on-demand fetch + UPDATE — no pre-loading required. |
| DEM-03 | Backfill historic demographic_feedback | Script that fetches owner_occupied_pct from NOMIS for all existing rows with NULL owner_occupied_pct but valid oa21_code. |
```

---

## Success Criteria

**MUST HAVE (Phase 9 blocked until complete):**
1. Server-side trigger (T2b) deployed and tested with direct SQL INSERT
2. Browser-side enrichment (T2) tested with UI enquiry creation
3. Both flows verified to populate owner_occupied_pct
4. Backfill script successfully runs with real demographic_feedback data
5. All documentation updated to reflect completed state

**OPTIONAL (for Phase 10):**
- Monitoring/alerting for NOMIS API failures
- Rate limiting improvements
- Fallback enrichment strategy if NOMIS unavailable

---

## Output

After completion, create `.planning/phases/09-demographic-enrichment/09-01-SUMMARY.md`
