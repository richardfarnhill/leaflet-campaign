# Phase 8 Plan: Route Management & API

**Goal:** Route lifecycle improvements, stats API, auto-assign enquiries

**Dependencies:** Phase 7 (route deletion UI, security)

---

## Tasks

### T1: Route Card Details (from P7)

- [ ] Display `streets[]` on route cards
- [ ] Add "View Boundary" map link using Leaflet + `gps_bounds`

**Verification:** Route cards show street names + working map link

---

### T2: Route Deletion â†’ Create Prompt

- [ ] After delete, calculate remaining leaflets (target - delivered)
- [ ] If >500 short, show modal prompting new route creation
- [ ] Pre-fill postcode area for new route

**Verification:** Delete triggers creation prompt when needed

---

### T3: Global Exclusion Areas Review

- [ ] Check `restricted_areas` table has data
- [ ] Verify polygon rendering in map view
- [ ] Fix any stale data

**Verification:** Restricted areas render correctly

---

### T4: Auto-assign Enquiries to Routes

- [ ] On enquiry create, extract postcode
- [ ] Match to route via `target_areas.postcode`
- [ ] Update enquiry with `target_area_id`
- [ ] Leaderboards show route-level attribution

**Verification:** New enquiries link to routes automatically

---

### T5: Delivery Stats API Endpoint

- [ ] Create Supabase RPC function `get_delivery_stats`
- [ ] Returns:
  - **Volume metrics:**
    - `total_leaflets_all_time`
    - `leaflets_last_30_days`
    - `leaflets_by_month` (array of {month, count})
    - `deliveries_by_campaign` (array)
    - `routes_completed_count`
    - `active_routes_count`
  - **Financial metrics:**
    - `total_revenue` (from cases table)
    - `revenue_per_100_leaflets` (calculated)
    - `enquiries_count`
    - `enquiries_last_30_days`
    - `conversion_rate` (cases / enquiries)
    - `average_case_value`
    - `projected_revenue_remaining` (based on response rate config)
- [ ] Add REST endpoint in index.html to consume this

**Verification:** API returns correct aggregated stats

---

### T6: Demographic Feedback Table

- [ ] Create `demographic_feedback` table:
  ```sql
  CREATE TABLE demographic_feedback (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    enquiry_id UUID REFERENCES enquiries(id),
    property_type TEXT,
    response TEXT,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
  );
  ```
- [ ] Add UI to record feedback on enquiry detail view

**Verification:** Can record and query demographic data

---

### T7: Phase Review

- [ ] Review implementations
- [ ] Verify against requirements
- [ ] Document gaps for Phase 9

---

## Success Criteria

1. Route cards show street names + boundary link
2. Delete prompts new route creation when needed
3. Restricted areas working
4. Enquiries auto-assign to routes
5. Stats API delivers volume + financial metrics (monthly, 30-day, revenue per 100 leaflets)
6. Demographic feedback table functional
