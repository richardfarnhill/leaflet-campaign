# Phase 8 Plan: Route Management & API

**Goal:** Route lifecycle improvements, stats API, auto-assign enquiries

**Dependencies:** Phase 7 (route deletion UI, security)

---

## Tasks

### T1: Route Card Details (from P7)

- [ ] Display `streets[]` on route cards
- [ ] Add "View Boundary" map link using Leaflet + `gps_bounds`

**Verification:** Route cards show street names + working map link

---

### T2: Route Deletion → Create Prompt

**Status:** ✓ Done (2026-02-26)
- [x] After delete, calculate remaining leaflets (target - delivered)
- [x] If >500 short, show modal prompting new route creation
- [x] Pre-fill postcode area for new route

**Implementation:**
- Added `checkRoutingShortfall(campaignId)` - calculates shortfall
- Added `checkAndPromptRouting()` - checks on page load, after delete, after add
- Auto-clears `needs_routing` flag when shortfall ≤ 500
- Uses `campaigns.needs_routing` boolean (set true on campaign create)

**Verification:** Delete triggers creation prompt when needed ✓

---

### T3: Global Exclusion Areas Review

- [ ] Check `restricted_areas` table has data
- [ ] Verify polygon rendering in map view
- [ ] Fix any stale data

**Verification:** Restricted areas render correctly

---

### T4: Auto-assign Enquiries to Routes

- [ ] On enquiry create, extract postcode
- [ ] Match to route via `target_areas.postcode`
- [ ] Update enquiry with `target_area_id`
- [ ] Leaderboards show route-level attribution

**Verification:** New enquiries link to routes automatically

---

### T5: Delivery Stats API Endpoint

**Status:** RPC function exists in supabase_schema.sql (get_delivery_stats)
- [x] Create Supabase RPC function `get_delivery_stats`
- [x] Returns volume + financial metrics (all time, last 30 days, filtered period)

**For external reporting only** - data analyst calls via HTTP:
```
POST /rest/v1/rpc/get_delivery_stats
?p_campaign_id=UUID
&p_start_date=2026-01-01
&p_end_date=2026-01-31
```

**Verification:** Test via curl or Postman

---

### T6: Demographic Feedback Table

- [ ] Create `demographic_feedback` table:
  ```sql
  CREATE TABLE demographic_feedback (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    enquiry_id UUID REFERENCES enquiries(id),
    property_type TEXT,
    response TEXT,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
  );
  ```
- [ ] Add UI to record feedback on enquiry detail view

**Verification:** Can record and query demographic data

---

### T9: Demographic enrichment — auto-populate owner_occupied_pct

**Status:** ⛔ SUPERSEDED by Phase 9
- Original approach (CSV load into postcode_oa_lookup) FAILED
- Replaced by Phase 9: on-demand NOMIS enrichment
- See: `.planning/phases/09-demographic-enrichment/09-01-PLAN.md`

---

### T10: Phase Review & Audit

- [x] Review implementations
- [x] Verify against requirements
- [x] Document gaps for Phase 9 (now Phase 10)
- [x] Phase 8 complete — superseded P8 T9 approach, replaced by P9

---

### T8: Testing Procedure

- [x] Document testing approach in `.planning/codebase/QUALITY.md`
- [x] Create test scenarios for critical flows:
  - Enquiry record → list → map → finance
  - Campaign switch isolation
  - Route creation/deletion
  - Delivery completion
- [x] Add Puppeteer test runner (tests/runner.js)
- [x] Run tests - ALL PASSED

**Verification:** Test procedure documented and baseline tests pass ✓

---

## Success Criteria

1. Route cards show street names + boundary link
2. Delete prompts new route creation when needed
3. Restricted areas working
4. Enquiries auto-assign to routes
5. ✓ Stats API delivers volume + financial metrics (external use only)
6. Demographic feedback table functional
7. Testing procedure documented
