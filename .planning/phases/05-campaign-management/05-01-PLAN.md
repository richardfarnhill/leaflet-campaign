---
phase: 05-campaign-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [index.html]
autonomous: false
must_haves:
  truths:
    - "Campaign selector switches between campaigns and updates all data"
    - "Campaign config modal allows editing target_leaflets, dates"
    - "Aggregated stats show totals across all campaigns"
    - "Response rate scenarios are configurable"
  artifacts:
    - path: "index.html"
      provides: "Campaign management UI"
      contains: "loadCampaignConfig"
  key_links:
    - from: "campaign selector"
      to: "all data views"
      via: "currentCampaignId"
---

<objective>
Add campaign management features: switching, configuration, and aggregated views.

Purpose: Phase 5 core — enable multiple campaigns and configuration.
Output: Updated index.html with campaign management UI.
</objective>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-campaign-management/CONTEXT.md

Key facts:
- Single-file app: index.html. No build step.
- campaigns table: id, name, target_leaflets, start_date, end_date, is_active
- campaign_members table: campaign_id, team_member_id (many-to-many)
- Campaign selector exists in header
- Hardcoded 20000 leaflets needs to come from campaigns table
- STAFF array hardcoded - should come from team_members table
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance campaign selector with "All Campaigns" option</name>
  <files>index.html</files>
  <action>
    Update campaign selector to include:
    - Current campaign (existing)
    - "All Campaigns" option for aggregated view
    
    Modify loadCampaigns() to include this option and handle currentCampaignId=null for all.
  </action>
  <verify>Selector shows "All Campaigns" and selecting it aggregates data</verify>
  <done>Campaign selector has All Campaigns option</done>
</task>

<task type="auto">
  <name>Task 2: Create campaign config modal</name>
  <files>index.html</files>
  <action>
    Add modal HTML for editing campaign settings:
    ```html
    <div id="campaignConfigModal" class="modal-overlay">
      <div class="modal">
        <h3>Configure Campaign</h3>
        <div class="modal-field">
          <label>Campaign Name</label>
          <input type="text" id="configCampaignName" readonly>
        </div>
        <div class="modal-field">
          <label>Target Leaflets</label>
          <input type="number" id="configTargetLeaflets">
        </div>
        <div class="modal-field">
          <label>Start Date</label>
          <input type="date" id="configStartDate">
        </div>
        <div class="modal-field">
          <label>End Date</label>
          <input type="date" id="configEndDate">
        </div>
        <div class="modal-field">
          <label>Team Members</label>
          <div id="configTeamMembers"></div>
        </div>
        <div class="modal-actions">
          <button class="modal-btn cancel" onclick="closeCampaignConfig()">Cancel</button>
          <button class="modal-btn confirm" onclick="saveCampaignConfig()">Save</button>
        </div>
      </div>
    </div>
    ```
    
    Add openCampaignConfig(), closeCampaignConfig(), saveCampaignConfig() functions.
  </action>
  <verify>Clicking "Config" button opens modal with campaign data</verify>
  <done>Campaign config modal renders and saves</done>
</task>

<task type="auto">
  <name>Task 3: Add config button to campaign selector</name>
  <files>index.html</files>
  <action>
    Add a gear icon/config button next to campaign selector:
    ```html
    <div class="campaign-selector">
      <label>Campaign:</label>
      <select id="campaignSelect"><option value="">Loading...</option></select>
      <button onclick="openCampaignConfig()" style="background:none;border:none;cursor:pointer;font-size:1.1rem;" title="Configure Campaign">&#9881;</button>
    </div>
    ```
  </action>
  <verify>Config button appears next to selector</verify>
  <done>Config button visible in header</done>
</task>

<task type="auto">
  <name>Task 4: DB-driven summary bar + completion rate (CFG-03)</name>
  <files>index.html</files>
  <satisfies>CFG-03</satisfies>
  <action>
    **Known issue (identified in T11 sync review):** Summary bar (Delivered, Remaining,
    Sessions Done, Est. Completion, Progress %) still reads from legacy render()/updateSummary()
    backed by the BASE hardcoded array and session_log. These do not reflect DB state.
    Hardcoded TOTAL=20000 but campaign.target_leaflets=30000 in DB.

    Fix:
    1. Add loadSummaryStats() function that reads from DB:
       - campaign.target_leaflets (not hardcoded TOTAL)
       - SUM(deliveries.leaflets_delivered) WHERE campaign_id=currentCampaignId
       - COUNT(target_areas WHERE status='completed') / COUNT(target_areas)
    2. Call loadSummaryStats() from loadAll() and after any delivery completion
    3. Update loadCompletionRate() to use campaign.target_leaflets not hardcoded 20000
    4. Remove references to TOTAL constant in summary bar context

    Also update summary-bar labels: "Sessions Done" → completed routes count / total routes.
  </action>
  <verify>Summary bar shows values from DB. Changing campaign shows correct stats for that campaign.</verify>
  <done>Summary bar DB-driven, no hardcoded totals</done>
</task>

<task type="auto">
  <name>Task 5: Implement aggregated stats for "All Campaigns" view</name>
  <files>index.html</files>
  <action>
    When currentCampaignId is null/empty (All Campaigns), load aggregated stats:
    - sumDelivered: total from all deliveries
    - sumRemaining: sum of all campaign targets - delivered
    - Show campaign breakdown in analytics
    
    Update loadDeliveredTotal() to handle null campaignId.
  </action>
  <verify>All Campaigns shows totals across all campaigns</verify>
  <done>Aggregated view working</done>
</task>

<task type="auto">
  <name>Task 6: Add response rate + default case value configuration (CFG-02, CFG-04)</name>
  <files>index.html</files>
  <satisfies>CFG-02, CFG-04</satisfies>
  <action>
    **Context:** The hardcoded baseline rates (0.25%/0.5%/1.0%) and DEFAULT_CV (£294.42) are
    CORRECT FALLBACKS — do not remove them. Finance projections already use real enquiry/case
    data when available, falling back to these constants when no data exists. This task adds
    per-campaign OVERRIDE values that, when set, take priority over the hardcoded fallbacks.
    If a campaign override is null/unset, the existing hardcoded fallback continues to apply.

    Add to campaign config modal:
    ```html
    <div class="modal-field">
      <label>Response Rate Overrides (leave blank to use defaults: 0.25% / 0.5% / 1.0%)</label>
      <div style="display:flex;gap:8px;">
        <input type="number" step="0.01" id="configRateConservative" placeholder="0.25" style="width:80px">%
        <input type="number" step="0.01" id="configRateTarget" placeholder="0.5" style="width:80px">%
        <input type="number" step="0.01" id="configRateOptimistic" placeholder="1.0" style="width:80px">%
      </div>
    </div>
    ```

    Also add a default case value override input (CFG-04):
    ```html
    <div class="modal-field">
      <label>Default Case Value Override (£) (leave blank to use £294.42)</label>
      <input type="number" step="0.01" id="configDefaultCaseValue" placeholder="294.42">
    </div>
    ```

    **DB migration required** (run in Supabase SQL editor — anon key cannot run DDL):
    ```sql
    ALTER TABLE campaigns
      ADD COLUMN IF NOT EXISTS rate_conservative numeric,
      ADD COLUMN IF NOT EXISTS rate_target numeric,
      ADD COLUMN IF NOT EXISTS rate_optimistic numeric,
      ADD COLUMN IF NOT EXISTS default_case_value numeric;
    ```

    Update finance projections to check campaign override columns first, falling back to
    hardcoded constants when null:
    - rateConservative = campaign.rate_conservative ?? 0.0025
    - rateTarget = campaign.rate_target ?? 0.005
    - rateOptimistic = campaign.rate_optimistic ?? 0.01
    - DEFAULT_CV = campaign.default_case_value ?? 294.42
  </action>
  <verify>Setting a campaign override changes revenue projections; leaving blank preserves existing behaviour</verify>
  <done>Response rate and case value overrides configurable per campaign; hardcoded fallbacks intact</done>
</task>

<task type="auto">
  <name>Task 7: Create new campaign functionality</name>
  <files>index.html</files>
  <action>
    Add "New Campaign" button to campaign selector:
    ```html
    <button onclick="openNewCampaignModal()" style="background:#27ae60;color:white;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;">+ New</button>
    ```
    
    Create new campaign modal with fields: name, target_leaflets, start_date, end_date
    On save: POST to campaigns table, then reload selector
  </action>
  <verify>Can create new campaign from UI</verify>
  <done>New campaign creation works</done>
</task>

<task type="auto">
  <name>Task 7a: Seed a second dummy campaign for multi-campaign testing</name>
  <files>index.html</files>
  <action>
    After T7 (new campaign UI) is working, create a second campaign via the UI to enable
    meaningful testing of the All Campaigns aggregated view and campaign switching.

    Seed campaign details (insert via UI or Supabase SQL editor):
    - Name: "Test Campaign 2"
    - target_leaflets: 15000
    - start_date: 2026-03-01
    - end_date: 2026-06-30

    Also insert at least one target_area and one delivery record for this campaign so the
    aggregated stats view has genuinely different numbers to sum across campaigns.

    SQL for seed data if inserting directly (substitute real campaign_id after creation):
    ```sql
    -- After creating the campaign via UI, get its ID then:
    INSERT INTO target_areas (campaign_id, name, postcode, status, house_count)
    VALUES ('<new_campaign_id>', 'Test Route A', 'SK9 1AA', 'available', 450);
    ```

    **Purpose:** Without a second campaign, "All Campaigns" view is indistinguishable from
    single-campaign view and cannot be verified.
  </action>
  <verify>Campaign selector shows 2 campaigns. All Campaigns totals differ from either individual campaign.</verify>
  <done>Second campaign exists with at least one route and one delivery</done>
</task>

<task type="auto">
  <name>Task 8: Remove hardcoded STAFF array</name>
  <files>index.html</files>
  <action>
    Replace hardcoded STAFF array with dynamic team_members loading:
    - Remove: const STAFF=['— Unassigned —','Richard','Josh','Dan','Cahner'];
    - Use teamMembers from loadTeamMembers() everywhere
    - Update any dropdowns to use loaded team members
  </action>
  <verify>Team member dropdowns populate from DB</verify>
  <done>No hardcoded team member array</done>
</task>

<task type="auto">
  <name>Task 9: Add restricted areas configuration per campaign</name>
  <files>Supabase, index.html</files>
  <action>
    **Context:** Original requirement from PROJECT.md - exclude WA14, WA15, M33, inner areas from campaign targeting. Add configuration to campaign to define restricted postcodes.

    **DB migration:**
    ```sql
    ALTER TABLE campaigns ADD COLUMN IF NOT EXISTS restricted_postcodes text[];
    ```

    **UI enhancement to campaign config modal:**
    - Add textarea/input for restricted postcodes (comma-separated, e.g. "WA14, WA15, M33")
    - Save to restricted_postcodes array column

    **Map enhancement:**
    - In loadHeatmap(), fetch restricted_postcodes for current campaign
    - Add hashed polygon overlay for restricted areas on the map
    - Visual indicator that these areas are not for targeting
  </action>
  <verify>Campaign config shows restricted postcodes field; map displays restricted area overlay</verify>
  <done>Restricted areas configurable and displayed on map</done>
</task>

<task type="auto">
  <name>Task 10: Add missing DB columns to campaigns table</name>
  <files>Supabase</files>
  <action>
    Run in Supabase SQL editor:
    ```sql
    ALTER TABLE campaigns ADD COLUMN IF NOT EXISTS rate_conservative numeric;
    ALTER TABLE campaigns ADD COLUMN IF NOT EXISTS rate_target numeric;
    ALTER TABLE campaigns ADD COLUMN IF NOT EXISTS rate_optimistic numeric;
    ALTER TABLE campaigns ADD COLUMN IF NOT EXISTS default_case_value numeric;
    ```
  </action>
  <verify>Columns exist and config modal saves without error</verify>
  <done>DB columns added</done>
</task>

<task type="auto">
  <name>Task 11: Add team member management to campaign config</name>
  <files>index.html</files>
  <action>
    Currently config modal shows team members as read-only list. Add checkboxes to assign/remove team members to campaign.
    
    - Add checkbox list of all team members in config modal
    - On save: INSERT/DELETE to campaign_members table
    - Load current assignments on modal open
  </action>
  <verify>Can assign and unassign team members to campaign</verify>
  <done>Team members configurable per campaign</done>
</task>

<task type="auto">
  <name>Task 12: Add edit capability to delivery journal</name>
  <files>index.html</files>
  <action>
    Add edit button to each row in Delivery Journal table.
    - Click edit → inline edit or modal with fields
    - Editable: leaflets_delivered, team members, date, notes
    - Save updates deliveries table
  </action>
  <verify>Can edit delivery details after recording</verify>
  <done>Delivery journal editable</done>
</task>

<task type="auto">
  <name>Task 13: Restricted areas configuration UI</name>
  <files>index.html</files>
  <action>
    Add UI to manage restricted_areas table:
    - List current restricted areas with edit/delete
    - Add new: postcode prefix, radius (miles), label
    - This is GLOBAL (not per-campaign) - applies to all campaigns
  </action>
  <verify>Can add/edit/remove restricted areas</verify>
  <done>Restricted areas UI working</done>
</task>

<task type="auto">
  <name>Task 14: Show restricted areas as polygons on map</name>
  <files>index.html</files>
  <action>
    Current implementation only marks routes that encroach restricted postcodes.
    Required: Show restricted areas as colored polygons on the map.
    
    For each restricted area:
    - Get center postcode via postcodes.io
    - Draw circle/polygon with radius_miles
    - Hashed/striped pattern fill to indicate restricted
    - Different color (red/orange)
  </action>
  <verify>Map shows polygons for restricted areas</verify>
  <done>Restricted areas render as polygons</done>
</task>

</tasks>

<verification>
- [ ] Campaign selector shows All Campaigns option
- [ ] Config modal opens and saves campaign settings
- [ ] Completion rate uses campaign.target_leaflets from DB
- [ ] All Campaigns view shows aggregated totals (verified with 2 campaigns)
- [ ] Response rate and case value overrides configurable per campaign; leaving blank preserves hardcoded fallbacks
- [ ] Can create new campaign from UI
- [ ] Second dummy campaign exists with route + delivery data
- [ ] No hardcoded STAFF array
</verification>

<success_criteria>
- Campaign switching works
- Config modal saves to DB
- Aggregated stats show correctly
- All hardcoded values replaced with DB queries
- Restricted areas configurable per campaign
</success_criteria>

<output>
After completion, create .planning/phases/05-campaign-management/05-01-SUMMARY.md
</output>
