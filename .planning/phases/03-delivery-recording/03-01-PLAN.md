---
phase: 03-delivery-recording
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [index.html]
autonomous: false
user_setup:
  - service: supabase
    why: "Need to verify complete_delivery RPC writes to deliveries table — requires checking via Supabase dashboard or SQL editor"
    dashboard_config:
      - task: "Run verification query in SQL editor"
        location: "Supabase Dashboard → SQL Editor"
        details: "SELECT * FROM deliveries ORDER BY created_at DESC LIMIT 5; — if empty after a test completion, the RPC needs fixing"

must_haves:
  truths:
    - "Completing a reserved area writes a row to the deliveries table"
    - "sumDelivered stat shows total from deliveries table, not session_log"
    - "Delivery journal section appears below stats showing completed areas newest-first"
    - "1500 cap removed from legacy session_log input"
  artifacts:
    - path: "index.html"
      provides: "loadDeliveryJournal function, updated updateSummary or new stat source, journal HTML section"
      contains: "loadDeliveryJournal"
  key_links:
    - from: "deliveries table"
      to: "sumDelivered stat"
      via: "REST query on /rest/v1/deliveries"
      pattern: "rest/v1/deliveries"
    - from: "deliveries table"
      to: "journal section"
      via: "loadDeliveryJournal function"
      pattern: "loadDeliveryJournal"
---

<objective>
Wire up the deliveries table to the UI: fix the sumDelivered stat to read from
deliveries, add a delivery journal section, and remove the legacy 1500 cap.

Purpose: Phase 3 core — recorded completions must be visible and counted correctly.
Output: Updated index.html with journal section and correct stat source.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
./.opencode/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-delivery-recording/CONTEXT.md

Key facts:
- Single-file app: index.html. No build step. Direct Supabase REST calls via sbFetch().
- deliveries table columns: id, campaign_id, target_area_id, team_member_1_id, team_member_2_id, delivery_date, leaflets_delivered, notes, created_at
- target_areas table has: area_name
- team_members table has: name
- complete_delivery RPC is called at: sbFetch('/rest/v1/rpc/complete_delivery', ...) — assumed to write to deliveries table (verify first)
- sumDelivered stat (id="sumDelivered") is set in updateSummary() at ~line 1053 — currently reads from session_log via sessionState
- Legacy session_log input has max="1500" at ~line 1021
- loadAreaCards() and renderAreaCards() handle the card grid — do not touch these
- Journal should appear below the stat bar (#sumDelivered etc) and above the existing financial/session sections
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Nothing yet — verification step before writing any code.</what-built>
  <how-to-verify>
    1. Open Supabase Dashboard → SQL Editor
    2. Run: SELECT * FROM deliveries ORDER BY created_at DESC LIMIT 5;
    3. If rows exist: the RPC already writes correctly — reply "rpc-ok"
    4. If empty (and you have completed at least one area): the RPC needs fixing — reply "rpc-broken"
    5. If you haven't completed any area yet as a test: complete one now via the app, then check
  </how-to-verify>
  <resume-signal>Reply "rpc-ok" or "rpc-broken"</resume-signal>
</task>

<task type="auto" condition="if rpc-broken">
  <name>Task 1a: Fix complete_delivery RPC</name>
  <files>index.html</files>
  <action>
    If the RPC is not writing to the deliveries table, we cannot fix the RPC itself (it lives in
    Supabase) — but we can write a workaround: after the complete_delivery RPC call succeeds,
    make a second REST call to insert directly into deliveries.

    In confirmCompletion() in index.html, after the successful RPC result check, add:
    - Read the area data (already available via targetAreas.find) to get campaign_id, team_member ids, delivery_date from the active reservation
    - POST to /rest/v1/deliveries with: campaign_id, target_area_id, team_member_1_id, team_member_2_id, delivery_date (today if not known), leaflets_delivered, notes

    This is a fallback — only implement if user reports "rpc-broken".
  </action>
  <verify>Run the SQL check again — new row should appear in deliveries</verify>
  <done>Completing an area creates a row in deliveries table</done>
</task>

<task type="auto">
  <name>Task 2: Update sumDelivered to read from deliveries table</name>
  <files>index.html</files>
  <action>
    Add a new async function loadDeliveredTotal() that fetches from the deliveries table:

    ```javascript
    async function loadDeliveredTotal() {
      try {
        const rows = await sbFetch('/rest/v1/deliveries?select=leaflets_delivered');
        const total = (rows || []).reduce((sum, r) => sum + (r.leaflets_delivered || 0), 0);
        document.getElementById('sumDelivered').textContent = total.toLocaleString();
      } catch(e) {
        // leave sumDelivered as-is if fetch fails
      }
    }
    ```

    Call loadDeliveredTotal() in the init chain (after loadAreaCards) and after every
    successful completion (after closeCompleteModal() in confirmCompletion()).

    Do NOT remove updateSummary() — it drives other stats (remaining, sessions, progress bar).
    Just stop it from setting sumDelivered. Remove the line:
      document.getElementById('sumDelivered').textContent=td.toLocaleString();
    from updateSummary() (~line 1053).
  </action>
  <verify>Complete an area and confirm sumDelivered updates with the correct leaflet count</verify>
  <done>sumDelivered shows sum from deliveries table, not session_log</done>
</task>

<task type="auto">
  <name>Task 3: Remove 1500 cap from legacy input</name>
  <files>index.html</files>
  <action>
    Find the session_log input with max="1500" at ~line 1021.
    Remove the max="1500" attribute only. Do not change anything else on that line.
  </action>
  <verify>Inspect the input element — max attribute should be gone</verify>
  <done>Legacy delivered input has no maximum limit</done>
</task>

<task type="auto">
  <name>Task 4: Add delivery journal section</name>
  <files>index.html</files>
  <action>
    Add HTML for the journal section. Place it after the stat bar div (the div containing
    id="sumDelivered") and before the existing session/financial table section.

    HTML to insert:
    ```html
    <!-- Delivery Journal -->
    <div id="deliveryJournal" style="margin-bottom:24px;">
      <h3 style="font-size:1rem;font-weight:600;color:#1a3a5c;margin-bottom:12px;">Delivery Journal</h3>
      <div id="journalList"></div>
    </div>
    ```

    Add a new async function loadDeliveryJournal():
    ```javascript
    async function loadDeliveryJournal() {
      try {
        const rows = await sbFetch(
          '/rest/v1/deliveries?select=leaflets_delivered,delivery_date,notes,created_at,target_areas(area_name),team_member_1:team_members!team_member_1_id(name),team_member_2:team_members!team_member_2_id(name)&order=created_at.desc'
        );
        const el = document.getElementById('journalList');
        if (!rows || rows.length === 0) {
          el.innerHTML = '<p style="color:#888;font-size:0.9rem;">No deliveries recorded yet.</p>';
          return;
        }
        el.innerHTML = rows.map(r => {
          const area = r.target_areas?.area_name || 'Unknown area';
          const tm1 = r.team_member_1?.name || '';
          const tm2 = r.team_member_2?.name || '';
          const team = tm2 ? tm1 + ' & ' + tm2 : tm1;
          const date = r.delivery_date || r.created_at?.slice(0,10) || '';
          const notes = r.notes ? '<span style="color:#888;font-size:0.82rem;"> — ' + r.notes + '</span>' : '';
          return '<div style="padding:8px 0;border-bottom:1px solid #eee;font-size:0.9rem;">' +
            '<strong>' + area + '</strong> &mdash; ' +
            r.leaflets_delivered.toLocaleString() + ' leaflets' +
            (team ? ' &mdash; ' + team : '') +
            ' &mdash; <span style="color:#666;">' + date + '</span>' +
            notes +
            '</div>';
        }).join('');
      } catch(e) {
        document.getElementById('journalList').innerHTML = '<p style="color:#888;font-size:0.9rem;">Could not load journal.</p>';
      }
    }
    ```

    Call loadDeliveryJournal() in the init chain (alongside loadDeliveredTotal()) and after
    every successful completion in confirmCompletion().

    Use Supabase foreign table join syntax carefully — if the join query fails, fall back to a
    simpler query without joins and omit team member names from the display.
  </action>
  <verify>Journal section appears on page with at least one completed delivery shown</verify>
  <done>Delivery journal renders below stats, shows area, leaflet count, team, date, notes</done>
</task>

</tasks>

<verification>
- [ ] SELECT * FROM deliveries has rows after completing an area
- [ ] sumDelivered stat matches sum of leaflets_delivered in deliveries table
- [ ] Legacy session_log input has no max attribute
- [ ] Journal section visible below stats, entries ordered newest-first
- [ ] Completing another area: stat updates, journal gains a new entry at top
- [ ] No JS errors in console
</verification>

<success_criteria>
- Delivery completion writes to deliveries table
- sumDelivered reads from deliveries, not session_log
- 1500 cap removed
- Journal section shows completed deliveries newest-first
- All verification checks pass
</success_criteria>

<output>
After completion, create .planning/phases/03-delivery-recording/03-01-SUMMARY.md
</output>
