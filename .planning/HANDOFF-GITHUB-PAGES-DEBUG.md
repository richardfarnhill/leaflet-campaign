# Handoff: GitHub Pages Campaign Dropdown Debug

**Date:** 2026-02-28
**Issue:** Campaign dropdown shows "Failed to Load..." in production, works in dev
**Status:** PARTIALLY FIXED — workflow deploys, but app still can't load campaigns
**URL:** https://richardfarnhill.github.io/leaflet-campaign/

---

## What Was Done

### Root Cause ✅
- `config.js` is in `.gitignore` (security: contains API credentials)
- Production build has no config → global variables `SB_URL`, `SB_KEY` undefined
- `sbFetch()` fails because it calls `fetch(undefined + path)`

### Solution Implemented ✅
1. **Created `.github/workflows/deploy.yml`**
   - Auto-generates `config.js` from GitHub Secrets at build time
   - Deploys full app (25+ MB) to GitHub Pages on each push
   - Workflow runs successfully, no errors

2. **Set up GitHub Secrets via CLI**
   - 3 secrets created: SUPABASE_URL, SUPABASE_KEY, APP_PASSWORD
   - Values in GitHub repo Settings → Secrets

3. **Fixed deployment 3 times**
   - Attempt 1: Wrong directory (416 bytes only)
   - Attempt 2: Working directory incorrect
   - Attempt 3: ✅ Success (25+ MB, correct structure)

**Latest deployment:** Commit `65e2227`, Status: SUCCESS

---

## Problem Still Exists

User reports: "Still getting 'Failed to Load' on mobile (incognito)"

**Likely causes:**
1. `config.js` not being generated → env vars not substituted in workflow
2. `config.js` has syntax error or wrong values
3. GitHub Pages caching old version
4. `sbFetch()` or global CONFIG initialization broken
5. CORS error from Supabase (check browser console)

---

## Debug Steps for Next Session

### Step 1: Check if config.js exists and has values
```bash
curl -s https://richardfarnhill.github.io/leaflet-campaign/config.js
# Should output JavaScript object with actual values, not $SBU/$SBK/$APWD
```

### Step 2: Check production with browser DevTools
- Visit https://richardfarnhill.github.io/leaflet-campaign/ (mobile incognito)
- Open DevTools → Console
- **Look for:**
  - Error: `CONFIG is not defined` → config.js not loading
  - Error about API calls → CORS/auth issue
  - Network tab → Is config.js loaded? (Status 200?)

### Step 3: Verify workflow secrets
```bash
gh secret list
# Should show SUPABASE_URL, SUPABASE_KEY, APP_PASSWORD with timestamps
```

### Step 4: Check latest workflow logs
```bash
gh run list --limit 1
gh run view [RUN_ID] --log | grep -A 20 "Generate config"
```

### Step 5: If env vars not substituted
The workflow uses shell heredoc with env vars:
```bash
cat > config.js << 'CONFEOF'
...SUPABASE_URL: '$SBU'...
CONFEOF
```
Check if `$SBU`, `$SBK`, `$APWD` are being expanded or printed literally.

---

## Key Files & Status

| File | Purpose | Status |
|------|---------|--------|
| `.github/workflows/deploy.yml` | GitHub Actions CI/CD | ✅ Created, deployed |
| `config.js` (local) | Dev config | ✅ Has credentials |
| `config.js` (production) | Generated by workflow | ❓ NEEDS VERIFICATION |
| `.planning/OPEN-ISSUES.md` | Issue OI-04 documented | ✅ Updated |
| `.planning/STATE.md` | Project state | ✅ Updated |
| `index.html` (line ~1090) | `sbFetch()` + CONFIG usage | ✅ Code looks correct |

---

## Recent Commits

- `65e2227` - fix: upload entire app directory (LATEST - SUCCESS)
- `af19bd0` - fix: use working-directory (FAILED)
- `fe00b92` - fix: generate config.js in correct directory (FAILED)
- `4feed25` - ci: Add GitHub Actions workflow (FAILED - wrong upload path)

---

## Next Agent Handoff

**Priority:** Verify that `config.js` is actually deployed with correct values

1. First: curl the production config.js and show output
2. Then: Check browser console for actual error
3. Then: Debug workflow env var substitution if needed
4. If all else fails: Consider alternative approaches (inline config in HTML, different build process)

**Status:** Infrastructure is in place. Issue is likely in execution of workflow variable substitution.
