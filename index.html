<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leaflet Campaign Tracker</title>
<script src="config.js"></script>
<script src="debug-panel.js"></script>
<script>
(function(){
  // Use config.js values with fallbacks for development
  const PASSWORD=typeof CONFIG!=='undefined'?CONFIG.APP_PASSWORD:'WillsX2025!';
  const SB_URL=typeof CONFIG!=='undefined'?CONFIG.SUPABASE_URL:'https://tjebidvgvbpnxgnphcrg.supabase.co';
  const SB_KEY=typeof CONFIG!=='undefined'?CONFIG.SUPABASE_KEY:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqZWJpZHZndmJwbnhnbnBoY3JnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0ODkyNDcsImV4cCI6MjA4NzA2NTI0N30.7MyRW330dP1ZkCqOqTykjRo6Y-cM4ow3aJ-6_H82BUY';
  const COOKIE='lct_auth',DAYS=14;
  
  function getCookie(n){return document.cookie.split(';').some(c=>c.trim().startsWith(n+'='));}
  function setCookie(n,d){const e=new Date(Date.now()+d*864e5).toUTCString();document.cookie=n+'=1;expires='+e+';path=/;SameSite=Lax';}
  if(!getCookie(COOKIE)){
    document.addEventListener('DOMContentLoaded',function(){
      document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#f0f4f8;font-family:Segoe UI,sans-serif;"><div style="background:white;padding:40px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1);text-align:center;max-width:320px;width:100%;"><div style="font-size:2rem;margin-bottom:12px;">&#128202;</div><h2 style="color:#1a3a5c;margin-bottom:6px;font-size:1.2rem;">WillSolicitor</h2><p style="color:#888;font-size:0.85rem;margin-bottom:24px;">Leaflet Campaign Tracker</p><input id="pw" type="password" placeholder="Password" style="width:100%;padding:10px 12px;border:1px solid #ccd3db;border-radius:6px;font-size:1rem;margin-bottom:12px;box-sizing:border-box;" autofocus><button onclick="checkPw()" style="width:100%;padding:10px;background:#1a3a5c;color:white;border:none;border-radius:6px;font-size:1rem;cursor:pointer;">Enter</button><p id="pwerr" style="color:#c0392b;font-size:0.82rem;margin-top:10px;display:none;">Incorrect password</p></div></div>';
      document.getElementById('pw').addEventListener('keydown',function(e){if(e.key==='Enter')checkPw();});
    });
    window.checkPw=function(){const v=document.getElementById('pw').value;if(v===PASSWORD){setCookie(COOKIE,DAYS);location.reload();}else{document.getElementById('pwerr').style.display='block';}};
  }
})();
</script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',sans-serif;background:#f0f4f8;color:#222;}
header{background:#1a3a5c;color:white;padding:20px 24px;}
header h1{font-size:1.4rem;}
header p{font-size:0.85rem;opacity:0.8;margin-top:4px;}
.sync-bar{background:#fff;border-bottom:1px solid #dde3ea;padding:6px 24px;font-size:0.75rem;color:#888;display:flex;align-items:center;gap:8px;}
.sync-dot{width:8px;height:8px;border-radius:50%;background:#ccc;flex-shrink:0;}
.sync-dot.ok{background:#27ae60;}.sync-dot.saving{background:#f39c12;}.sync-dot.err{background:#c0392b;}
.summary-bar{display:flex;flex-wrap:wrap;gap:12px;background:#fff;padding:16px 24px;border-bottom:1px solid #dde3ea;}
.stat{text-align:center;min-width:110px;}
.stat .val{font-size:1.5rem;font-weight:700;color:#1a3a5c;}
.stat .lbl{font-size:0.72rem;color:#666;text-transform:uppercase;letter-spacing:0.04em;}
.progress-bar-wrap{flex:1 1 200px;display:flex;align-items:center;gap:10px;}
.progress-bar{flex:1;height:14px;background:#dde3ea;border-radius:7px;overflow:hidden;}
.progress-bar-fill{height:100%;background:#2e86ab;border-radius:7px;transition:width 0.4s;}
.main{padding:20px 24px;}
h2{font-size:1rem;color:#1a3a5c;margin-bottom:12px;margin-top:24px;}
.week-block{margin-bottom:28px;}
.week-label{font-size:0.78rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#888;margin-bottom:8px;}
.session-card{background:white;border-radius:10px;padding:14px 16px;margin-bottom:12px;border-left:5px solid #2e86ab;box-shadow:0 1px 4px rgba(0,0,0,0.07);}
.session-card.complete{border-left-color:#27ae60;}
.session-card.partial{border-left-color:#f39c12;}
.session-card.future{border-left-color:#bbb;}
.session-card.missed{border-left-color:#c0392b;background:#fff8f8;}
.session-card.rescheduled{border-left-color:#8e44ad;}
.session-header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px;}
.session-date{font-weight:700;font-size:0.95rem;min-width:130px;}
.session-area{font-size:0.9rem;color:#444;flex:1;}
.session-target{font-size:0.82rem;color:#888;white-space:nowrap;}
.badge{font-size:0.7rem;padding:2px 8px;border-radius:10px;font-weight:600;}
.badge-complete{background:#d5f5e3;color:#1e8449;}
.badge-partial{background:#fef9e7;color:#b7770d;}
.badge-future{background:#f2f2f2;color:#888;}
.badge-missed{background:#fde8e8;color:#c0392b;}
.badge-rescheduled{background:#f3e8fd;color:#8e44ad;}

/* Area Cards (Phase 2) */
.area-cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-bottom:24px;}
.area-card{background:white;border-radius:10px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border-left:5px solid #ccc;transition:transform 0.2s,box-shadow 0.2s;}
.area-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.12);}
.area-card.available{border-left-color:#27ae60;}
.area-card.reserved{border-left-color:#f39c12;}
.area-card.completed{border-left-color:#2e86ab;}
.area-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;}
.area-card-title{font-size:1rem;font-weight:700;color:#1a3a5c;flex:1;}
.area-card-postcode{font-size:0.8rem;color:#888;margin-top:2px;}
.area-card-badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:0.7rem;font-weight:700;text-transform:uppercase;}
.area-card-badge.available{background:#e8f8f0;color:#27ae60;}
.area-card-badge.reserved{background:#fef5e7;color:#f39c12;}
.area-card-badge.completed{background:#e8f4f8;color:#2e86ab;}
.area-card-stats{display:flex;gap:16px;margin:12px 0;padding:10px 0;border-top:1px solid #eee;border-bottom:1px solid #eee;}
.area-card-stat{text-align:center;}
.area-card-stat-val{font-size:1.2rem;font-weight:700;color:#1a3a5c;}
.area-card-stat-lbl{font-size:0.65rem;color:#888;text-transform:uppercase;}
.area-card-team{font-size:0.85rem;color:#444;margin-bottom:8px;}
.area-card-team strong{color:#1a3a5c;}
.area-card-date{font-size:0.8rem;color:#888;}
.area-card-actions{margin-top:12px;display:flex;gap:8px;}
.area-card-btn{flex:1;padding:8px 12px;border:1px solid #ccd3db;border-radius:6px;font-size:0.85rem;cursor:pointer;transition:background 0.2s;background:#f0f4f8;color:#1a3a5c;}
.area-card-btn:hover{background:#dde4ed;}
.area-card-btn.view-active{background:#1a3a5c;color:white;border-color:#1a3a5c;}
.area-card-btn.reserve{background:#27ae60;color:white;}
.area-card-btn.reserve:hover{background:#219a52;}
.area-card-btn.complete{background:#2e86ab;color:white;}
.area-card-btn.complete:hover{background:#2573a7;}
.area-card-btn.reassign{background:#f39c12;color:white;}
.area-card-btn.reassign:hover{background:#e67e22;}
.area-card-btn.unassign{background:#e74c3c;color:white;}
.area-card-btn.unassign:hover{background:#c0392b;}
.area-card-btn:disabled{background:#ccc;cursor:not-allowed;}

/* Campaign Selector */
.campaign-selector{display:flex;align-items:center;gap:12px;margin-top:8px;}
.campaign-selector label{font-size:0.8rem;color:rgba(255,255,255,0.8);}
.campaign-selector select{background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:white;padding:6px 12px;border-radius:6px;font-size:0.9rem;}
.campaign-selector select option{color:black;background:white;}

/* Modal */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;display:none;}
.modal-overlay.active{display:flex;}
.modal{background:white;border-radius:12px;padding:24px;max-width:400px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.2);}
.modal h3{color:#1a3a5c;margin:0 0 16px 0;font-size:1.2rem;}
.modal-field{margin-bottom:16px;}
.modal-field label{display:block;font-size:0.8rem;color:#666;margin-bottom:6px;font-weight:600;}
.modal-field select,.modal-field input{width:100%;padding:10px;border:1px solid #ccd3db;border-radius:6px;font-size:0.95rem;}
.modal-actions{display:flex;gap:10px;margin-top:20px;}
.modal-btn{flex:1;padding:10px;border:none;border-radius:6px;font-size:0.95rem;cursor:pointer;transition:background 0.2s;}
.modal-btn.confirm{background:#27ae60;color:white;}
.modal-btn.confirm:hover{background:#219a52;}
.modal-btn.cancel{background:#eee;color:#333;}
.modal-btn.cancel:hover{background:#ddd;}
.modal-btn:disabled{background:#ccc;cursor:not-allowed;}
.modal-error{color:#c0392b;font-size:0.85rem;margin-top:10px;display:none;}
.modal-error.show{display:block;}
.briefing{background:#f7faff;border:1px solid #d0e4f5;border-radius:8px;padding:10px 14px;margin-bottom:10px;font-size:0.82rem;line-height:1.6;color:#333;}
.briefing strong{color:#1a3a5c;}
.went-out-row{display:flex;align-items:center;gap:8px;margin-bottom:10px;font-size:0.85rem;color:#444;padding:6px 10px;background:#f7f9fc;border-radius:6px;border:1px solid #e0e6ed;}
.went-out-row input[type=checkbox]{width:16px;height:16px;accent-color:#1a3a5c;cursor:pointer;}
.session-fields{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;}
.field{display:flex;flex-direction:column;gap:3px;}
.field label{font-size:0.72rem;color:#888;font-weight:600;text-transform:uppercase;}
.field input,.field select{border:1px solid #ccd3db;border-radius:6px;padding:5px 8px;font-size:0.85rem;background:#fafbfc;}
.field select{width:140px;}
.field input[type=number]{width:110px;}
.field input[type=text]{width:220px;}
.field input:focus,.field select:focus{outline:none;border-color:#2e86ab;background:#fff;}
.warn{color:#c0392b;font-weight:600;}
.good{color:#1e8449;font-weight:600;}
.finance-section{background:white;border-radius:10px;padding:18px;margin-bottom:20px;box-shadow:0 1px 4px rgba(0,0,0,0.07);}
.finance-inputs{display:flex;flex-wrap:wrap;gap:14px;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #eee;}
.finance-table{width:100%;border-collapse:collapse;font-size:0.85rem;}
.finance-table th{background:#1a3a5c;color:white;padding:8px 10px;text-align:left;}
.finance-table td{padding:8px 10px;border-bottom:1px solid #eee;}
.finance-table tr:last-child td{border-bottom:none;}
.finance-table td.highlight{font-weight:700;color:#1a3a5c;}
.actual-row td{background:#eafaf1;}
footer{text-align:center;font-size:0.72rem;color:#aaa;padding:20px;}
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <h1>&#128202; WillSolicitor &mdash; Leaflet Campaign Tracker</h1>
  <div class="campaign-selector">
    <label>Campaign:</label>
    <select id="campaignSelect" style="color:white;"><option value="">Loading...</option></select>
    <button onclick="openCampaignConfig()" style="background:none;border:none;cursor:pointer;font-size:1.1rem;padding:2px 6px;" title="Configure Campaign">&#9881;</button>
    <button onclick="openNewCampaignModal()" style="background:#27ae60;color:white;padding:4px 10px;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;font-weight:600;">+ New</button>
  </div>
</header>
<div class="sync-bar"><div class="sync-dot" id="syncDot"></div><span id="syncMsg">Connecting&hellip;</span></div>
<div class="summary-bar">
  <div class="stat"><div class="val" id="sumDelivered">0</div><div class="lbl">Delivered</div></div>
  <div class="stat"><div class="val" id="sumRemaining">20,000</div><div class="lbl">Remaining</div></div>
  <div class="stat"><div class="val" id="sumSessions">0</div><div class="lbl">Sessions Done</div></div>
  <div class="stat"><div class="val" id="sumProjected">&mdash;</div><div class="lbl">Est. Completion</div></div>
  <div class="progress-bar-wrap">
    <div class="progress-bar"><div class="progress-bar-fill" id="progressFill" style="width:0%"></div></div>
    <span id="progressPct" style="font-size:0.85rem;font-weight:700;color:#1a3a5c">0%</span>
  </div>
</div>
<div class="main">
  <!-- Phase 4: View Toggle -->
  <div style="display:flex;gap:8px;margin-bottom:16px;">
    <button onclick="showView('cards')" class="area-card-btn" id="viewBtnCards">Routes</button>
    <button onclick="showView('map')" class="area-card-btn" id="viewBtnMap">Map</button>
    <button onclick="showView('analytics')" class="area-card-btn" id="viewBtnAnalytics">Analytics</button>
  </div>

  <!-- Phase 2: Area Cards -->
  <div id="cardsView">
    <h2 style="margin-top:0;">Delivery Routes</h2>
    <p style="font-size:0.85rem;color:#666;margin-bottom:16px;">Click "Reserve" to claim a route for delivery. Completed routes show delivery stats.</p>
    <div id="areaCards" class="area-cards-grid">
      <div style="grid-column:1/-1;text-align:center;padding:40px;color:#888;">Loading routes...</div>
    </div>
  </div>

  <!-- Phase 4: Map View -->
  <div id="mapView" style="display:none;height:500px;border-radius:8px;overflow:hidden;margin-bottom:24px;">
    <div id="heatmapContainer" style="height:100%;"></div>
  </div>

  <!-- Phase 4: Analytics View -->
  <div id="analyticsView" style="display:none;">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
      <div style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <h3 style="margin:0 0 12px 0;font-size:1rem;">Deliveries Over Time</h3>
        <canvas id="chartDeliveries"></canvas>
      </div>
      <div style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <h3 style="margin:0 0 12px 0;font-size:1rem;">Revenue Over Time</h3>
        <canvas id="chartRevenue"></canvas>
      </div>
    </div>
    <div style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:24px;">
      <h3 style="margin:0 0 12px 0;font-size:1rem;">Enquiries by Day</h3>
      <canvas id="chartEnquiries"></canvas>
    </div>
    <div style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:24px;">
      <h3 style="margin:0 0 4px 0;font-size:1rem;">Overall Completion Rate</h3>
      <p style="font-size:2rem;font-weight:700;color:#2563eb;margin:0;" id="overallCompletionRate">‚Äî</p>
    </div>
    <!-- T5: Campaign breakdown ‚Äî only visible in All Campaigns mode -->
    <div id="campaignBreakdown" style="display:none;background:#fff;padding:16px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:24px;">
      <h3 style="margin:0 0 12px 0;font-size:1rem;">Campaign Breakdown</h3>
      <table style="width:100%;border-collapse:collapse;font-size:0.9rem;">
        <thead><tr style="border-bottom:2px solid #e5e7eb;">
          <th style="text-align:left;padding:6px 8px;">Campaign</th>
          <th style="text-align:right;padding:6px 8px;">Target</th>
          <th style="text-align:right;padding:6px 8px;">Delivered</th>
          <th style="text-align:right;padding:6px 8px;">Remaining</th>
          <th style="text-align:right;padding:6px 8px;">Progress</th>
        </tr></thead>
        <tbody id="campaignBreakdownBody"></tbody>
      </table>
    </div>

    <!-- Phase 6: Team Progress -->
    <div id="teamProgressSection" style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:24px;">
      <h3 style="margin:0 0 12px 0;font-size:1rem;">Team Progress</h3>
      <div id="teamProgressList"><p style="color:#888;font-size:0.9rem;">Loading...</p></div>
    </div>
  </div>
  
  <!-- Phase 3: Delivery Journal -->
  <div id="deliveryJournal" style="margin-bottom:24px;">
    <h2 style="margin-bottom:12px;">Delivery Journal</h2>
    <div id="journalList"><p style="color:#888;font-size:0.9rem;">Loading...</p></div>
  </div>

  <!-- Phase 6: Enquiries -->
  <div id="enquiriesSection" style="margin-bottom:24px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h2 style="margin:0;">Enquiries</h2>
      <button id="recordEnquiryBtn" onclick="openEnquiryModal()" style="background:#8b5cf6;color:#fff;padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:0.9rem;">+ Record Enquiry</button>
    </div>
    <div id="enquiryList"><p style="color:#888;font-size:0.9rem;">Loading...</p></div>
  </div>

  <h2>Financial Projections</h2>
  <div class="finance-section">
    <div class="finance-inputs">
      <div class="field"><label>Enquiries Received</label><input type="number" id="fi_enquiries" min="0" placeholder="0" style="width:140px"></div>
      <div class="field"><label>Cases Instructed</label><input type="number" id="fi_cases" min="0" placeholder="0" style="width:140px"></div>
      <div class="field"><label>Total Instruction Value (&pound;)</label><input type="number" id="fi_instrvalue" min="0" placeholder="0" style="width:160px"></div>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:16px;background:#f7faff;border:1px solid #d0e4f5;border-radius:8px;padding:12px 16px;margin-bottom:16px;font-size:0.82rem;">
      <div><span style="color:#888">Avg case value:</span> <strong id="dm_avgcase">&mdash;</strong></div>
      <div><span style="color:#888">Enquiry&rarr;instruction rate:</span> <strong id="dm_convrate">&mdash;</strong></div>
      <div><span style="color:#888">Revenue per 100 leaflets:</span> <strong id="dm_per100">&mdash;</strong></div>
      <div><span style="color:#888">Revenue per enquiry:</span> <strong id="dm_perenquiry">&mdash;</strong></div>
      <div><span style="color:#888">Leaflets per case:</span> <strong id="dm_percase">&mdash;</strong></div>
    </div>
    <table class="finance-table">
      <thead><tr><th>Scenario</th><th>Response Rate</th><th>Enquiries so far</th><th>Enquiries remaining</th><th>Total proj. enquiries</th><th>Total proj. revenue</th></tr></thead>
      <tbody>
        <tr class="actual-row"><td><strong>&#9989; Actual to date</strong></td><td id="fa_rate">&mdash;</td><td id="fa_enquiries" colspan="2">&mdash;</td><td id="fa_cases">&mdash;</td><td id="fa_revenue" class="highlight">&mdash;</td></tr>
        <tr id="f_extrap_row" style="display:none;background:#fff8e1;"><td><strong>&#128200; Extrapolated (actual rate)</strong></td><td id="f_ext_rate">&mdash;</td><td id="f_ext_sofar">&mdash;</td><td id="f_ext_todo">&mdash;</td><td id="f_ext_total">&mdash;</td><td id="f_ext_rev" class="highlight" style="color:#b7770d;font-weight:700;">&mdash;</td></tr>
        <tr><td>Conservative</td><td>0.25%</td><td id="f1_sofar">&mdash;</td><td id="f1_todo">&mdash;</td><td id="f1_total">&mdash;</td><td id="f1_rev" class="highlight">&mdash;</td></tr>
        <tr><td>Target</td><td>0.5%</td><td id="f2_sofar">&mdash;</td><td id="f2_todo">&mdash;</td><td id="f2_total">&mdash;</td><td id="f2_rev" class="highlight">&mdash;</td></tr>
        <tr><td>Optimistic</td><td>1.0%</td><td id="f3_sofar">&mdash;</td><td id="f3_todo">&mdash;</td><td id="f3_total">&mdash;</td><td id="f3_rev" class="highlight">&mdash;</td></tr>
      </tbody>
    </table>
    <p style="font-size:0.72rem;color:#999;margin-top:8px">Default case value &pound;294.42 until real data is entered.</p>
  </div>
</div>
<footer>Live data &middot; Supabase &middot; WillSolicitor Leaflet Campaign</footer>

<!-- Reserve Modal -->
<div id="reserveModal" class="modal-overlay">
  <div class="modal">
    <h3>Reserve Area</h3>
    <div class="modal-field">
      <label>Area</label>
      <input type="text" id="reserveAreaName" readonly>
    </div>
    <div class="modal-field">
      <label>Team Member</label>
      <select id="reserveTeamMember">
        <option value="">Select team member...</option>
      </select>
    </div>
    <div class="modal-field">
      <label>Second Team Member (optional)</label>
      <select id="reserveTeamMember2">
        <option value="">Select second team member...</option>
      </select>
    </div>
    <div class="modal-field">
      <label>Delivery Date</label>
      <input type="date" id="reserveDate">
    </div>
    <div class="modal-error" id="reserveError"></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeReserveModal()">Cancel</button>
      <button class="modal-btn confirm" id="reserveConfirmBtn" onclick="confirmReservation()">Reserve</button>
    </div>
  </div>
</div>

<!-- Complete Modal -->
<div id="completeModal" class="modal-overlay">
  <div class="modal">
    <h3>Complete Delivery</h3>
    <div class="modal-field">
      <label>Area</label>
      <input type="text" id="completeAreaName" readonly>
    </div>
    <div class="modal-field">
      <label>Leaflets Delivered</label>
      <input type="number" id="completeLeaflets" min="0" placeholder="Enter leaflet count">
    </div>
    <div class="modal-field">
      <label>Notes (optional)</label>
      <input type="text" id="completeNotes" placeholder="Any notes...">
    </div>
    <div class="modal-error" id="completeError"></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeCompleteModal()">Cancel</button>
      <button class="modal-btn confirm" id="completeConfirmBtn" onclick="confirmCompletion()">Mark Complete</button>
    </div>
  </div>
</div>

<!-- Reassign Modal -->
<div id="reassignModal" class="modal-overlay">
  <div class="modal">
    <h3>Reassign Area</h3>
    <div class="modal-field">
      <label>Area</label>
      <input type="text" id="reassignAreaName" readonly>
    </div>
    <div class="modal-field">
      <label>Team Member 1</label>
      <input type="text" id="reassignCurrentMember" readonly>
    </div>
    <div class="modal-field">
      <label>Team Member 2 (optional)</label>
      <input type="text" id="reassignCurrentMember2" readonly>
    </div>
    <div class="modal-field">
      <label>Reassign Team Member 1 To</label>
      <select id="reassignNewMember">
        <option value="">Select new team member...</option>
      </select>
    </div>
    <div class="modal-field">
      <label>Reassign Team Member 2 To</label>
      <select id="reassignNewMember2">
        <option value="">Select new team member or leave empty...</option>
      </select>
    </div>
    <div class="modal-error" id="reassignError"></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeReassignModal()">Cancel</button>
      <button class="modal-btn confirm" id="reassignConfirmBtn" onclick="confirmReassignment()">Reassign</button>
    </div>
  </div>
</div>

<!-- Unassign Modal -->
<div id="unassignModal" class="modal-overlay">
  <div class="modal">
    <h3>Unassign Area</h3>
    <div class="modal-field">
      <label>Area</label>
      <input type="text" id="unassignAreaName" readonly>
    </div>
    <p style="font-size:0.85rem;color:#666;margin-bottom:8px;">This will release the reservation and make the area available again.</p>
    <div class="modal-error" id="unassignError"></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeUnassignModal()">Cancel</button>
      <button class="modal-btn confirm" id="unassignConfirmBtn" onclick="confirmUnassign()">Unassign</button>
    </div>
  </div>
</div>

<!-- New Campaign Modal -->
<div id="newCampaignModal" class="modal-overlay">
  <div class="modal">
    <h3>New Campaign</h3>
    <div class="modal-field">
      <label>Campaign Name</label>
      <input type="text" id="newCampaignName" placeholder="e.g. Wilmslow Spring 2026">
    </div>
    <div class="modal-field">
      <label>Target Leaflets</label>
      <input type="number" id="newCampaignTarget" placeholder="30000">
    </div>
    <div class="modal-field">
      <label>Start Date</label>
      <input type="date" id="newCampaignStart">
    </div>
    <div class="modal-field">
      <label>End Date</label>
      <input type="date" id="newCampaignEnd">
    </div>
    <div class="modal-error" id="newCampaignError"></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeNewCampaignModal()">Cancel</button>
      <button class="modal-btn confirm" id="newCampaignConfirmBtn" onclick="saveNewCampaign()">Create</button>
    </div>
  </div>
</div>

<!-- Campaign Config Modal -->
<div id="campaignConfigModal" class="modal-overlay">
  <div class="modal">
    <h3>Configure Campaign</h3>
    <div class="modal-field">
      <label>Campaign Name</label>
      <input type="text" id="configCampaignName">
    </div>
    <div class="modal-field">
      <label>Target Leaflets</label>
      <input type="number" id="configTargetLeaflets">
    </div>
    <div class="modal-field">
      <label>Start Date</label>
      <input type="date" id="configStartDate">
    </div>
    <div class="modal-field">
      <label>End Date</label>
      <input type="date" id="configEndDate">
    </div>
    <div class="modal-field">
      <label>Response Rate Overrides (leave blank to use defaults: 0.25% / 0.5% / 1.0%)</label>
      <div style="display:flex;gap:8px;align-items:center;">
        <input type="number" step="0.01" id="configRateConservative" placeholder="0.25" style="width:80px;">%
        <input type="number" step="0.01" id="configRateTarget" placeholder="0.50" style="width:80px;">%
        <input type="number" step="0.01" id="configRateOptimistic" placeholder="1.00" style="width:80px;">%
      </div>
    </div>
    <div class="modal-field">
      <label>Default Case Value Override (¬£) (leave blank to use ¬£294.42)</label>
      <input type="number" step="0.01" id="configDefaultCaseValue" placeholder="294.42">
    </div>
    <div class="modal-field">
      <label>Restricted Areas <small style="font-weight:normal;color:#888;">(global ‚Äî applies to all campaigns)</small></label>
      <div id="restrictedAreasList" style="margin-bottom:8px;font-size:0.85rem;"></div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
        <input type="text" id="newRestrictedPostcode" placeholder="Postcode (e.g. WA14)" style="width:130px;padding:6px 8px;border:1px solid #ccd3db;border-radius:6px;font-size:0.85rem;">
        <input type="number" id="newRestrictedRadius" placeholder="Radius (mi)" step="0.1" min="0" style="width:110px;padding:6px 8px;border:1px solid #ccd3db;border-radius:6px;font-size:0.85rem;">
        <input type="text" id="newRestrictedLabel" placeholder="Label (optional)" style="width:120px;padding:6px 8px;border:1px solid #ccd3db;border-radius:6px;font-size:0.85rem;">
        <button onclick="addRestrictedArea()" style="padding:6px 12px;background:#1a3a5c;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:0.85rem;">+ Add</button>
      </div>
    </div>
    <div class="modal-error" id="configError"></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeCampaignConfig()">Cancel</button>
      <button class="modal-btn confirm" id="configConfirmBtn" onclick="saveCampaignConfig()">Save</button>
    </div>
  </div>
</div>

<!-- Edit Delivery Modal -->
<div id="editDeliveryModal" class="modal-overlay">
  <div class="modal">
    <h3>Edit Delivery</h3>
    <div class="modal-field">
      <label>Date</label>
      <input type="date" id="editDeliveryDate">
    </div>
    <div class="modal-field">
      <label>Leaflets Delivered</label>
      <input type="number" id="editLeafletsDelivered">
    </div>
    <div class="modal-field">
      <label>Team Member 1</label>
      <select id="editTeamMember1"><option value="">Select...</option></select>
    </div>
    <div class="modal-field">
      <label>Team Member 2</label>
      <select id="editTeamMember2"><option value="">Select...</option></select>
    </div>
    <div class="modal-field">
      <label>Notes</label>
      <input type="text" id="editDeliveryNotes">
    </div>
    <div class="modal-error" id="editDeliveryError"></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeEditDelivery()">Cancel</button>
      <button class="modal-btn confirm" id="editDeliveryConfirmBtn" onclick="saveEditDelivery()">Save</button>
    </div>
  </div>
</div>

<!-- Enquiry Modal -->
<div id="enquiryModal" class="modal-overlay">
  <div class="modal">
    <h3 id="enquiryModalTitle">Record Enquiry</h3>
    <div class="modal-field">
      <label>Client Name</label>
      <input type="text" id="enquiryClientName" placeholder="Optional">
    </div>
    <div class="modal-field">
      <label>Postcode *</label>
      <input type="text" id="enquiryPostcode" placeholder="e.g. WA14 2LY" required>
    </div>
    <div class="modal-field">
      <label>Route</label>
      <select id="enquiryRoute"><option value="">Select...</option></select>
    </div>
    <div class="modal-field">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="enquiryInstructed" style="width:auto;">
        Instructed?
      </label>
    </div>
    <div class="modal-field" id="enquiryValueField" style="display:none;">
      <label>Instruction Value (&pound;)</label>
      <input type="number" id="enquiryInstructionValue" placeholder="e.g. 2500" min="0">
    </div>
    <div class="modal-field">
      <label>Notes</label>
      <textarea id="enquiryNotes" rows="2" placeholder="Optional"></textarea>
    </div>
    <div class="modal-error" id="enquiryError"></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeEnquiryModal()">Cancel</button>
      <button class="modal-btn confirm" id="enquiryConfirmBtn" onclick="saveEnquiry()">Save</button>
    </div>
  </div>
</div>

<script>
// Read Supabase config from CONFIG (loaded by config.js)
const SB_URL=typeof CONFIG!=='undefined'?CONFIG.SUPABASE_URL:'';
const SB_KEY=typeof CONFIG!=='undefined'?CONFIG.SUPABASE_KEY:'';
// ============================================================
// DEBUG LOGGER - Traffic Light System
// ============================================================
const Logger={
  // Traffic light colors
  GREEN:'\x1b[32m',  // Success
  YELLOW:'\x1b[33m',  // Warning  
  RED:'\x1b[31m',    // Error
  BLUE:'\x1b[34m',    // Info
  RESET:'\x1b[0m',
  
  // Visual icons
  SUCCESS:'üü¢',
  WARNING:'üü°',
  ERROR:'üî¥',
  INFO:'üîµ',
  
  // Logging methods with visual indicators
  success(msg,data){
    console.log(`${this.SUCCESS} SUCCESS: ${msg}`,data||'');
    this.updateStatusIndicator('ok',msg);
  },
  warn(msg,data){
    console.warn(`${this.WARNING} WARNING: ${msg}`,data||'');
    this.updateStatusIndicator('saving',msg);
  },
  error(msg,data){
    console.error(`${this.ERROR} ERROR: ${msg}`,data||'');
    this.updateStatusIndicator('err',msg);
  },
  info(msg,data){
    console.log(`${this.INFO} INFO: ${msg}`,data||'');
  },
  
  // Update the sync status indicator in the UI
  updateStatusIndicator(status,msg){
    const dot=document.getElementById('syncDot');
    const txt=document.getElementById('syncMsg');
    if(dot){
      dot.className='sync-dot '+status;
    }
    if(txt){
      txt.textContent=msg||(status==='ok'?'Live':status);
    }
  }
};

// Global error handler
window.onerror=function(msg,url,line,col,error){
  Logger.error('Uncaught error',{msg,line,col,error:error?.message});
  return false;
};

window.onunhandledrejection=function(event){
  Logger.error('Unhandled promise rejection',{reason:event.reason});
};

Logger.info('App starting...');

const TOTAL=20000,DEFAULT_CV=294.42,DAILY_TARGET=1000;
// STAFF removed - teamMembers loaded dynamically from team_members table
// Campaign rate/CV overrides (null = use hardcoded fallbacks above)
let campaignRates={conservative:null,target:null,optimistic:null,defaultCaseValue:null};

const BASE=[
{id:1,dateISO:'2026-02-24',week:'Week 1',area:'Wilmslow \u2014 Dean Row (kickoff)',postcode:'SK9 2BY',target:500,briefing:'<strong>Park:</strong> Summerfields Village, Dean Row Road SK9 2BY.<br><strong>Task:</strong> Post a WillSolicitor leaflet through every letterbox around Summerfields Village.<br><strong>Streets:</strong> Dean Row Road, Adlington Road, Moor Lane and surrounding cul-de-sacs.<br><strong>Target:</strong> 500 leaflets. Half day \u2014 finish by 12:30pm.'},
{id:2,dateISO:'2026-02-25',week:'Week 1',area:'Wilmslow \u2014 Dean Row (continued)',postcode:'SK9 2BY',target:1000,briefing:'<strong>Park:</strong> Summerfields Village SK9 2BY.<br><strong>Task:</strong> Continue from Tuesday. Cover remaining Dean Row streets.<br><strong>Streets:</strong> Check Tuesday notes. Continue into Deanway, Hawthorn Lane and south toward the A34.<br><strong>Target:</strong> 1,000 leaflets.'},
{id:3,dateISO:'2026-02-26',week:'Week 1',area:'Wilmslow \u2192 Lacey Green (transition)',postcode:'SK9 5BP',target:1000,briefing:'<strong>Park:</strong> Morning: Dean Row SK9 2BY. Afternoon: Twinnies Road SK9 5BP.<br><strong>Task:</strong> Finish Dean Row in the morning, start Lacey Green in the afternoon.<br><strong>Streets:</strong> Finish Dean Row, then Twinnies Road and surrounding avenues.<br><strong>Target:</strong> 1,000 combined.'},
{id:4,dateISO:'2026-02-27',week:'Week 1',area:'Wilmslow \u2014 Lacey Green',postcode:'SK9 5BP',target:1000,briefing:'<strong>Park:</strong> Twinnies Road SK9 5BP.<br><strong>Task:</strong> Complete Lacey Green from where Thursday left off.<br><strong>Streets:</strong> Check Thursday notes. Work south and east through remaining avenues.<br><strong>Target:</strong> 1,000 leaflets.'},
{id:5,dateISO:'2026-03-03',week:'Week 2',area:'Knutsford \u2014 Mobberley Village',postcode:'WA16 7HE',target:1000,briefing:'<strong>Park:</strong> Town Lane, Mobberley WA16 7HE near the church.<br><strong>Task:</strong> Cover Mobberley village. Houses grouped together, very efficient.<br><strong>Streets:</strong> Town Lane, Church Lane, Knutsford Road, Ilford Mill Lane and cul-de-sacs.<br><strong>Target:</strong> 1,000 leaflets.'},
{id:6,dateISO:'2026-03-04',week:'Week 2',area:'Knutsford \u2014 Cross Town (Manor Park)',postcode:'WA16 8DB',target:1000,briefing:'<strong>Park:</strong> Manor Park North, Knutsford WA16 8DB.<br><strong>Task:</strong> Grid-pattern streets, excellent density.<br><strong>Streets:</strong> Manor Park North, Manor Park South, Bexton Road and surrounding closes.<br><strong>Target:</strong> 1,000 leaflets.'},
{id:7,dateISO:'2026-03-05',week:'Week 2',area:'Knutsford \u2014 Cross Town (completion)',postcode:'WA16 8DB',target:1000,briefing:'<strong>Park:</strong> Continue from Wednesday in WA16 8DB.<br><strong>Task:</strong> Complete Knutsford Cross Town.<br><strong>Streets:</strong> From Wednesday notes, continue toward Chelford Road and the southern edge.<br><strong>Target:</strong> 1,000 leaflets. Knutsford complete!'},
{id:8,dateISO:'2026-03-10',week:'Week 3',area:'Lymm \u2014 Booths Hill',postcode:'WA13 0DL',target:1000,briefing:'<strong>Park:</strong> Booths Hill Road, Lymm WA13 0DL near Barsbank Lane junction.<br><strong>Task:</strong> Start Lymm. Affluent village, ideal households for Wills.<br><strong>Streets:</strong> Barsbank Lane end, east into Booths Hill Road, Elm Tree Avenue, Cherry Lane.<br><strong>Target:</strong> 1,000 leaflets.'},
{id:9,dateISO:'2026-03-11',week:'Week 3',area:'Lymm \u2014 Booths Hill to Statham',postcode:'WA13 9BP',target:1000,briefing:'<strong>Park:</strong> Continue from Tuesday. Statham: Statham Lane WA13 9BP.<br><strong>Task:</strong> Continue west through Lymm toward Statham hamlet.<br><strong>Streets:</strong> From Tuesday notes, complete Booths Hill then Statham Lane.<br><strong>Target:</strong> 1,000 leaflets.'},
{id:10,dateISO:'2026-03-12',week:'Week 3',area:'Lymm (mop-up) \u2192 Poynton West (start)',postcode:'SK12 1RE',target:1000,briefing:'<strong>Park:</strong> Morning: Lymm WA13. Afternoon: Park Lane, Poynton SK12 1RE.<br><strong>Task:</strong> Finish Lymm in the morning, start Poynton West (Bird Estate) in the afternoon.<br><strong>Bird Estate:</strong> Avenues named after birds \u2014 Robin Drive, Wren Close etc. Flat and fast.<br><strong>Target:</strong> 1,000 combined.'},
{id:11,dateISO:'2026-03-17',week:'Week 4',area:'Poynton \u2014 West (Bird Estate)',postcode:'SK12 1RE',target:1000,briefing:'<strong>Park:</strong> Park Lane, Poynton SK12 1RE.<br><strong>Task:</strong> Full day on the Bird Estate. Flat, short paths, fast progress.<br><strong>Streets:</strong> Linnet Drive, Robin Drive, Wren Close, Mallard Close, Kestrel Avenue. Stay west of A523.<br><strong>Target:</strong> 1,000 leaflets.'},
{id:12,dateISO:'2026-03-18',week:'Week 4',area:'Poynton (finish) \u2192 Cheadle Hulme (start)',postcode:'SK8 7NB',target:1000,briefing:'<strong>Park:</strong> Morning: SK12. Afternoon: Grove Lane, Cheadle Hulme SK8 7NB.<br><strong>Task:</strong> Wrap up Poynton West, then start Cheadle Hulme South.<br><strong>Cheadle Hulme:</strong> 3,500 homes, 1930s semis. Classic owner-occupied family houses.<br><strong>Target:</strong> 1,000 across both areas.'},
{id:13,dateISO:'2026-03-19',week:'Week 4',area:'Cheadle Hulme \u2014 South (Grove Lane)',postcode:'SK8 7NB',target:1000,briefing:'<strong>Park:</strong> Grove Lane SK8 7NB near Turves Road junction.<br><strong>Task:</strong> Full day in Cheadle Hulme South.<br><strong>Streets:</strong> From Wednesday notes. Continue into Turves Road, Gillbent Road and branching avenues.<br><strong>Target:</strong> 1,000 leaflets. Keep precise notes of last street.'},
{id:14,dateISO:'2026-03-24',week:'Week 5',area:'Cheadle Hulme \u2014 South (toward Bramhall border)',postcode:'SK8 7NB',target:1000,briefing:'<strong>Park:</strong> Continue from Thursday SK8 7NB.<br><strong>Task:</strong> Second full day in Cheadle Hulme South, pushing toward the Bramhall border.<br><strong>Streets:</strong> From Thursday notes, continue toward Bramhall Lane South.<br><strong>Target:</strong> 1,000 leaflets.'},
{id:15,dateISO:'2026-03-25',week:'Week 5',area:'Cheadle Hulme (complete) \u2192 East Didsbury (start)',postcode:'M20 5NP',target:1000,briefing:'<strong>Park:</strong> Morning: SK8. Afternoon: Parrs Wood Road, East Didsbury M20 5NP.<br><strong>Task:</strong> Finish Cheadle Hulme then start East Didsbury.<br><strong>East Didsbury:</strong> Streets between Parrs Wood Road and Kingsway \u2014 Victorian and Edwardian terraces.<br><strong>Target:</strong> 1,000 across both areas.'},
{id:16,dateISO:'2026-03-26',week:'Week 5',area:'East Didsbury \u2014 Parrs Wood area',postcode:'M20 5NP',target:1000,briefing:'<strong>Park:</strong> Parrs Wood Road M20 5NP.<br><strong>Task:</strong> Full day in East Didsbury. Popular suburb, good professional households.<br><strong>Streets:</strong> Continue from Wednesday: Dene Road, Willoughby Avenue, Sandringham Road.<br><strong>Target:</strong> 1,000 leaflets.'},
{id:17,dateISO:'2026-03-31',week:'Week 6',area:'East Didsbury \u2014 completion',postcode:'M20 5NP',target:1000,briefing:'<strong>Park:</strong> Continue from Thursday M20 5NP.<br><strong>Task:</strong> Complete East Didsbury.<br><strong>Streets:</strong> From Thursday notes. If done early, extend north toward roads south of Lapwing Lane.<br><strong>Target:</strong> 1,000 leaflets. East Didsbury complete!'},
{id:18,dateISO:'2026-04-01',week:'Week 6',area:'Handforth \u2014 South (Hall Road / Spath Lane)',postcode:'SK9 3AD',target:1000,briefing:'<strong>Park:</strong> Hall Road, Handforth SK9 3AD.<br><strong>Task:</strong> Private housing in southern Handforth near the Wilmslow border.<br><strong>Streets:</strong> Hall Road, Spath Lane, The Bollin and avenues toward Wilmslow border. Do NOT head north toward A34.<br><strong>Target:</strong> 1,000 leaflets.'},
{id:19,dateISO:'2026-04-02',week:'Week 6',area:'Mop-up Day \u2014 Handforth / Wilmslow border',postcode:'SK9 3AD',target:500,briefing:'<strong>Park:</strong> Hall Road SK9 3AD or wherever mop-up takes you.<br><strong>Task:</strong> Final day! Check all notes from every session. Any street flagged as skipped gets done today.<br><strong>Streets:</strong> Prioritise Handforth and Wilmslow border. If done, revisit thinnest coverage area.<br><strong>Target:</strong> 500 leaflets \u2014 the final 500 to reach 20,000! &#127881;'}
];

// Date helpers
function fmtDate(iso){
  const d=new Date(iso+'T12:00:00');
  const dn=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const mn=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return dn[d.getDay()]+' '+d.getDate()+' '+mn[d.getMonth()];
}
// Next available Tue(2) or Wed(3) strictly after fromISO
function nextTueWed(fromISO){
  const d=new Date(fromISO+'T12:00:00');
  d.setDate(d.getDate()+1);
  while(![2,3].includes(d.getDay())) d.setDate(d.getDate()+1);
  return d.toISOString().slice(0,10);
}
// Calc expected completion: for each incomplete session, assign next Tue/Wed from today
function calcCompletion(allSessions,state){
  const today=new Date();today.setHours(0,0,0,0);
  const incomplete=allSessions.filter(s=>!(parseInt(state[s.id]?.delivered)||0));
  if(!incomplete.length) return 'Complete! \uD83C\uDF89';
  let cursor=new Date(today);cursor.setDate(cursor.getDate()-1);
  for(let i=0;i<incomplete.length;i++){
    cursor=new Date(nextTueWed(cursor.toISOString().slice(0,10))+'T12:00:00');
  }
  const dn=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const mn=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return dn[cursor.getDay()]+' '+cursor.getDate()+' '+mn[cursor.getMonth()]+' '+cursor.getFullYear();
}

// State
let sessions=[...BASE],sessionState={},saveTimers={};

// Phase 4: View toggle
function showView(view) {
  document.getElementById('cardsView').style.display = view === 'cards' ? '' : 'none';
  document.getElementById('mapView').style.display = view === 'map' ? '' : 'none';
  document.getElementById('analyticsView').style.display = view === 'analytics' ? '' : 'none';
  ['cards','map','analytics'].forEach(v => {
    const btn = document.getElementById('viewBtn' + v.charAt(0).toUpperCase() + v.slice(1));
    if (btn) btn.classList.toggle('view-active', v === view);
  });
  if (view === 'map' && typeof loadHeatmap === 'function') loadHeatmap();
  if (view === 'analytics' && typeof loadAnalyticsDashboard === 'function') loadAnalyticsDashboard();
}

// Phase 4: Map ‚Üí route card navigation
function showRouteCard(areaId) {
  showView('cards');
  setTimeout(() => {
    const card = document.querySelector('.area-card[data-area-id="' + areaId + '"]');
    if (card) {
      card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      card.style.boxShadow = '0 0 0 3px #2563eb';
      setTimeout(() => card.style.boxShadow = '', 2000);
    }
  }, 100);
}

// Phase 4: Heatmap
async function loadHeatmap() {
  const container = document.getElementById('heatmapContainer');
  if (!container._leaflet_id) {
    const map = L.map('heatmapContainer').setView([53.38, -2.32], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);
    window.analyticsMap = map;

    // Map legend
    const legend = L.control({ position: 'bottomleft' });
    legend.onAdd = function() {
      const div = L.DomUtil.create('div');
      div.style.cssText = 'background:#fff;padding:8px 12px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.2);font-size:13px;line-height:1.8;';
      div.innerHTML = '<strong style="display:block;margin-bottom:4px;">Routes</strong>'
        + '<span style="color:#6b7280;">‚óè</span> Available<br>'
        + '<span style="color:#f59e0b;">‚óè</span> Reserved<br>'
        + '<span style="color:#16a34a;">‚óè</span> Completed<br>'
        + '<span style="color:#dc2626;">‚ö†</span> <span style="text-decoration:line-through;">Restricted</span><br>'
        + '<strong style="display:block;margin:4px 0 2px;">Enquiries</strong>'
        + '<span style="color:#7c3aed;">‚óè</span> Instructed<br>'
        + '<span style="color:#c4b5fd;">‚óè</span> Enquiry';
      return div;
    };
    legend.addTo(window.analyticsMap);
  }

  try {
    const [restrictedAreas, allAreas, deliveries, enquiries] = await Promise.all([
      sbFetch('/rest/v1/restricted_areas?select=id,postcode_prefix,radius_miles,label'),
      sbFetch('/rest/v1/target_areas?select=*&campaign_id=eq.' + currentCampaignId),
      currentCampaignId ? sbFetch('/rest/v1/deliveries?select=*&campaign_id=eq.' + currentCampaignId) : sbFetch('/rest/v1/deliveries?select=*'),
      currentCampaignId ? sbFetch('/rest/v1/enquiries?select=*&campaign_id=eq.' + currentCampaignId) : sbFetch('/rest/v1/enquiries?select=*')
    ]);

    // Remove existing layers
    if (window.heatLayer) { window.heatLayer.remove(); window.heatLayer = null; }
    if (window.areaMarkers) { window.areaMarkers.forEach(m => m.remove()); }
    if (window.restrictedOverlay) { window.restrictedOverlay.remove(); }
    window.areaMarkers = [];

    const statusColour = { available: '#6b7280', reserved: '#f59e0b', completed: '#16a34a' };
    const restrictedPrefixes = (restrictedAreas || []).map(r => r.postcode_prefix);
    const isRestricted = (postcode) => restrictedPrefixes.some(rp => postcode?.toUpperCase().startsWith(rp));

    // Show all areas as circle markers, colour-coded by status
    (allAreas || []).filter(a => a.lat && a.lng).forEach(a => {
      const delivered = (deliveries || []).filter(d => d.target_area_id === a.id)
        .reduce((s, d) => s + (d.leaflets_delivered || 0), 0);
      const pct = a.house_count > 0 ? Math.round(delivered / a.house_count * 100) : 0;
      const restricted = isRestricted(a.postcode);
      const marker = L.circleMarker([a.lat, a.lng], {
        radius: 10,
        fillColor: statusColour[a.status] || '#6b7280',
        color: restricted ? '#dc2626' : '#fff',
        weight: restricted ? 4 : 2,
        opacity: 1,
        fillOpacity: 0.85,
        dashArray: restricted ? '4,2' : null
      }).bindPopup(`<strong>${a.area_name}</strong><br>${a.postcode}${restricted ? '<br><span style="color:#dc2626;font-weight:bold;">‚ö† Restricted</span>' : ''}<br>Status: ${a.status}${delivered > 0 ? `<br>Delivered: ${delivered.toLocaleString()} (${pct}%)` : '<br><em>No deliveries yet</em>'}<br><button onclick="showRouteCard('${a.id}')" style="margin-top:8px;padding:4px 12px;background:#1a3a5c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">View Route</button>`);
      marker.addTo(window.analyticsMap);
      window.areaMarkers.push(marker);
    });

    // Heatmap overlay for completed areas only
    const heatData = (allAreas || [])
      .filter(a => a.status === 'completed' && a.lat && a.lng)
      .map(a => {
        const count = (deliveries || []).filter(d => d.target_area_id === a.id)
          .reduce((s, d) => s + (d.leaflets_delivered || 0), 0);
        return [a.lat, a.lng, Math.max(count / 1000, 0.1)];
      });
    if (heatData.length > 0) {
      window.heatLayer = L.heatLayer(heatData, {radius: 25, blur: 15}).addTo(window.analyticsMap);
    }

    // Enquiry markers
    (enquiries || []).forEach(e => {
      if (e.lat && e.lng) {
        const color = e.instructed ? '#7c3aed' : '#c4b5fd';
        const marker = L.circleMarker([e.lat, e.lng], {
          radius: 8,
          color: color,
          fillColor: color,
          fillOpacity: e.instructed ? 0.85 : 0.5,
          weight: 2
        });
        const valueStr = e.instructed && e.instruction_value ? ` ‚Äî ¬£${Number(e.instruction_value).toLocaleString()}` : '';
        const nameStr = e.client_name ? e.client_name : 'Anonymous';
        marker.bindPopup(`<strong>${nameStr}</strong><br>${e.postcode || ''}${valueStr}<br><em>${e.instructed ? 'Instructed' : 'Enquiry'}</em>`);
        marker.addTo(window.analyticsMap);
      }
    });

    // Restricted area polygons (circles with radius)
    const restrictedCircles = [];
    for (const ra of (restrictedAreas || [])) {
      try {
        const outcode = ra.postcode_prefix.trim().toUpperCase();
        let lat, lng;
        // Route to correct endpoint without causing a 404: outcodes have no space and match e.g. M33, WA14
        const isOutcode = /^[A-Z]{1,2}\d[A-Z\d]?$/.test(outcode);
        const geoUrl = isOutcode
          ? `https://api.postcodes.io/outcodes/${encodeURIComponent(outcode)}`
          : `https://api.postcodes.io/postcodes/${encodeURIComponent(outcode)}`;
        const geoRes = await fetch(geoUrl).then(r => r.json());
        lat = geoRes.result?.latitude;
        lng = geoRes.result?.longitude;
        if (!lat || !lng) continue;
        const radiusMeters = (ra.radius_miles || 2) * 1609.34;
        const circle = L.circle([lat, lng], {
          radius: radiusMeters,
          color: '#dc2626',
          weight: 2,
          opacity: 0.8,
          fillColor: '#dc2626',
          fillOpacity: 0.15,
          dashArray: '6,4'
        }).bindPopup(`<strong>Restricted: ${ra.label || ra.postcode_prefix}</strong><br>${ra.postcode_prefix}${ra.radius_miles ? ` ¬∑ ${ra.radius_miles} mile radius` : ''}`);
        circle.addTo(window.analyticsMap);
        restrictedCircles.push(circle);
      } catch (err) {
        Logger.error('Failed to draw restricted area polygon for ' + ra.postcode_prefix, err);
      }
    }
    window.restrictedOverlay = L.layerGroup(restrictedCircles);

    // Fit map to markers if any
    if (window.areaMarkers.length > 0) {
      const group = L.featureGroup(window.areaMarkers);
      window.analyticsMap.fitBounds(group.getBounds().pad(0.1));
    }
  } catch(e) {
    Logger.error('Failed to load heatmap', e);
  }
}

// Phase 4/5: Completion rate for analytics dashboard ‚Äî reads target from DB (CFG-03)
async function loadCompletionRate() {
  try {
    let targetLeaflets=20000;
    if(currentCampaignId){
      const camps=await sbFetch('/rest/v1/campaigns?select=target_leaflets&id=eq.'+currentCampaignId);
      if(camps&&camps[0]&&camps[0].target_leaflets) targetLeaflets=camps[0].target_leaflets;
    } else {
      const camps=await sbFetch('/rest/v1/campaigns?select=target_leaflets&is_active=eq.true');
      if(camps&&camps.length>0) targetLeaflets=camps.reduce((s,c)=>s+(c.target_leaflets||0),0);
    }
    const delivUrl=currentCampaignId
      ?'/rest/v1/deliveries?select=leaflets_delivered&campaign_id=eq.'+currentCampaignId
      :'/rest/v1/deliveries?select=leaflets_delivered';
    const deliveries=await sbFetch(delivUrl);
    const totalLeaflets=(deliveries||[]).reduce((sum,d)=>sum+(d.leaflets_delivered||0),0);
    const rate=targetLeaflets>0?Math.round(totalLeaflets/targetLeaflets*100):0;
    const el=document.getElementById('overallCompletionRate');
    if(el) el.textContent=rate+'% ('+totalLeaflets.toLocaleString()+'/'+targetLeaflets.toLocaleString()+' leaflets)';
  } catch(e) {
    Logger.error('Failed to load completion rate',e);
  }
}

// Phase 4/5: Load full analytics dashboard
async function loadAnalyticsDashboard() {
  await loadCompletionRate();
  await loadAnalyticsCharts();
  await loadCampaignBreakdown();
}

// Phase 5 T6: Load campaign-specific rate/CV overrides into campaignRates
async function loadCampaignRates(){
  campaignRates={conservative:null,target:null,optimistic:null,defaultCaseValue:null};
  if(!currentCampaignId) return; // All Campaigns: use hardcoded fallbacks
  try{
    const rows=await sbFetch('/rest/v1/campaigns?select=rate_conservative,rate_target,rate_optimistic,default_case_value&id=eq.'+currentCampaignId);
    if(rows&&rows[0]){
      campaignRates.conservative=rows[0].rate_conservative??null;
      campaignRates.target=rows[0].rate_target??null;
      campaignRates.optimistic=rows[0].rate_optimistic??null;
      campaignRates.defaultCaseValue=rows[0].default_case_value??null;
    }
  }catch(e){Logger.error('loadCampaignRates failed',e);}
}

// Phase 5 T5: Campaign breakdown table ‚Äî shown only in All Campaigns mode
async function loadCampaignBreakdown() {
  const panel=document.getElementById('campaignBreakdown');
  if(!panel) return;
  if(currentCampaignId){panel.style.display='none';return;}
  panel.style.display='';
  try{
    const campaigns=await sbFetch('/rest/v1/campaigns?select=*&is_active=eq.true&order=created_at.desc');
    const deliveries=await sbFetch('/rest/v1/deliveries?select=campaign_id,leaflets_delivered');
    const delivBycamp={};
    (deliveries||[]).forEach(d=>{
      if(d.campaign_id) delivBycamp[d.campaign_id]=(delivBycamp[d.campaign_id]||0)+(d.leaflets_delivered||0);
    });
    const tbody=document.getElementById('campaignBreakdownBody');
    if(!tbody) return;
    tbody.innerHTML=(campaigns||[]).map(c=>{
      const delivered=delivBycamp[c.id]||0;
      const target=c.target_leaflets||0;
      const remaining=Math.max(0,target-delivered);
      const pct=target>0?Math.min(100,Math.round(delivered/target*100)):0;
      return '<tr style="border-bottom:1px solid #f3f4f6;">'+
        '<td style="padding:6px 8px;">'+c.name+'</td>'+
        '<td style="text-align:right;padding:6px 8px;">'+target.toLocaleString()+'</td>'+
        '<td style="text-align:right;padding:6px 8px;">'+delivered.toLocaleString()+'</td>'+
        '<td style="text-align:right;padding:6px 8px;">'+remaining.toLocaleString()+'</td>'+
        '<td style="text-align:right;padding:6px 8px;">'+pct+'%</td>'+
        '</tr>';
    }).join('');
  }catch(e){Logger.error('loadCampaignBreakdown failed',e);}
}

// Phase 4: Analytics charts
async function loadAnalyticsCharts() {
  try {
    const campFilter = currentCampaignId ? '&campaign_id=eq.' + currentCampaignId : '';
    const deliveries = await sbFetch('/rest/v1/deliveries?select=*&order=delivery_date.asc' + campFilter);
    const enquiries = await sbFetch('/rest/v1/enquiries?select=*&order=created_at.asc' + campFilter);
    
    const deliveryByDate = {};
    (deliveries || []).forEach(d => {
      const date = d.delivery_date;
      if (date) deliveryByDate[date] = (deliveryByDate[date] || 0) + (d.leaflets_delivered || 0);
    });
    
    const deliveriesCtx = document.getElementById('chartDeliveries');
    if (deliveriesCtx) {
      new Chart(deliveriesCtx, {
        type: 'line',
        data: { labels: Object.keys(deliveryByDate), datasets: [{ label: 'Leaflets', data: Object.values(deliveryByDate), borderColor: '#2563eb', fill: true, tension: 0.3 }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }
    
    const revenueByDate = {};
    (enquiries || []).forEach(e => {
      const date = e.created_at?.slice(0, 10);
      if (date && e.instruction_value) revenueByDate[date] = (revenueByDate[date] || 0) + e.instruction_value;
    });
    
    const revenueCtx = document.getElementById('chartRevenue');
    if (revenueCtx) {
      new Chart(revenueCtx, {
        type: 'line',
        data: { labels: Object.keys(revenueByDate), datasets: [{ label: 'Revenue (¬£)', data: Object.values(revenueByDate), borderColor: '#16a34a', fill: true, tension: 0.3 }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }
    
    const enquiriesByDate = {};
    (enquiries || []).forEach(e => {
      const date = e.created_at?.slice(0, 10);
      if (date) enquiriesByDate[date] = (enquiriesByDate[date] || 0) + 1;
    });
    
    const enquiriesCtx = document.getElementById('chartEnquiries');
    if (enquiriesCtx) {
      new Chart(enquiriesCtx, {
        type: 'bar',
        data: { labels: Object.keys(enquiriesByDate), datasets: [{ label: 'Enquiries', data: Object.values(enquiriesByDate), backgroundColor: '#8b5cf6' }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }
  } catch(e) {
    Logger.error('Failed to load analytics charts', e);
  }
}

// Phase 2 State
let currentCampaignId=null;
let teamMembers=[];
let targetAreas=[];
let reservations=[];
let areaDeliveries={}; // Phase 4: map of area_id -> leaflets_delivered

async function sbFetch(path,opts={}){
  const r=await fetch(SB_URL+path,{...opts,headers:{'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json','Prefer':'return=representation',...(opts.headers||{})}});
  if(!r.ok)throw new Error(await r.text());
  const t=await r.text();return t?JSON.parse(t):null;
}
function setSyncStatus(s,msg){document.getElementById('syncDot').className='sync-dot '+s;document.getElementById('syncMsg').textContent=msg;}

// Phase 2: Load campaigns, team members, and area cards
async function loadCampaigns(){
  try{
    Logger.info('Fetching campaigns from Supabase...');
    const campaigns=await sbFetch('/rest/v1/campaigns?select=*&is_active=eq.true&order=created_at.desc');
    Logger.info('Loaded campaigns',{count:campaigns?.length});
    const select=document.getElementById('campaignSelect');
    select.innerHTML='';
    if(campaigns&&campaigns.length>0){
      Logger.success(`Loaded ${campaigns.length} campaigns`);
      // Add "All Campaigns" option first
      const allOpt=document.createElement('option');
      allOpt.value='';
      allOpt.textContent='All Campaigns';
      select.appendChild(allOpt);
      campaigns.forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c.id;
        opt.textContent=c.name;
        select.appendChild(opt);
      });
      currentCampaignId=campaigns[0].id;
      select.value=currentCampaignId;
      Logger.info('Set currentCampaignId',{campaignId:currentCampaignId});
      // Add change handler
      select.onchange=async function(){
        currentCampaignId=this.value||null;
        Logger.info('Campaign changed',{campaignId:currentCampaignId});
        await loadCampaignRates();
        await loadAreaCards();
        renderAreaCards();
        await loadSummaryStats();
      };
      Logger.success('Campaign loaded',campaigns[0].name);
    } else {
      Logger.error('No campaigns found or campaigns array is empty');
      Logger.info('Checking campaigns table directly...');
    }
    return campaigns;
  }catch(e){
    Logger.error('Failed to load campaigns',e);
    console.error('Full error:', e);
    return [];
  }
}

async function loadTeamMembers(){
  try{
    teamMembers=await sbFetch('/rest/v1/team_members?select=*&is_active=eq.true&order=name.asc');
    Logger.info('Loaded team members',{count:teamMembers?.length});
    return teamMembers;
  }catch(e){
    Logger.error('Failed to load team members',e);
    return [];
  }
}

async function loadAreaCards(){
  try{
    // null currentCampaignId = "All Campaigns" view
    const areasUrl=currentCampaignId
      ?'/rest/v1/target_areas?select=*&campaign_id=eq.'+currentCampaignId+'&order=created_at.asc'
      :'/rest/v1/target_areas?select=*&order=created_at.asc';
    Logger.info('Loading area cards',{campaignId:currentCampaignId||'all'});
    // First get areas for this campaign
    const areas=await sbFetch(areasUrl);
    const areaIds=areas?areas.map(a=>a.id):[];
    Logger.info('Loaded target areas',{count:areas?.length,ids:areaIds});
    
    // Then get reservations for those areas
    let resvs=[];
    if(areaIds.length>0){
      // Build an 'in' filter manually
      const areaIdFilter=areaIds.map(id=>'"'+id+'"').join(',');
      resvs=await sbFetch('/rest/v1/reservations?select=*&status=eq.active&target_area_id=in.('+areaIdFilter+')');
      Logger.info('Loaded reservations',{count:resvs?.length});
    }
    
    targetAreas=areas||[];
    reservations=resvs||[];

    // Phase 4: Load delivery totals per area for completion % display
    if(areaIds.length>0){
      const areaIdFilter=areaIds.map(id=>'"'+id+'"').join(',');
      const delivs=await sbFetch('/rest/v1/deliveries?select=target_area_id,leaflets_delivered&target_area_id=in.('+areaIdFilter+')');
      areaDeliveries={};
      (delivs||[]).forEach(d=>{
        areaDeliveries[d.target_area_id]=(areaDeliveries[d.target_area_id]||0)+(d.leaflets_delivered||0);
      });
    }

    Logger.success('Area cards loaded',{areas:targetAreas.length,reservations:reservations.length});
  }catch(e){
    Logger.error('Failed to load area cards',e);
    console.error('Full error:', e);
    targetAreas=[];reservations=[];
  }
}

function getTeamMemberName(id){
  const tm=teamMembers.find(t=>t.id===id);
  return tm?tm.name:'Unknown';
}

function renderAreaCards(){
  const container=document.getElementById('areaCards');
  if(!container){
    Logger.error('areaCards container not found in DOM');
    return;
  }
  Logger.info('renderAreaCards called',{targetAreasLength:targetAreas.length});
  if(targetAreas.length===0){
    Logger.info('No target areas to render');
    container.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:#888;">No routes defined for this campaign</div>';
    return;
  }
  let html='';
  targetAreas.forEach(area=>{
    const status=area.status||'available';
    if(status==='completed')return;
    const res=reservations.find(r=>r.target_area_id===area.id);
    const reservedBy=res?getTeamMemberName(res.team_member_1_id):null;
    const reservedBy2=res&&res.team_member_2_id?getTeamMemberName(res.team_member_2_id):null;
    const deliveryDate=res?res.delivery_date:null;

    html+='<div class="area-card '+status+'" data-area-id="'+area.id+'">';
    html+='<div class="area-card-header"><div><div class="area-card-title">'+area.area_name+'</div><div class="area-card-postcode">'+area.postcode+'</div></div>';
    html+='<span class="area-card-badge '+status+'">'+status+'</span></div>';
    const delivered=areaDeliveries[area.id]||0;
    const houseCount=area.house_count||0;
    const pct=houseCount>0?Math.round(delivered/houseCount*100):0;
    html+='<div class="area-card-stats"><div class="area-card-stat"><div class="area-card-stat-val">'+houseCount+'</div><div class="area-card-stat-lbl">Doors</div></div>';
    if(status==='reserved'&&delivered>0){
      html+='<div class="area-card-stat"><div class="area-card-stat-val">'+pct+'%</div><div class="area-card-stat-lbl">Delivered</div></div>';
    }
    html+='</div>';

    if(status==='reserved'&&reservedBy){
      let teamHtml='<strong>'+reservedBy+'</strong>';
      if(reservedBy2) teamHtml+=' & '+reservedBy2;
      html+='<div class="area-card-team">'+teamHtml+(deliveryDate?' &middot; '+deliveryDate:'')+'</div>';
    }

    // Action buttons
    html+='<div class="area-card-actions">';
    if(status==='available'){
      html+='<button class="area-card-btn reserve" onclick="openReserveModal(\''+area.id+'\')">Reserve</button>';
    }else if(status==='reserved'){
      html+='<button class="area-card-btn complete" onclick="openCompleteModal(\''+area.id+'\')">Complete</button>';
      html+='<button class="area-card-btn reassign" onclick="openReassignModal(\''+area.id+'\')">Reassign</button>';
      html+='<button class="area-card-btn unassign" onclick="openUnassignModal(\''+area.id+'\')">Unassign</button>';
    }
    html+='</div></div>';
  });
  container.innerHTML=html;
  Logger.success('Area cards rendered',{count:targetAreas.length});
}

// ============================================================
// MODAL FUNCTIONS - Phase 2 Task 3 & 5
// ============================================================

let currentReserveAreaId=null;
let currentCompleteAreaId=null;
let currentReassignAreaId=null;

// Reserve Modal
function openReserveModal(areaId){
  const area=targetAreas.find(a=>a.id===areaId);
  if(!area)return;
  currentReserveAreaId=areaId;
  document.getElementById('reserveAreaName').value=area.area_name;
  document.getElementById('reserveError').className='modal-error';
  document.getElementById('reserveError').textContent='';
  
  // Populate team member dropdown
  const select=document.getElementById('reserveTeamMember');
  select.innerHTML='<option value="">Select team member...</option>';
  teamMembers.forEach(tm=>{
    const opt=document.createElement('option');
    opt.value=tm.id;
    opt.textContent=tm.name;
    select.appendChild(opt);
  });
  
  // Populate second team member dropdown (optional)
  const select2=document.getElementById('reserveTeamMember2');
  select2.innerHTML='<option value="">Select second team member...</option>';
  teamMembers.forEach(tm=>{
    const opt=document.createElement('option');
    opt.value=tm.id;
    opt.textContent=tm.name;
    select2.appendChild(opt);
  });
  
  // Set min date to tomorrow
  const tomorrow=new Date();
  tomorrow.setDate(tomorrow.getDate()+1);
  document.getElementById('reserveDate').value=tomorrow.toISOString().split('T')[0];
  document.getElementById('reserveDate').min=tomorrow.toISOString().split('T')[0];
  
  document.getElementById('reserveModal').classList.add('active');
  select.focus();
}

function closeReserveModal(){
  document.getElementById('reserveModal').classList.remove('active');
  currentReserveAreaId=null;
}

async function confirmReservation(){
  const teamMemberId=document.getElementById('reserveTeamMember').value;
  const teamMember2Id=document.getElementById('reserveTeamMember2').value;
  const deliveryDate=document.getElementById('reserveDate').value;
  const errorEl=document.getElementById('reserveError');
  const btn=document.getElementById('reserveConfirmBtn');
  
  if(!teamMemberId){
    errorEl.textContent='Please select a team member';
    errorEl.classList.add('show');
    return;
  }
  if(!deliveryDate){
    errorEl.textContent='Please select a delivery date';
    errorEl.classList.add('show');
    return;
  }
  
  btn.disabled=true;
  btn.textContent='Reserving...';
  errorEl.classList.remove('show');
  
  try{
    // Call reserve_area function via RPC
    const result=await sbFetch('/rest/v1/rpc/reserve_area',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        p_target_area_id:currentReserveAreaId,
        p_team_member_1_id:teamMemberId,
        p_team_member_2_id:teamMember2Id||null,
        p_delivery_date:deliveryDate
      })
    });
    
    if(result&&result.success){
      closeReserveModal();
      await loadAreaCards();
      renderAreaCards();
      setSyncStatus('ok','Area reserved!');
    }else{
      errorEl.textContent=result.error||'Failed to reserve area';
      errorEl.classList.add('show');
    }
  }catch(e){
    errorEl.textContent='Error: '+e.message;
    errorEl.classList.add('show');
  }
  btn.disabled=false;
  btn.textContent='Reserve';
}

// Complete Modal
function openCompleteModal(areaId){
  const area=targetAreas.find(a=>a.id===areaId);
  if(!area)return;
  currentCompleteAreaId=areaId;
  document.getElementById('completeAreaName').value=area.area_name;
  document.getElementById('completeLeaflets').value=area.house_count||'';
  document.getElementById('completeNotes').value='';
  document.getElementById('completeError').className='modal-error';
  document.getElementById('completeError').textContent='';
  document.getElementById('completeModal').classList.add('active');
  document.getElementById('completeLeaflets').focus();
}

function closeCompleteModal(){
  document.getElementById('completeModal').classList.remove('active');
  currentCompleteAreaId=null;
}

async function loadSummaryStats(){
  try{
    // Fetch campaign target (or sum across all campaigns)
    let targetLeaflets=20000; // fallback if no campaign data
    if(currentCampaignId){
      const camps=await sbFetch('/rest/v1/campaigns?select=target_leaflets&id=eq.'+currentCampaignId);
      if(camps&&camps[0]&&camps[0].target_leaflets) targetLeaflets=camps[0].target_leaflets;
    } else {
      const camps=await sbFetch('/rest/v1/campaigns?select=target_leaflets&is_active=eq.true');
      if(camps&&camps.length>0) targetLeaflets=camps.reduce((s,c)=>s+(c.target_leaflets||0),0);
    }

    // Fetch deliveries (filtered by campaign if one selected)
    const delivUrl=currentCampaignId
      ?'/rest/v1/deliveries?select=leaflets_delivered,campaign_id&campaign_id=eq.'+currentCampaignId
      :'/rest/v1/deliveries?select=leaflets_delivered';
    const deliveries=await sbFetch(delivUrl);
    const totalDelivered=(deliveries||[]).reduce((s,d)=>s+(d.leaflets_delivered||0),0);

    // Fetch completed routes count
    const areasUrl=currentCampaignId
      ?'/rest/v1/target_areas?select=status&campaign_id=eq.'+currentCampaignId
      :'/rest/v1/target_areas?select=status';
    const areas=await sbFetch(areasUrl);
    const totalAreas=(areas||[]).length;
    const completedAreas=(areas||[]).filter(a=>a.status==='completed').length;

    const remaining=Math.max(0,targetLeaflets-totalDelivered);
    const pct=targetLeaflets>0?Math.min(100,Math.round(totalDelivered/targetLeaflets*100)):0;

    document.getElementById('sumDelivered').textContent=totalDelivered.toLocaleString();
    document.getElementById('sumRemaining').textContent=remaining.toLocaleString();
    document.getElementById('sumSessions').textContent=completedAreas+' / '+totalAreas+' routes';
    document.getElementById('progressFill').style.width=pct+'%';
    document.getElementById('progressPct').textContent=pct+'%';
    document.getElementById('sumProjected').textContent='‚Äî';
  }catch(e){
    Logger.error('loadSummaryStats failed',e);
  }
}

async function loadDeliveryJournal(){
  try{
    const journalCampFilter = currentCampaignId ? '&campaign_id=eq.' + currentCampaignId : '';
    const rows=await sbFetch('/rest/v1/deliveries?select=leaflets_delivered,delivery_date,notes,created_at,target_areas(area_name),team_member_1:team_members!team_member_1_id(name),team_member_2:team_members!team_member_2_id(name)&order=delivery_date.desc' + journalCampFilter);
    const el=document.getElementById('journalList');
    if(!rows||rows.length===0){el.innerHTML='<p style="color:#888;font-size:0.9rem;">No deliveries recorded yet.</p>';return;}
    
    function fmtDate(iso){
      if(!iso)return'';
      const d=new Date(iso+'T12:00:00');
      const dn=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
      const mn=['January','February','March','April','May','June','July','August','September','October','November','December'];
      const day=d.getDate();
      const suffix=day===1||day===21||day===31?'st':day===2||day===22?'nd':day===3||day===23?'rd':'th';
      return day+suffix+' '+mn[d.getMonth()]+' '+d.getFullYear();
    }
    
    const totalLeaflets=rows.reduce((sum,r)=>sum+(r.leaflets_delivered||0),0);
    const totalAreas=rows.length;
    const totalTeamMembers=new Set([...rows.map(r=>r.team_member_1?.name).filter(Boolean),...rows.map(r=>r.team_member_2?.name).filter(Boolean)]).size;
    
    let html='<table style="width:100%;border-collapse:collapse;font-size:0.85rem;">';
    html+='<thead><tr style="background:#1a3a5c;color:white;">';
    html+='<th style="padding:8px;text-align:left;">Date</th>';
    html+='<th style="padding:8px;text-align:left;">Route</th>';
    html+='<th style="padding:8px;text-align:right;">Leaflets</th>';
    html+='<th style="padding:8px;text-align:left;">Team</th>';
    html+='<th style="padding:8px;text-align:left;">Notes</th>';
    html+='<th style="padding:8px;text-align:center;">Action</th></tr></thead>';
    html+='<tbody>';
    rows.forEach(r=>{
      const area=r.target_areas?.area_name||'Unknown area';
      const tm1=r.team_member_1?.name||'';
      const tm2=r.team_member_2?.name||'';
      const team=tm2?tm1+' & '+tm2:tm1;
      const date=fmtDate(r.delivery_date||r.created_at?.slice(0,10));
      const notes=r.notes||'';
      html+='<tr style="border-bottom:1px solid #eee;">';
      html+='<td style="padding:8px;">'+date+'</td>';
      html+='<td style="padding:8px;"><strong>'+area+'</strong></td>';
      html+='<td style="padding:8px;text-align:right;">'+r.leaflets_delivered.toLocaleString()+'</td>';
      html+='<td style="padding:8px;">'+(team||'‚Äî')+'</td>';
      html+='<td style="padding:8px;color:#666;">'+notes+'</td>';
      html+='<td style="padding:8px;text-align:center;"><button onclick="openEditDelivery(\''+r.id+'\')" style="padding:4px 8px;background:#1a3a5c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.75rem;">Edit</button></td>';
      html+='</tr>';
    });
    html+='<tr style="background:#e8f4f8;font-weight:700;">';
    html+='<td style="padding:8px;">Total</td>';
    html+='<td style="padding:8px;">'+totalAreas+' routes</td>';
    html+='<td style="padding:8px;text-align:right;">'+totalLeaflets.toLocaleString()+'</td>';
    html+='<td style="padding:8px;">'+totalTeamMembers+' team members</td>';
    html+='<td style="padding:8px;"></td>';
    html+='</tr></tbody></table>';
    el.innerHTML=html;
  }catch(e){
    document.getElementById('journalList').innerHTML='<p style="color:#888;font-size:0.9rem;">Could not load journal.</p>';
  }
}

async function loadEnquiryList(){
  const section=document.getElementById('enquiriesSection');
  const btn=document.getElementById('recordEnquiryBtn');
  if(!currentCampaignId){
    section.style.display='none';
    return;
  }
  section.style.display='block';
  btn.style.display='inline-block';
  
  try{
    const campFilter = '&campaign_id=eq.' + currentCampaignId;
    const rows=await sbFetch('/rest/v1/enquiries?select=*&order=created_at.desc' + campFilter);
    const el=document.getElementById('enquiryList');
    if(!rows||rows.length===0){el.innerHTML='<p style="color:#888;font-size:0.9rem;">No enquiries recorded yet.</p>';return;}
    
    function fmtDate(iso){
      if(!iso)return'';
      const d=new Date(iso);
      return d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
    }
    
    let html='<table style="width:100%;border-collapse:collapse;font-size:0.85rem;">';
    html+='<thead><tr style="background:#8b5cf6;color:white;">';
    html+='<th style="padding:8px;text-align:left;">Date</th>';
    html+='<th style="padding:8px;text-align:left;">Client</th>';
    html+='<th style="padding:8px;text-align:left;">Postcode</th>';
    html+='<th style="padding:8px;text-align:center;">Instructed</th>';
    html+='<th style="padding:8px;text-align:right;">Value</th>';
    html+='<th style="padding:8px;text-align:left;">Notes</th>';
    html+='<th style="padding:8px;text-align:center;">Action</th></tr></thead>';
    html+='<tbody>';
    rows.forEach(r=>{
      const client=r.client_name||'Anonymous';
      const postcode=r.postcode||'‚Äî';
      const instructed=r.instructed?'<span style="color:#16a34a;font-weight:700;">Yes</span>':'<span style="color:#666;">No</span>';
      const value=r.instruction_value?'&pound;'+parseFloat(r.instruction_value).toLocaleString():'‚Äî';
      const notes=r.notes||'';
      const date=fmtDate(r.created_at);
      html+='<tr style="border-bottom:1px solid #eee;">';
      html+='<td style="padding:8px;">'+date+'</td>';
      html+='<td style="padding:8px;"><strong>'+client+'</strong></td>';
      html+='<td style="padding:8px;">'+postcode+'</td>';
      html+='<td style="padding:8px;text-align:center;">'+instructed+'</td>';
      html+='<td style="padding:8px;text-align:right;">'+value+'</td>';
      html+='<td style="padding:8px;color:#666;">'+notes+'</td>';
      html+='<td style="padding:8px;text-align:center;"><button onclick="editEnquiry(\''+r.id+'\')" style="padding:4px 8px;background:#8b5cf6;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.75rem;margin-right:4px;">Edit</button><button onclick="deleteEnquiry(\''+r.id+'\')" style="padding:4px 8px;background:#dc2626;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.75rem;">Delete</button></td>';
      html+='</tr>';
    });
    html+='</tbody></table>';
    el.innerHTML=html;
  }catch(e){
    document.getElementById('enquiryList').innerHTML='<p style="color:#888;font-size:0.9rem;">Could not load enquiries.</p>';
  }
}

async function loadTeamProgress(){
  const section=document.getElementById('teamProgressSection');
  if(!currentCampaignId){
    section.style.display='none';
    return;
  }
  section.style.display='block';
  
  try{
    const campFilter='?campaign_id=eq.'+currentCampaignId;
    
    const [teamMembers, areas, deliveries]=await Promise.all([
      sbFetch('/rest/v1/team_members?select=*&is_active=eq.true&order=name.asc'),
      sbFetch('/rest/v1/target_areas'+campFilter),
      sbFetch('/rest/v1/deliveries'+campFilter)
    ]);
    
    const totalDelivered=(deliveries||[]).reduce((sum,d)=>sum+(d.leaflets_delivered||0),0);
    const totalTarget=areas?.reduce((sum,a)=>sum+(a.house_count||0),0)||0;
    
    const stats={};
    (teamMembers||[]).forEach(tm=>{
      stats[tm.id]={
        name:tm.name,
        reserved:0,
        completed:0,
        delivered:0
      };
    });
    
    (areas||[]).forEach(a=>{
      if(a.team_member_1_id&&stats[a.team_member_1_id]){
        stats[a.team_member_1_id].reserved++;
        if(a.status==='completed')stats[a.team_member_1_id].completed++;
      }
      if(a.team_member_2_id&&stats[a.team_member_2_id]){
        stats[a.team_member_2_id].reserved++;
        if(a.status==='completed')stats[a.team_member_2_id].completed++;
      }
    });
    
    (deliveries||[]).forEach(d=>{
      if(d.team_member_1_id&&stats[d.team_member_1_id]){
        stats[d.team_member_1_id].delivered+=d.leaflets_delivered||0;
      }
      if(d.team_member_2_id&&stats[d.team_member_2_id]){
        stats[d.team_member_2_id].delivered+=d.leaflets_delivered||0;
      }
    });
    
    const list=Object.values(stats).sort((a,b)=>b.delivered-a.delivered);
    const el=document.getElementById('teamProgressList');
    
    if(list.length===0){
      el.innerHTML='<p style="color:#888;font-size:0.9rem;">No team members assigned yet.</p>';
      return;
    }
    
    let html='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;">';
    list.forEach(tm=>{
      const pct=totalDelivered>0?Math.round(tm.delivered/totalDelivered*100):0;
      html+='<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;">';
      html+='<div style="font-weight:600;margin-bottom:8px;">'+tm.name+'</div>';
      html+='<div style="font-size:0.85rem;color:#64748b;">';
      html+='<div>Routes: '+tm.reserved+' ('+tm.completed+' completed)</div>';
      html+='<div>Delivered: '+tm.delivered.toLocaleString()+'</div>';
      html+='</div>';
      html+='<div style="margin-top:8px;background:#e2e8f0;border-radius:4px;height:8px;overflow:hidden;">';
      html+='<div style="background:#16a34a;height:100%;width:'+pct+'%;"></div>';
      html+='</div>';
      html+='<div style="font-size:0.75rem;color:#64748b;margin-top:4px;">'+pct+'% of campaign</div>';
      html+='</div>';
    });
    html+='</div>';
    el.innerHTML=html;
  }catch(e){
    document.getElementById('teamProgressList').innerHTML='<p style="color:#888;font-size:0.9rem;">Could not load team progress.</p>';
  }
}

let currentEditEnquiryId=null;

function editEnquiry(id){
  currentEditEnquiryId=id;
  openEnquiryModal(id);
}

async function deleteEnquiry(id){
  if(!confirm('Delete this enquiry? This cannot be undone.'))return;
  try{
    await sbFetch('/rest/v1/enquiries?id=eq.'+id,{method:'DELETE'});
    await loadEnquiryList();
    setSyncStatus('ok','Enquiry deleted');
  }catch(e){
    alert('Error deleting enquiry: '+e.message);
  }
}

function openEnquiryModal(enquiryId){
  const isEdit=!!enquiryId;
  document.getElementById('enquiryModalTitle').textContent=isEdit?'Edit Enquiry':'Record Enquiry';
  document.getElementById('enquiryClientName').value='';
  document.getElementById('enquiryPostcode').value='';
  document.getElementById('enquiryInstructed').checked=false;
  document.getElementById('enquiryInstructionValue').value='';
  document.getElementById('enquiryNotes').value='';
  document.getElementById('enquiryError').textContent='';
  document.getElementById('enquiryValueField').style.display='none';
  
  const routeSelect=document.getElementById('enquiryRoute');
  routeSelect.innerHTML='<option value="">Route unknown</option>';
  (targetAreas||[]).forEach(ta=>{
    routeSelect.innerHTML+='<option value="'+ta.id+'">'+ta.area_name+'</option>';
  });
  
  if(isEdit){
    sbFetch('/rest/v1/enquiries?id=eq.'+enquiryId).then(rows=>{
      if(rows&&rows[0]){
        const r=rows[0];
        document.getElementById('enquiryClientName').value=r.client_name||'';
        document.getElementById('enquiryPostcode').value=r.postcode||'';
        document.getElementById('enquiryRoute').value=r.target_area_id||'';
        document.getElementById('enquiryInstructed').checked=r.instructed||false;
        document.getElementById('enquiryInstructionValue').value=r.instruction_value||'';
        document.getElementById('enquiryNotes').value=r.notes||'';
        if(r.instructed)document.getElementById('enquiryValueField').style.display='block';
      }
    });
  }
  
  document.getElementById('enquiryModal').classList.add('active');
  
  document.getElementById('enquiryInstructed').onchange=function(){
    document.getElementById('enquiryValueField').style.display=this.checked?'block':'none';
  };
}

function closeEnquiryModal(){
  document.getElementById('enquiryModal').classList.remove('active');
  currentEditEnquiryId=null;
}

async function saveEnquiry(){
  const postcode=document.getElementById('enquiryPostcode').value.trim();
  const errorEl=document.getElementById('enquiryError');
  const btn=document.getElementById('enquiryConfirmBtn');
  
  if(!postcode){
    errorEl.textContent='Please enter a postcode';
    errorEl.classList.add('show');
    return;
  }
  
  btn.disabled=true;
  btn.textContent='Saving...';
  errorEl.classList.remove('show');
  
  try{
    const routeVal=document.getElementById('enquiryRoute').value||null;
    let lat=null,lng=null;
    const geoRes=await fetch('https://api.postcodes.io/postcodes/'+encodeURIComponent(postcode)).then(r=>r.json());
    if(geoRes.status===200&&geoRes.result){lat=geoRes.result.latitude;lng=geoRes.result.longitude;}
    const data={
      campaign_id:currentCampaignId,
      client_name:document.getElementById('enquiryClientName').value.trim()||null,
      postcode:postcode,
      lat:lat,
      lng:lng,
      target_area_id:routeVal,
      instructed:document.getElementById('enquiryInstructed').checked,
      instruction_value:document.getElementById('enquiryInstructed').checked?parseFloat(document.getElementById('enquiryInstructionValue').value)||null:null,
      notes:document.getElementById('enquiryNotes').value.trim()||null
    };
    
    if(currentEditEnquiryId){
      await sbFetch('/rest/v1/enquiries?id=eq.'+currentEditEnquiryId,{method:'PATCH',body:JSON.stringify(data)});
    }else{
      await sbFetch('/rest/v1/enquiries',{method:'POST',body:JSON.stringify(data)});
    }
    
    closeEnquiryModal();
    await loadEnquiryList();
    setSyncStatus('ok',currentEditEnquiryId?'Enquiry updated':'Enquiry recorded');
  }catch(e){
    errorEl.textContent='Error: '+e.message;
    errorEl.classList.add('show');
  }
  btn.disabled=false;
  btn.textContent='Save';
}

let currentEditDeliveryId=null;

async function openEditDelivery(deliveryId){
  currentEditDeliveryId=deliveryId;
  document.getElementById('editDeliveryDate').value='';
  document.getElementById('editLeafletsDelivered').value='';
  document.getElementById('editDeliveryNotes').value='';
  document.getElementById('editDeliveryError').textContent='';
  document.getElementById('editDeliveryModal').classList.add('active');
  
  // Load delivery data
  const rows=await sbFetch('/rest/v1/deliveries?id=eq.'+deliveryId);
  if(rows&&rows[0]){
    const d=rows[0];
    document.getElementById('editDeliveryDate').value=d.delivery_date||'';
    document.getElementById('editLeafletsDelivered').value=d.leaflets_delivered||'';
    document.getElementById('editDeliveryNotes').value=d.notes||'';
  }
  
  // Populate team member dropdowns
  const tmSelect1=document.getElementById('editTeamMember1');
  const tmSelect2=document.getElementById('editTeamMember2');
  tmSelect1.innerHTML='<option value="">Select...</option>';
  tmSelect2.innerHTML='<option value="">Select...</option>';
  teamMembers.forEach(tm=>{
    tmSelect1.innerHTML+='<option value="'+tm.id+'">'+tm.name+'</option>';
    tmSelect2.innerHTML+='<option value="'+tm.id+'">'+tm.name+'</option>';
  });
  
  // Set current values
  if(rows&&rows[0]){
    tmSelect1.value=rows[0].team_member_1_id||'';
    tmSelect2.value=rows[0].team_member_2_id||'';
  }
}

function closeEditDelivery(){
  document.getElementById('editDeliveryModal').classList.remove('active');
  currentEditDeliveryId=null;
}

async function saveEditDelivery(){
  const date=document.getElementById('editDeliveryDate').value;
  const leaflets=document.getElementById('editLeafletsDelivered').value;
  const tm1=document.getElementById('editTeamMember1').value;
  const tm2=document.getElementById('editTeamMember2').value;
  const notes=document.getElementById('editDeliveryNotes').value;
  const errorEl=document.getElementById('editDeliveryError');
  const btn=document.getElementById('editDeliveryConfirmBtn');
  
  if(!leaflets||leaflets<0){
    errorEl.textContent='Please enter leaflet count';
    errorEl.classList.add('show');
    return;
  }
  
  btn.disabled=true;
  btn.textContent='Saving...';
  
  try{
    await sbFetch('/rest/v1/deliveries?id=eq.'+currentEditDeliveryId,{
      method:'PATCH',
      body:JSON.stringify({
        delivery_date:date||null,
        leaflets_delivered:parseInt(leaflets),
        team_member_1_id:tm1||null,
        team_member_2_id:tm2||null,
        notes:notes||null
      })
    });
    closeEditDelivery();
    await loadDeliveryJournal();
    await loadDeliveredTotal();
    setSyncStatus('ok','Delivery updated!');
  }catch(e){
    errorEl.textContent='Error: '+e.message;
    errorEl.classList.add('show');
  }
  btn.disabled=false;
  btn.textContent='Save';
}

async function confirmCompletion(){
  const leaflets=parseInt(document.getElementById('completeLeaflets').value);
  const notes=document.getElementById('completeNotes').value;
  const errorEl=document.getElementById('completeError');
  const btn=document.getElementById('completeConfirmBtn');
  
  if(!leaflets||leaflets<0){
    errorEl.textContent='Please enter leaflet count';
    errorEl.classList.add('show');
    return;
  }
  
  btn.disabled=true;
  btn.textContent='Completing...';
  errorEl.classList.remove('show');
  
  try{
    const result=await sbFetch('/rest/v1/rpc/complete_delivery',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        p_target_area_id:currentCompleteAreaId,
        p_leaflets_delivered:leaflets,
        p_notes:notes||null
      })
    });
    
    if(result&&result.success&&result.delivery!==null){
      // RPC doesn't write to deliveries table ‚Äî insert directly
      const area=targetAreas.find(a=>a.id===currentCompleteAreaId);
      const res=reservations.find(r=>r.target_area_id===currentCompleteAreaId);
      await sbFetch('/rest/v1/deliveries',{
        method:'POST',
        headers:{'Content-Type':'application/json','Prefer':'return=minimal'},
        body:JSON.stringify({
          campaign_id:area?.campaign_id||null,
          target_area_id:currentCompleteAreaId,
          team_member_1_id:res?.team_member_1_id||null,
          team_member_2_id:res?.team_member_2_id||null,
          delivery_date:res?.delivery_date||new Date().toISOString().slice(0,10),
          leaflets_delivered:leaflets,
          notes:notes||null
        })
      });
      closeCompleteModal();
      await loadAreaCards();
      renderAreaCards();
      await loadSummaryStats();
      await loadDeliveryJournal();
      setSyncStatus('ok','Delivery completed!');
    }else if(result&&result.success&&result.delivery===null){
      errorEl.textContent='Area was not in reserved state ‚Äî please refresh and try again';
      errorEl.classList.add('show');
    }else{
      errorEl.textContent=result?.error||'Failed to complete delivery';
      errorEl.classList.add('show');
    }
  }catch(e){
    errorEl.textContent='Error: '+e.message;
    errorEl.classList.add('show');
  }
  btn.disabled=false;
  btn.textContent='Mark Complete';
}

// Reassign Modal
function openReassignModal(areaId){
  const area=targetAreas.find(a=>a.id===areaId);
  const res=reservations.find(r=>r.target_area_id===areaId);
  if(!area)return;
  currentReassignAreaId=areaId;
  document.getElementById('reassignAreaName').value=area.area_name;
  document.getElementById('reassignCurrentMember').value=res?getTeamMemberName(res.team_member_1_id):'Unknown';
  document.getElementById('reassignCurrentMember2').value=res&&res.team_member_2_id?getTeamMemberName(res.team_member_2_id):'None';
  document.getElementById('reassignError').className='modal-error';
  document.getElementById('reassignError').textContent='';
  
  // Populate team member 1 dropdown (exclude current members)
  const select=document.getElementById('reassignNewMember');
  select.innerHTML='<option value="">Select new team member...</option>';
  const currentMemberId=res?res.team_member_1_id:null;
  const currentMember2Id=res?res.team_member_2_id:null;
  teamMembers.forEach(tm=>{
    if(tm.id!==currentMemberId&&tm.id!==currentMember2Id){
      const opt=document.createElement('option');
      opt.value=tm.id;
      opt.textContent=tm.name;
      select.appendChild(opt);
    }
  });
  
  // Populate team member 2 dropdown
  const select2=document.getElementById('reassignNewMember2');
  select2.innerHTML='<option value="">Select new team member or leave empty...</option>';
  teamMembers.forEach(tm=>{
    if(tm.id!==currentMemberId&&tm.id!==currentMember2Id){
      const opt=document.createElement('option');
      opt.value=tm.id;
      opt.textContent=tm.name;
      select2.appendChild(opt);
    }
  });
  
  document.getElementById('reassignModal').classList.add('active');
  select.focus();
}

function closeReassignModal(){
  document.getElementById('reassignModal').classList.remove('active');
  currentReassignAreaId=null;
}

async function confirmReassignment(){
  const newMemberId=document.getElementById('reassignNewMember').value;
  const newMember2Id=document.getElementById('reassignNewMember2').value;
  const errorEl=document.getElementById('reassignError');
  const btn=document.getElementById('reassignConfirmBtn');
  
  if(!newMemberId&&!newMember2Id){
    errorEl.textContent='Please select at least one new team member';
    errorEl.classList.add('show');
    return;
  }
  
  if(newMemberId&&newMember2Id&&newMemberId===newMember2Id){
    errorEl.textContent='Cannot assign the same team member to both slots';
    errorEl.classList.add('show');
    return;
  }
  
  btn.disabled=true;
  btn.textContent='Reassigning...';
  errorEl.classList.remove('show');
  
  try{
    const result=await sbFetch('/rest/v1/rpc/reassign_area',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        p_target_area_id:currentReassignAreaId,
        p_new_team_member_1_id:newMemberId||null,
        p_new_team_member_2_id:newMember2Id||null
      })
    });
    
    if(result&&result.success){
      closeReassignModal();
      await loadAreaCards();
      renderAreaCards();
      setSyncStatus('ok','Area reassigned!');
    }else{
      errorEl.textContent=result.error||'Failed to reassign area';
      errorEl.classList.add('show');
    }
  }catch(e){
    errorEl.textContent='Error: '+e.message;
    errorEl.classList.add('show');
  }
  btn.disabled=false;
  btn.textContent='Reassign';
}

// Unassign Modal
let currentUnassignAreaId=null;

function openUnassignModal(areaId){
  const area=targetAreas.find(a=>a.id===areaId);
  if(!area)return;
  currentUnassignAreaId=areaId;
  document.getElementById('unassignAreaName').value=area.area_name;
  document.getElementById('unassignError').className='modal-error';
  document.getElementById('unassignError').textContent='';
  document.getElementById('unassignModal').classList.add('active');
}

function closeUnassignModal(){
  document.getElementById('unassignModal').classList.remove('active');
  currentUnassignAreaId=null;
}

async function confirmUnassign(){
  const errorEl=document.getElementById('unassignError');
  const btn=document.getElementById('unassignConfirmBtn');
  btn.disabled=true;
  btn.textContent='Unassigning...';
  errorEl.classList.remove('show');
  try{
    const result=await sbFetch('/rest/v1/rpc/unassign_area',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({p_target_area_id:currentUnassignAreaId})
    });
    if(result&&result.success){
      closeUnassignModal();
      await loadAreaCards();
      renderAreaCards();
      setSyncStatus('ok','Area unassigned');
    }else{
      errorEl.textContent=result.error||'Failed to unassign area';
      errorEl.classList.add('show');
    }
  }catch(e){
    errorEl.textContent='Error: '+e.message;
    errorEl.classList.add('show');
  }
  btn.disabled=false;
  btn.textContent='Unassign';
}

// New Campaign Modal (T7)
function openNewCampaignModal(){
  document.getElementById('newCampaignName').value='';
  document.getElementById('newCampaignTarget').value='';
  document.getElementById('newCampaignStart').value='';
  document.getElementById('newCampaignEnd').value='';
  document.getElementById('newCampaignError').textContent='';
  document.getElementById('newCampaignConfirmBtn').disabled=false;
  document.getElementById('newCampaignConfirmBtn').textContent='Create';
  document.getElementById('newCampaignModal').classList.add('active');
}

function closeNewCampaignModal(){
  document.getElementById('newCampaignModal').classList.remove('active');
}

async function saveNewCampaign(){
  const name=document.getElementById('newCampaignName').value.trim();
  const target=parseInt(document.getElementById('newCampaignTarget').value)||null;
  const start=document.getElementById('newCampaignStart').value||null;
  const end=document.getElementById('newCampaignEnd').value||null;
  const errorEl=document.getElementById('newCampaignError');
  const btn=document.getElementById('newCampaignConfirmBtn');
  if(!name){errorEl.textContent='Campaign name is required.';return;}
  btn.disabled=true;btn.textContent='Creating...';errorEl.textContent='';
  try{
    const result=await sbFetch('/rest/v1/campaigns',{
      method:'POST',
      headers:{'Prefer':'return=representation','Content-Type':'application/json'},
      body:JSON.stringify({name,target_leaflets:target,start_date:start,end_date:end,is_active:true})
    });
    closeNewCampaignModal();
    await loadCampaigns();
    if(result&&result[0]&&result[0].id){
      currentCampaignId=result[0].id;
      document.getElementById('campaignSelect').value=currentCampaignId;
    }
    await loadAreaCards();
    renderAreaCards();
    await loadSummaryStats();
    setSyncStatus('ok','Campaign created!');
  }catch(e){
    errorEl.textContent='Failed to create campaign: '+e.message;
    btn.disabled=false;btn.textContent='Create';
  }
}

// Restricted Areas Management (global - not per campaign)
async function loadRestrictedAreasList() {
  const el = document.getElementById('restrictedAreasList');
  if (!el) return;
  el.innerHTML = '<em style="color:#aaa;">Loading...</em>';
  const rows = await sbFetch('/rest/v1/restricted_areas?select=id,postcode_prefix,radius_miles,label&order=postcode_prefix.asc');
  if (!rows || rows.length === 0) { el.innerHTML = '<em style="color:#aaa;">No restricted areas defined.</em>'; return; }
  const tbody = rows.map(r => {
    const rad = r.radius_miles || '';
    const lbl = (r.label || '').replace(/"/g, '&quot;');
    return '<tr data-id="' + r.id + '" style="border-top:1px solid #f0f0f0;">' +
      '<td style="padding:4px 6px;font-weight:600;">' + r.postcode_prefix + '</td>' +
      '<td style="padding:4px 6px;"><input type="number" step="0.1" min="0" value="' + rad + '" placeholder="1" style="width:70px;padding:3px 6px;border:1px solid #ccd3db;border-radius:4px;font-size:0.82rem;" onchange="saveRestrictedAreaRow(\'' + r.id + '\',this.closest(\'tr\'))"></td>' +
      '<td style="padding:4px 6px;"><input type="text" value="' + lbl + '" placeholder="Label" style="width:100px;padding:3px 6px;border:1px solid #ccd3db;border-radius:4px;font-size:0.82rem;" onchange="saveRestrictedAreaRow(\'' + r.id + '\',this.closest(\'tr\'))"></td>' +
      '<td style="padding:4px 6px;"><button onclick="deleteRestrictedArea(\'' + r.id + '\')" style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:1rem;" title="Delete">&#128465;</button></td></tr>';
  }).join('');
  el.innerHTML = '<table style="width:100%;border-collapse:collapse;font-size:0.82rem;"><thead><tr style="color:#888;text-align:left;"><th style="padding:4px 6px;">Postcode</th><th style="padding:4px 6px;">Radius (mi)</th><th style="padding:4px 6px;">Label</th><th></th></tr></thead><tbody>' + tbody + '</tbody></table>';
}
async function saveRestrictedAreaRow(id, row) {
  const radius = parseFloat(row.querySelector('input[type=number]').value) || null;
  const label = row.querySelector('input[type=text]').value.trim() || null;
  await sbFetch('/rest/v1/restricted_areas?id=eq.' + id, { method:'PATCH', body:JSON.stringify({radius_miles:radius, label}) });
  if (window.analyticsMap) loadHeatmap();
}
async function deleteRestrictedArea(id) {
  if (!confirm('Delete this restricted area?')) return;
  await sbFetch('/rest/v1/restricted_areas?id=eq.' + id, { method:'DELETE' });
  loadRestrictedAreasList();
  if (window.analyticsMap) loadHeatmap();
}
async function addRestrictedArea() {
  const postcode = document.getElementById('newRestrictedPostcode').value.trim().toUpperCase();
  const radius = parseFloat(document.getElementById('newRestrictedRadius').value) || null;
  const label = document.getElementById('newRestrictedLabel').value.trim() || null;
  if (!postcode) { alert('Please enter a postcode'); return; }
  await sbFetch('/rest/v1/restricted_areas', { method:'POST', headers:{'Content-Type':'application/json','Prefer':'return=minimal'}, body:JSON.stringify({postcode_prefix:postcode, radius_miles:radius, label}) });
  document.getElementById('newRestrictedPostcode').value='';
  document.getElementById('newRestrictedRadius').value='';
  document.getElementById('newRestrictedLabel').value='';
  loadRestrictedAreasList();
  if (window.analyticsMap) loadHeatmap();
}

// Campaign Config Modal
let currentConfigCampaignId=null;

function openCampaignConfig(){
  if(!currentCampaignId){
    alert('Please select a campaign first');
    return;
  }
  document.getElementById('configCampaignName').value='';
  document.getElementById('configTargetLeaflets').value='';
  document.getElementById('configStartDate').value='';
  document.getElementById('configEndDate').value='';
  document.getElementById('campaignConfigModal').classList.add('active');
  currentConfigCampaignId=currentCampaignId;
  
  sbFetch('/rest/v1/campaigns?id=eq.'+currentCampaignId).then(rows=>{
    if(rows&&rows[0]){
      document.getElementById('configCampaignName').value=rows[0].name||'';
      document.getElementById('configTargetLeaflets').value=rows[0].target_leaflets||'';
      document.getElementById('configStartDate').value=rows[0].start_date||'';
      document.getElementById('configEndDate').value=rows[0].end_date||'';
      document.getElementById('configRateConservative').value=rows[0].rate_conservative||'';
      document.getElementById('configRateTarget').value=rows[0].rate_target||'';
      document.getElementById('configRateOptimistic').value=rows[0].rate_optimistic||'';
      document.getElementById('configDefaultCaseValue').value=rows[0].default_case_value||'';
    }
  });
  loadRestrictedAreasList();
}

function closeCampaignConfig(){
  document.getElementById('campaignConfigModal').classList.remove('active');
  currentConfigCampaignId=null;
}

async function saveCampaignConfig(){
  const campaignName=document.getElementById('configCampaignName').value.trim();
  const targetLeaflets=document.getElementById('configTargetLeaflets').value;
  const startDate=document.getElementById('configStartDate').value;
  const endDate=document.getElementById('configEndDate').value;
  const errorEl=document.getElementById('configError');
  const btn=document.getElementById('configConfirmBtn');
  
  if(!campaignName){
    errorEl.textContent='Please enter a campaign name';
    errorEl.classList.add('show');
    return;
  }
  if(!targetLeaflets){
    errorEl.textContent='Please enter target leaflets';
    errorEl.classList.add('show');
    return;
  }
  
  btn.disabled=true;
  btn.textContent='Saving...';
  errorEl.classList.remove('show');
  
  const rateConservative=parseFloat(document.getElementById('configRateConservative').value)||null;
  const rateTarget=parseFloat(document.getElementById('configRateTarget').value)||null;
  const rateOptimistic=parseFloat(document.getElementById('configRateOptimistic').value)||null;
  const defaultCaseValue=parseFloat(document.getElementById('configDefaultCaseValue').value)||null;

  try{
    await sbFetch('/rest/v1/campaigns?id=eq.'+currentConfigCampaignId,{
      method:'PATCH',
      body:JSON.stringify({
        name:campaignName,
        target_leaflets:parseInt(targetLeaflets),
        start_date:startDate||null,
        end_date:endDate||null,
        rate_conservative:rateConservative,
        rate_target:rateTarget,
        rate_optimistic:rateOptimistic,
        default_case_value:defaultCaseValue
      })
    });
    
    closeCampaignConfig();
    await loadCampaigns();
    if (window.analyticsMap) await loadHeatmap();
    setSyncStatus('ok','Campaign updated!');
  }catch(e){
    errorEl.textContent='Error: '+e.message;
    errorEl.classList.add('show');
  }
  btn.disabled=false;
  btn.textContent='Save';
}

async function loadAll(){
  Logger.info('loadAll() called - starting data load');
  setSyncStatus('saving','Loading\u2026');
  try{
    await loadCampaigns();
    await loadCampaignRates();
    await loadTeamMembers();
    await loadAreaCards();
    renderAreaCards();
    await loadSummaryStats();
    await loadDeliveryJournal();
    await loadEnquiryList();
    setSyncStatus('ok','Live \u00b7 auto-syncing every 30s');
  }catch(e){
    Logger.error('loadAll failed',e);
    setSyncStatus('err','Connection error \u2014 '+e.message);
  }
}

function scheduleSessionSave(id){clearTimeout(saveTimers[id]);saveTimers[id]=setTimeout(()=>saveSession(id),800);}
async function saveSession(id){
  setSyncStatus('saving','Saving\u2026');const row=sessionState[id]||{};
  try{
    await sbFetch('/rest/v1/session_log',{method:'POST',headers:{'Prefer':'resolution=merge-duplicates,return=representation'},
      body:JSON.stringify({id,staff1:row.staff1||null,staff2:row.staff2||null,delivered:row.delivered||null,comment:row.comment||null,went_out:row.went_out!==undefined?row.went_out:null,updated_at:new Date().toISOString()})});
    setSyncStatus('ok','Saved \u00b7 '+new Date().toLocaleTimeString());
  }catch(e){setSyncStatus('err','Save failed \u2014 '+e.message);}
}

async function handleMissed(originalId){
  // Find existing rescheduled for this session
  const exists=sessions.some(s=>s.rescheduled&&s.originalId===originalId);
  if(exists) return;
  const orig=sessions.find(s=>s.id===originalId);
  if(!orig) return;
  // Next Tue/Wed after the last session date
  const allDates=sessions.map(s=>s.dateISO).sort();
  const newDate=nextTueWed(allDates[allDates.length-1]);
  setSyncStatus('saving','Adding rescheduled session\u2026');
  try{
    await sbFetch('/rest/v1/rescheduled_sessions',{method:'POST',headers:{'Prefer':'resolution=merge-duplicates,return=representation'},
      body:JSON.stringify({original_id:originalId,date_iso:newDate,area:orig.area,postcode:orig.postcode,target:orig.target,briefing:orig.briefing})});
    setSyncStatus('ok','Rescheduled session added');
    loadAll();
  }catch(e){setSyncStatus('err','Reschedule failed \u2014 run the DB migration first. Error: '+e.message);}
}

let financeTimer;
function scheduleFinanceSave(){clearTimeout(financeTimer);financeTimer=setTimeout(saveFinance,800);}
async function saveFinance(){
  setSyncStatus('saving','Saving\u2026');
  try{
    await sbFetch('/rest/v1/finance_actuals',{method:'POST',headers:{'Prefer':'resolution=merge-duplicates,return=representation'},
      body:JSON.stringify({id:1,enquiries:parseInt(document.getElementById('fi_enquiries').value)||0,cases_instructed:parseInt(document.getElementById('fi_cases').value)||0,instruction_value:parseFloat(document.getElementById('fi_instrvalue').value)||0,updated_at:new Date().toISOString()})});
    setSyncStatus('ok','Saved \u00b7 '+new Date().toLocaleTimeString());
    let td=0;sessions.forEach(s=>{td+=parseInt(sessionState[s.id]?.delivered)||0;});updateFinance(td,TOTAL-td);
  }catch(e){setSyncStatus('err','Save failed \u2014 '+e.message);}
}

function render(){
  const container=document.getElementById('schedule');
  if(!container) return; // Section removed - legacy
  container.innerHTML='';
  const today=new Date();today.setHours(0,0,0,0);
  let currentWeek='',weekDiv;
  sessions.forEach(s=>{
    if(s.week!==currentWeek){
      currentWeek=s.week;weekDiv=document.createElement('div');
      weekDiv.className='week-block';weekDiv.innerHTML='<div class="week-label">'+s.week+'</div>';
      container.appendChild(weekDiv);
    }
    const row=sessionState[s.id]||{};
    const delivered=parseInt(row.delivered)||0;
    const sessionDate=new Date(s.dateISO+'T12:00:00');
    const isPast=sessionDate<today;
    // went_out defaults to true for past sessions unless explicitly set to false
    const wentOut=row.went_out===false?false:true;
    const missed=isPast&&row.went_out===false&&delivered===0;

    let status,badgeText,badgeClass;
    if(s.rescheduled){status='rescheduled';badgeText='\u21BA Rescheduled';badgeClass='badge-rescheduled';}
    else if(delivered>=s.target){status='complete';badgeText='\u2713 Complete';badgeClass='badge-complete';}
    else if(delivered>0){status='partial';badgeText='\u26A1 Partial';badgeClass='badge-partial';}
    else if(missed){status='missed';badgeText='\u2717 Missed';badgeClass='badge-missed';}
    else{status='future';badgeText='Upcoming';badgeClass='badge-future';}

    const checkboxHtml=!s.rescheduled
      ?'<div class="went-out-row"><input type="checkbox" data-id="'+s.id+'" data-field="went_out"'+(wentOut?' checked':'')+' id="wo_'+s.id+'"><label for="wo_'+s.id+'" style="cursor:pointer;user-select:none;">We went out on this day</label></div>'
      :'';

    const card=document.createElement('div');card.className='session-card '+status;
    card.innerHTML=
      '<div class="session-header">'+
      '<div class="session-date">'+fmtDate(s.dateISO)+'</div>'+
      '<div class="session-area">'+s.area+' <span style="color:#888;font-size:0.8rem">('+s.postcode+')</span></div>'+
      '<div class="session-target">Target: '+s.target.toLocaleString()+'</div>'+
      '<span class="badge '+badgeClass+'">'+badgeText+'</span>'+
      '</div>'+
      checkboxHtml+
      '<div class="briefing">'+s.briefing+'</div>'+
      '<div class="session-fields">'+
      '<div class="field"><label>Staff Member 1</label><select data-id="'+s.id+'" data-field="staff1">'+STAFF.map(n=>'<option value="'+n+'"'+((row.staff1||'')===n?' selected':'')+'>'+n+'</option>').join('')+'</select></div>'+
      '<div class="field"><label>Staff Member 2</label><select data-id="'+s.id+'" data-field="staff2">'+STAFF.map(n=>'<option value="'+n+'"'+((row.staff2||'')===n?' selected':'')+'>'+n+'</option>').join('')+'</select></div>'+
      '<div class="field"><label>Leaflets Delivered</label><input type="number" min="0" placeholder="0" data-id="'+s.id+'" data-field="delivered" value="'+(row.delivered||'')+'"></div>'+
      `<div class="field"><label>Notes / Issues</label><input type="text" placeholder="e.g. skipped Elm Close" data-id="${s.id}" data-field="comment" value="${row.comment||''}" style="width:240px"></div>`+
      '</div>';
    weekDiv.appendChild(card);
  });

  container.querySelectorAll('input[type=checkbox][data-field=went_out]').forEach(el=>{
    el.addEventListener('change',()=>{
      const id=el.dataset.id;
      if(!sessionState[id])sessionState[id]={};
      sessionState[id].went_out=el.checked;
      scheduleSessionSave(id);
      if(!el.checked) handleMissed(id);
      render();updateSummary();
    });
  });
  container.querySelectorAll('select,input[type=number],input[type=text]').forEach(el=>{
    el.addEventListener('change',()=>{
      const id=el.dataset.id;if(!sessionState[id])sessionState[id]={};
      const val=el.type==='number'?(parseInt(el.value)||null):el.value;
      sessionState[id][el.dataset.field]=val;
      scheduleSessionSave(id);updateSummary();if(el.dataset.field==='delivered')render();
    });
  });
}

function fmtCurrency(n){return n.toLocaleString('en-GB',{style:'currency',currency:'GBP',maximumFractionDigits:0});}

function updateSummary(){
  let td=0,cs=0;
  sessions.forEach(s=>{const d=parseInt(sessionState[s.id]?.delivered)||0;td+=d;if(d>0)cs++;});
  const rem=Math.max(0,TOTAL-td),pct=Math.min(100,Math.round(td/TOTAL*100));
  document.getElementById('sumRemaining').textContent=rem.toLocaleString();
  document.getElementById('sumSessions').textContent=cs;
  document.getElementById('progressFill').style.width=pct+'%';
  document.getElementById('progressPct').textContent=pct+'%';

  const expComp=calcCompletion(sessions,sessionState);
  document.getElementById('sumProjected').textContent=expComp;

  const rfMsg=document.getElementById('reforecastMsg');
  if(rfMsg){if(cs===0){
    rfMsg.innerHTML='No sessions logged yet. Tick \u201CWe went out\u201D and enter leaflets delivered after each session.<br><br>&#128197; <strong>Estimated completion: '+expComp+'</strong>';
  } else {
    const avg=Math.round(td/cs),diff=avg-DAILY_TARGET;
    const dl=diff>=0?'<span class="good">+'+diff+' ahead of target</span>':'<span class="warn">'+diff+' behind target</span>';
    const sl=sessions.filter(s=>!(parseInt(sessionState[s.id]?.delivered)||0)).length;
    const proj=td+avg*sl,sf=TOTAL-proj;
    const pm=sf<=0?'<span class="good">On course to deliver all 20,000 leaflets!</span>':'<span class="warn">Projected shortfall of ~'+Math.round(sf).toLocaleString()+' at current pace.</span>';
    rfMsg.innerHTML=cs+' session(s) done &nbsp;&middot;&nbsp; Avg: <strong>'+avg.toLocaleString()+'</strong>/session &nbsp;&middot;&nbsp; '+dl+'<br><br>'+pm+'<br><br>&#128197; <strong>Expected completion: '+expComp+'</strong>';
  }}
  updateFinance(td,rem);
}

function updateFinance(td,rem){
  const enq=parseInt(document.getElementById('fi_enquiries').value)||0;
  const cas=parseInt(document.getElementById('fi_cases').value)||0;
  const inv=parseFloat(document.getElementById('fi_instrvalue').value)||0;
  // Use campaign overrides if set, else hardcoded fallbacks (CFG-02/04)
  const effectiveDefaultCV=campaignRates.defaultCaseValue??DEFAULT_CV;
  const avgCV=cas>0&&inv>0?inv/cas:effectiveDefaultCV,convR=enq>0&&cas>0?cas/enq:1;
  const leafR=td>0&&enq>0?enq/td:null,rev100=td>0&&inv>0?(inv/td)*100:null;
  const revPEnq=enq>0&&inv>0?inv/enq:null,lpc=td>0&&cas>0?Math.round(td/cas):null;
  document.getElementById('dm_avgcase').textContent=inv>0&&cas>0?fmtCurrency(avgCV):'\u2014';
  document.getElementById('dm_convrate').textContent=enq>0&&cas>0?Math.round(convR*100)+'%':'\u2014';
  document.getElementById('dm_per100').textContent=rev100!==null?fmtCurrency(rev100):'\u2014';
  document.getElementById('dm_perenquiry').textContent=revPEnq!==null?fmtCurrency(revPEnq):'\u2014';
  document.getElementById('dm_percase').textContent=lpc!==null?lpc.toLocaleString():'\u2014';
  if(enq>0){
    document.getElementById('fa_rate').textContent=leafR!==null?(leafR*100).toFixed(2)+'%':'\u2014';
    document.getElementById('fa_enquiries').textContent=enq+' enquiries';
    document.getElementById('fa_cases').textContent=cas>0?cas+' cases':'\u2014';
    document.getElementById('fa_revenue').textContent=inv>0?fmtCurrency(inv):'\u2014';
  }else{
    ['fa_rate','fa_cases','fa_revenue'].forEach(id=>document.getElementById(id).textContent='\u2014');
    document.getElementById('fa_enquiries').textContent='Enter data above';
  }
  const hasA=leafR!==null&&cas>0&&inv>0;
  document.getElementById('f_extrap_row').style.display=hasA?'':'none';
  if(hasA){
    const ef=Math.round(TOTAL*leafR),cf=Math.round(ef*convR);
    document.getElementById('f_ext_rate').textContent=(leafR*100).toFixed(2)+'%';
    document.getElementById('f_ext_sofar').textContent=enq;
    document.getElementById('f_ext_todo').textContent=Math.round(rem*leafR);
    document.getElementById('f_ext_total').textContent=ef;
    document.getElementById('f_ext_rev').textContent=fmtCurrency(cf*avgCV);
  }
  // Use campaign rate overrides if set, else hardcoded fallbacks (CFG-02)
  [[campaignRates.conservative??0.0025,'f1'],[campaignRates.target??0.005,'f2'],[campaignRates.optimistic??0.01,'f3']].forEach(([sr,p])=>{
    const es=Math.round(td*sr),et=Math.round(rem*sr),te=es+et;
    const cr=cas>0&&enq>0?convR:1,cv=cas>0&&inv>0?avgCV:effectiveDefaultCV;
    document.getElementById(p+'_sofar').textContent=td>0?es:'\u2014';
    document.getElementById(p+'_todo').textContent=et;
    document.getElementById(p+'_total').textContent=te;
    document.getElementById(p+'_rev').textContent=fmtCurrency(Math.round(te*cr)*cv);
  });
}

document.addEventListener('DOMContentLoaded',()=>{
  ['fi_enquiries','fi_cases','fi_instrvalue'].forEach(id=>{
    const el=document.getElementById(id);if(el)el.addEventListener('input',scheduleFinanceSave);
  });
  showView('cards');
  loadAll();setInterval(loadAll,30000);
});
</script>
</body>
</html>
